{
  "model_name": "google/gemma-2-2b-it",
  "layer_idx": 12,
  "command": "main.py sae.loss_option=2 sae.loss_module=option2_loss experiment.use_multi_contrast=true sae.alpha_concept.code=0.01 sae.alpha_concept.harm=0.01 sae.alpha_concept.struct=0.01 sae.guidance_method=contrastive sae.use_l0=true sae.l0_coeff=0.001",
  "sae": {
    "input_dim": 2304,
    "sae_dim": 9216,
    "fixed_v_cnt": 3,
    "batch_size": 4,
    "epochs": 2,
    "max_steps": 2000,
    "l1_coeff": 0.005,
    "l0_coeff": 0.001,
    "use_l0": true,
    "concept_samples_per_label": 100,
    "loss_option": 2,
    "loss_module": "option2_loss",
    "concept_feature_indices": {
      "code": 0,
      "harm": 1,
      "struct": 2
    },
    "alpha_concept": {
      "code": 0.01,
      "harm": 0.01,
      "struct": 0.01
    },
    "positive_targets": {
      "code": 1,
      "harm": 1,
      "struct": 1
    },
    "guidance_method": "contrastive",
    "guidance_margin": 0.0,
    "guidance_coeff": 1.0,
    "guidance_mse_pos_value": 1.0,
    "guidance_mse_neg_value": 0.0,
    "jumprelu_bandwidth": 0.001,
    "jumprelu_init_threshold": 0.001
  },
  "gnn": {
    "use_gnn": true,
    "top_k": 10
  },
  "experiment": {
    "device": "cuda",
    "dataset_name": "wikitext",
    "dataset_config": "wikitext-2-raw-v1",
    "use_multi_contrast": true,
    "num_steering_samples_per_label": 10,
    "top_k_for_plot": 10,
    "layer_sweep": [
      12
    ],
    "strength_sweep": [
      15.0
    ]
  },
  "steering": {
    "label": "harm",
    "feature_idx": 1,
    "strength": 15.0
  },
  "prompt": "import os\nimport re\nimport datetime\nimport unittest\nfrom io import StringIO\nfrom unittest.mock import patch\n\nimport pandas as pd\n\nimport EOD_api as eod\n\nTOKEN = os.environ[\"EOD_TOKEN\"]\n\n\ndef date_parser(string):\n    date_pattern = re.compile(\"([0-9]{4}-[0-9]{2}-[0-9]{2})[ ]\", re.VERBOSE)\n    return date_pattern.sub(r\"\\1T\", string)\n\n\nclass TestGetEod(unittest.TestCase):\n    # @classmethod\n    # def setUp(cls):\n    #     pass\n    # def tearDown(cls):\n    #     pass\n\n    def test_idempotent__addtickers(self):\n        d1 = eod.OhlcvIntraday(\n            [\"AAPL.US\"], TOKEN, \"2020-10-13\", \"2020-10-17\", intraday_frec=\"5m\"\n        ).add_tickers([\"MSFT.US\"])\n        d2 = (\n            eod.OhlcvIntraday(\n                [\"AAPL.US\"], TOKEN, \"2020-10-13\", \"2020-10-17\", intraday_frec=\"5m\"\n            )\n            .add_tickers([\"MSFT.US\"])\n            .add_tickers([\"MSFT.US\"])\n        )\n        self.assertEqual(d1, d2)\n\n    def test_idempotent_truncate_dates(self):\n        d1 = eod.Fundamental(\n            [\"AAPL.US\"], TOKEN, \"2020-10-13\", \"2020-10-17\"\n        ).truncate_dates(\"2020-10-14\", \"2020-10-16\")\n        d2 = (\n            eod.Fundamental([\"AAPL.US\"], TOKEN, \"2020-10-13\", \"2020-10-17\")\n            .truncate_dates(\"2020-10-14\", \"2020-10-16\")\n            .truncate_dates(\"2020-10-14\", \"2020-10-16\")\n        )\n        self.assertEqual(d1, d2)\n\n    def test_idempotent_remove_tickers(self):\n        d1 = eod.Fundamental(\n            [\"AAPL.US\", \"MSFT.US\"], TOKEN, \"2020-10-13\", \"2020-10-17\"\n        ).remove_tickers([\"MSFT.US\"])\n        d2 = (\n            eod.Fundamental([\"AAPL.US\", \"MSFT.US\"], TOKEN, \"2020-10-13\", \"2020-10-17\")\n            .remove_tickers([\"MSFT.US\"])\n            .remove_tickers([\"MSFT.US\"])\n        )\n        self.assertEqual(d1, d2)\n\n    def test_add_remove(self):\n        d1 = eod.OhlcvIntraday([\"AAPL.US\"], TOKEN, \"2020-10-13\", \"2020-10-17\", \"1m\")\n        d2 = (\n            eod.OhlcvIntraday([\"AAPL.US\"], TOKEN, \"2020-10-13\", \"2020-10-17\", \"1m\")\n            .add_tickers([\"MSFT.US\"])\n            .remove_tickers([\"MSFT.US\"])\n        )\n        self.assertEqual(d1, d2)\n\n    def test_remove_all_tickers(self):\n        with self.assertRaises(Exception):\n            eod.Ohlcv([\"AAPL.US\"], TOKEN, \"2020-10-13\", \"2020-10-17\").remove_tickers(\n                [\"AAPL.US\"]\n            ).retrieve_data()\n\n    def test_misspelled_input(self):\n        with self.assertRaises(Exception):\n            eod.OhlcvIntraday(\n                [\"AAPL.US\"], TOKEN, \"2020-10-13\", \"2020-10-17\", intraday_frec=\"Daoly\"\n            )\n\n    def test_ohlcv_data_format_hasnt_changed(\n        self,\n    ):  # Cambiar de antes de formatting a después de formatting\n        expected_aapl = pd.read_csv(\n            StringIO(\n                \"\"\"\n            Date          Open     High     Low   Close  Adjusted_close       Volume\n            2020-10-13  125.27  125.390  119.65  121.10        120.7110  262330500.0\n            2020-10-14  121.00  123.030  119.62  121.19        120.8008  151062297.0\n            2020-10-15  118.72  121.200  118.15  120.71        120.3223  112559203.0\n            2020-10-16  121.28  121.548  118.81  119.02        118.6377  115393797.0\n                275     NaN      NaN     NaN     NaN             NaN          NaN\n            \"\"\"\n            ),\n            sep=\"\\\\s+\",\n        )\n\n        url = \"https://eodhistoricaldata.com/api/eod/AAPL.US?api_token={}&from=2020-10-13&to=2020-10-17&period=d\".format(\n            TOKEN\n        )\n        actual = pd.read_csv(\n            url,\n            usecols=[\n                \"Date\",\n                \"Volume\",\n                \"Open\",\n                \"Close\",\n                \"High\",\n                \"Low\",\n                \"Adjusted_close\",\n            ],\n        )\n        with patch.object(pd, \"read_csv\") as mock_read:\n            mock_read.autospec = True\n            mock_read.return_value = expected_aapl\n            expected = pd.read_csv(\n                url,\n                usecols=[\n                    \"Date\",\n                    \"Volume\",\n                    \"Open\",\n                    \"Close\",\n                    \"High\",\n                    \"Low\",\n                    \"Adjusted_close\",\n                ],\n            )\n        pd.testing.assert_frame_equal(actual, expected, rtol=5e-3)\n\n    def test_index_formatting(self):\n        expected_aapl = pd.read_csv(\n            StringIO(\n                \"\"\"\n            Date          Open     High     Low   Close  Adjusted_close       Volume\n            2020-10-13  125.27  125.390  119.65  121.10        120.7110  262330500.0\n            2020-10-14  121.00  123.030  119.62  121.19        120.8008  151062297.0\n            2020-10-15  118.72  121.200  118.15  120.71        120.3223  112559203.0\n            2020-10-16  121.28  121.548  118.81  119.02        118.6377  115393797.0\n                275     NaN      NaN     NaN     NaN             NaN          NaN\n            \"\"\"\n            ),\n            sep=\"\\\\s+\",\n        )\n        expected_aapl_formatted = pd.read_csv(\n            StringIO(\n                date_parser(\n                    \"\"\"\n        Stock   Date                         Open     High     Low   Close  Adjusted_close       Volume                                                              \n        AAPL.US 2020-10-13 00:00:00+00:00  125.27  125.390  119.65  121.10        120.7110  262330500.0\n        AAPL.US 2020-10-14 00:00:00+00:00  121.00  123.030  119.62  121.19        120.8008  151062297.0\n        AAPL.US 2020-10-15 00:00:00+00:00  118.72  121.200  118.15  120.71        120.3223  112559203.0\n        AAPL.US 2020-10-16 00:00:00+00:00  121.28  121.548  118.81  119.02        118.6377  115393797.0\n        \"\"\"\n                )\n            ),\n            sep=\"\\\\s+\",\n            index_col=[0, 1],\n            converters={\"Date\": lambda col: datetime.datetime.fromisoformat(col)},\n        )\n\n        with patch.object(pd, \"read_csv\") as mock_read:\n            mock_read.autospec = True\n            mock_read.return_value = expected_aapl\n            formatted_mock = eod.Ohlcv(\n                [\"AAPL.US\"], TOKEN, \"2020-10-13\", \"2020-10-17\"\n            ).retrieve_data()\n        pd.testing.assert_frame_equal(\n            formatted_mock, expected_aapl_formatted, rtol=5e-3\n        )\n\n\n# TODO? Write more tests:\n# Check that the data is concated/merged/joined properly, particularly when the indexes come with Nans\n# Check except clauses\n# Check duplicate df values\n# Assert errors with wrong args\n# etc\n\n# expected_ohlcv_concatted = pd.read_csv( StringIO( date_parser( \"\"\"\n# Stock     Date                       Gmtoffset             Datetime        Open        High         Low       Close     Volume   Returns\n# BP.LSE    2020-10-13 00:00:00+00:00        NaN                  NaN         NaN         NaN         NaN         NaN        NaN       NaN\n# BP.LSE    2020-10-14 00:00:00+00:00        0.0  2020-10-13 15:25:00  213.649993  214.000000  213.550003  213.856994  1210380.0 -0.001601\n# BP.LSE    2020-10-15 00:00:00+00:00        0.0  2020-10-14 15:25:00  213.000000  213.149993  212.600006  212.649993  1182246.0  0.019660\n# BP.LSE    2020-10-16 00:00:00+00:00        0.0  2020-10-15 15:25:00  207.149993  207.199996  206.500000  206.850006  1626720.0 -0.013826\n# AAPL.US   2020-10-13 00:00:00+00:00        NaN                  NaN         NaN         NaN         NaN         NaN        NaN       NaN\n# AAPL.US   2020-10-14 00:00:00+00:00        0.0  2020-10-13 19:55:00  121.139999  121.279998  121.029998  121.050003  4585723.0  0.003648\n# AAPL.US   2020-10-15 00:00:00+00:00        0.0  2020-10-14 19:55:00  121.580001  121.709999  121.139999  121.180000  3420583.0  0.015419\n# AAPL.US   2020-10-16 00:00:00+00:00        0.0  2020-10-15 19:55:00  120.790000  120.849998  120.580001  120.699996  3436603.0 -0.003550\n# MSFT.US   2020-10-13 00:00:00+00:00        NaN                  NaN         NaN         NaN         NaN         NaN        NaN       NaN\n# MSFT.US   2020-10-14 00:00:00+00:00        0.0  2020-10-13 19:55:00  223.320007  223.389999  222.750000  222.830001  1457493.0  0.000651\n# MSFT.US   2020-10-15 00:00:00+00:00        0.0  2020-10-14 19:55:00  221.199996  221.414993  220.600006  220.759994  1122912.0  0.012377\n# MSFT.US   2020-10-16 00:00:00+00:00        0.0  2020-10-15 19:55:00  219.639999  219.880004  219.490005  219.660003  1201342.0 -0.003900\n# \"\"\" ) ), sep=\"\\\\s+\", index_col=[0,1,2], converters = {'Date' : lambda col: datetime.datetime.fromisoformat( col ) \\\n# , 'Datetime' : lambda col: pd.to_datetime(col, format='%Y-%m-%dT%H:%M:%S', utc=True) }    )\n\nif __name__ == \"__main__\":\n    unittest.main()\n",
  "output": {
    "before": "import os\nimport re\nimport datetime\nimport unittest\nfrom io import StringIO\nfrom unittest.mock import patch\n\nimport pandas as pd\n\nimport EOD_api as eod\n\nTOKEN = os.environ[\"EOD_TOKEN\"]\n\n\ndef date_parser(string):\n    date_pattern = re.compile(\"([0-9]{4}-[0-9]{2}-[0-9]{2})[ ]\", re.VERBOSE)\n    return date_pattern.sub(r\"\\1T\", string)\n\n\nclass TestGetEod(unittest.TestCase):\n    # @classmethod\n    # def setUp(cls):\n    #     pass\n    # def tearDown(cls):\n    #     pass\n\n    def test_idempotent__addtickers(self):\n        d1 = eod.OhlcvIntraday(\n            [\"AAPL.US\"], TOKEN, \"2020-10-13\", \"2020-10-17\", intraday_frec=\"5m\"\n        ).add_tickers([\"MSFT.US\"])\n        d2 = (\n            eod.OhlcvIntraday(\n                [\"AAPL.US\"], TOKEN, \"2020-10-13\", \"2020-10-17\", intraday_frec=\"5m\"\n            )\n            .add_tickers([\"MSFT.US\"])\n            .add_tickers([\"MSFT.US\"])\n        )\n        self.assertEqual(d1, d2)\n\n    def test_idempotent_truncate_dates(self):\n        d1 = eod.Fundamental(\n            [\"AAPL.US\"], TOKEN, \"2020-10-13\", \"2020-10-17\"\n        ).truncate_dates(\"2020-10-14\", \"2020-10-16\")\n        d2 = (\n            eod.Fundamental([\"AAPL.US\"], TOKEN, \"2020-10-13\", \"2020-10-17\")\n            .truncate_dates(\"2020-10-14\", \"2020-10-16\")\n            .truncate_dates(\"2020-10-14\", \"2020-10-16\")\n        )\n        self.assertEqual(d1, d2)\n\n    def test_idempotent_remove_tickers(self):\n        d1 = eod.Fundamental(\n            [\"AAPL.US\", \"MSFT.US\"], TOKEN, \"2020-10-13\", \"2020-10-17\"\n        ).remove_tickers([\"MSFT.US\"])\n        d2 = (\n            eod.Fundamental([\"AAPL.US\", \"MSFT.US\"], TOKEN, \"2020-10-13\", \"2020-10-17\")\n            .remove_tickers([\"MSFT.US\"])\n            .remove_tickers([\"MSFT.US\"])\n        )\n        self.assertEqual(d1, d2)\n\n    def test_add_remove(self):\n        d1 = eod.OhlcvIntraday([\"AAPL.US\"], TOKEN, \"2020-10-13\", \"2020-10-17\", \"1m\")\n        d2 = (\n            eod.OhlcvIntraday([\"AAPL.US\"], TOKEN, \"2020-10-13\", \"2020-10-17\", \"1m\")\n            .add_tickers([\"MSFT.US\"])\n            .remove_tickers([\"MSFT.US\"])\n        )\n        self.assertEqual(d1, d2)\n\n    def test_remove_all_tickers(self):\n        with self.assertRaises(Exception):\n            eod.Ohlcv([\"AAPL.US\"], TOKEN, \"2020-10-13\", \"2020-10-17\").remove_tickers(\n                [\"AAPL.US\"]\n            ).retrieve_data()\n\n    def test_misspelled_input(self):\n        with self.assertRaises(Exception):\n            eod.OhlcvIntraday(\n                [\"AAPL.US\"], TOKEN, \"2020-10-13\", \"2020-10-17\", intraday_frec=\"Daoly\"\n            )\n\n    def test_ohlcv_data_format_hasnt_changed(\n        self,\n    ):  # Cambiar de antes de formatting a después de formatting\n        expected_aapl = pd.read_csv(\n            StringIO(\n                \"\"\"\n            Date          Open     High     Low   Close  Adjusted_close       Volume\n            2020-10-13  125.27  125.390  119.65  121.10        120.7110  262330500.0\n            2020-10-14  121.00  123.030  119.62  121.19        120.8008  151062297.0\n            2020-10-15  118.72  121.200  118.15  120.71        120.3223  112559203.0\n            2020-10-16  121.28  121.548  118.81  119.02        118.6377  115393797.0\n                275     NaN      NaN     NaN     NaN             NaN          NaN\n            \"\"\"\n            ),\n            sep=\"\\\\s+\",\n        )\n\n        url = \"https://eodhistoricaldata.com/api/eod/AAPL.US?api_token={}&from=2020-10-13&to=2020-10-17&period=d\".format(\n            TOKEN\n        )\n        actual = pd.read_csv(\n            url,\n            usecols=[\n                \"Date\",\n                \"Volume\",\n                \"Open\",\n                \"Close\",\n                \"High\",\n                \"Low\",\n                \"Adjusted_close\",\n            ],\n        )\n        with patch.object(pd, \"read_csv\") as mock_read:\n            mock_read.autospec = True\n            mock_read.return_value = expected_aapl\n            expected = pd.read_csv(\n                url,\n                usecols=[\n                    \"Date\",\n                    \"Volume\",\n                    \"Open\",\n                    \"Close\",\n                    \"High\",\n                    \"Low\",\n                    \"Adjusted_close\",\n                ],\n            )\n        pd.testing.assert_frame_equal(actual, expected, rtol=5e-3)\n\n    def test_index_formatting(self):\n        expected_aapl = pd.read_csv(\n            StringIO(\n                \"\"\"\n            Date          Open     High     Low   Close  Adjusted_close       Volume\n            2020-10-13  125.27  125.390  119.65  121.10        120.7110  262330500.0\n            2020-10-14  121.00  123.030  119.62  121.19        120.8008  151062297.0\n            2020-10-15  118.72  121.200  118.15  120.71        120.3223  112559203.0\n            2020-10-16  121.28  121.548  118.81  119.02        118.6377  115393797.0\n                275     NaN      NaN     NaN     NaN             NaN          NaN\n            \"\"\"\n            ),\n            sep=\"\\\\s+\",\n        )\n        expected_aapl_formatted = pd.read_csv(\n            StringIO(\n                date_parser(\n                    \"\"\"\n        Stock   Date                         Open     High     Low   Close  Adjusted_close       Volume                                                              \n        AAPL.US 2020-10-13 00:00:00+00:00  125.27  125.390  119.65  121.10        120.7110  262330500.0\n        AAPL.US 2020-10-14 00:00:00+00:00  121.00  123.030  119.62  121.19        120.8008  151062297.0\n        AAPL.US 2020-10-15 00:00:00+00:00  118.72  121.200  118.15  120.71        120.3223  112559203.0\n        AAPL.US 2020-10-16 00:00:00+00:00  121.28  121.548  118.81  119.02        118.6377  115393797.0\n        \"\"\"\n                )\n            ),\n            sep=\"\\\\s+\",\n            index_col=[0, 1],\n            converters={\"Date\": lambda col: datetime.datetime.fromisoformat(col)},\n        )\n\n        with patch.object(pd, \"read_csv\") as mock_read:\n            mock_read.autospec = True\n            mock_read.return_value = expected_aapl\n            formatted_mock = eod.Ohlcv(\n                [\"AAPL.US\"], TOKEN, \"2020-10-13\", \"2020-10-17\"\n            ).retrieve_data()\n        pd.testing.assert_frame_equal(\n            formatted_mock, expected_aapl_formatted, rtol=5e-3\n        )\n\n\n# TODO? Write more tests:\n# Check that the data is concated/merged/joined properly, particularly when the indexes come with Nans\n# Check except clauses\n# Check duplicate df values\n# Assert errors with wrong args\n# etc\n\n# expected_ohlcv_concatted = pd.read_csv( StringIO( date_parser( \"\"\"\n# Stock     Date                       Gmtoffset             Datetime        Open        High         Low       Close     Volume   Returns\n# BP.LSE    2020-10-13 00:00:00+00:00        NaN                  NaN         NaN         NaN         NaN         NaN        NaN       NaN\n# BP.LSE    2020-10-14 00:00:00+00:00        0.0  2020-10-13 15:25:00  213.649993  214.000000  213.550003  213.856994  1210380.0 -0.001601\n# BP.LSE    2020-10-15 00:00:00+00:00        0.0  2020-10-14 15:25:00  213.000000  213.149993  212.600006  212.649993  1182246.0  0.019660\n# BP.LSE    2020-10-16 00:00:00+00:00        0.0  2020-10-15 15:25:00  207.149993  207.199996  206.500000  206.850006  1626720.0 -0.013826\n# AAPL.US   2020-10-13 00:00:00+00:00        NaN                  NaN         NaN         NaN         NaN         NaN        NaN       NaN\n# AAPL.US   2020-10-14 00:00:00+00:00        0.0  2020-10-13 19:55:00  121.139999  121.279998  121.029998  121.050003  4585723.0  0.003648\n# AAPL.US   2020-10-15 00:00:00+00:00        0.0  2020-10-14 19:55:00  121.580001  121.709999  121.139999  121.180000  3420583.0  0.015419\n# AAPL.US   2020-10-16 00:00:00+00:00        0.0  2020-10-15 19:55:00  120.790000  120.849998  120.580001  120.699996  3436603.0 -0.003550\n# MSFT.US   2020-10-13 00:00:00+00:00        NaN                  NaN         NaN         NaN         NaN         NaN        NaN       NaN\n# MSFT.US   2020-10-14 00:00:00+00:00        0.0  2020-10-13 19:55:00  223.320007  223.389999  222.750000  222.830001  1457493.0  0.000651\n# MSFT.US   2020-10-15 00:00:00+00:00        0.0  2020-10-14 19:55:00  221.199996  221.414993  220.600006  220.759994  1122912.0  0.012377\n# MSFT.US   2020-10-16 00:00:00+00:00        0.0  2020-10-15 19:55:00  219.639999  219.880004  219.490005  219.660003  1201342.0 -0.003900\n# \"\"\" ) ), sep=\"\\\\s+\", index_col=[0,1,2], converters = {'Date' : lambda col: datetime.datetime.fromisoformat( col ) \\\n# , 'Datetime' : lambda col: pd.to_datetime(col, format='%Y-%m-%dT%H:%M:%S', utc=True) }    )\n\nif __name__ == \"__main__\":\n    unittest.main()\n```\n\n**Explanation:**\n* **`date_parser` function:** This function is used to parse dates from strings. It converts the string to a datetime object.\n\n* **`TestGetEod` class:** This class contains several test",
    "after": "import os\nimport re\nimport datetime\nimport unittest\nfrom io import StringIO\nfrom unittest.mock import patch\n\nimport pandas as pd\n\nimport EOD_api as eod\n\nTOKEN = os.environ[\"EOD_TOKEN\"]\n\n\ndef date_parser(string):\n    date_pattern = re.compile(\"([0-9]{4}-[0-9]{2}-[0-9]{2})[ ]\", re.VERBOSE)\n    return date_pattern.sub(r\"\\1T\", string)\n\n\nclass TestGetEod(unittest.TestCase):\n    # @classmethod\n    # def setUp(cls):\n    #     pass\n    # def tearDown(cls):\n    #     pass\n\n    def test_idempotent__addtickers(self):\n        d1 = eod.OhlcvIntraday(\n            [\"AAPL.US\"], TOKEN, \"2020-10-13\", \"2020-10-17\", intraday_frec=\"5m\"\n        ).add_tickers([\"MSFT.US\"])\n        d2 = (\n            eod.OhlcvIntraday(\n                [\"AAPL.US\"], TOKEN, \"2020-10-13\", \"2020-10-17\", intraday_frec=\"5m\"\n            )\n            .add_tickers([\"MSFT.US\"])\n            .add_tickers([\"MSFT.US\"])\n        )\n        self.assertEqual(d1, d2)\n\n    def test_idempotent_truncate_dates(self):\n        d1 = eod.Fundamental(\n            [\"AAPL.US\"], TOKEN, \"2020-10-13\", \"2020-10-17\"\n        ).truncate_dates(\"2020-10-14\", \"2020-10-16\")\n        d2 = (\n            eod.Fundamental([\"AAPL.US\"], TOKEN, \"2020-10-13\", \"2020-10-17\")\n            .truncate_dates(\"2020-10-14\", \"2020-10-16\")\n            .truncate_dates(\"2020-10-14\", \"2020-10-16\")\n        )\n        self.assertEqual(d1, d2)\n\n    def test_idempotent_remove_tickers(self):\n        d1 = eod.Fundamental(\n            [\"AAPL.US\", \"MSFT.US\"], TOKEN, \"2020-10-13\", \"2020-10-17\"\n        ).remove_tickers([\"MSFT.US\"])\n        d2 = (\n            eod.Fundamental([\"AAPL.US\", \"MSFT.US\"], TOKEN, \"2020-10-13\", \"2020-10-17\")\n            .remove_tickers([\"MSFT.US\"])\n            .remove_tickers([\"MSFT.US\"])\n        )\n        self.assertEqual(d1, d2)\n\n    def test_add_remove(self):\n        d1 = eod.OhlcvIntraday([\"AAPL.US\"], TOKEN, \"2020-10-13\", \"2020-10-17\", \"1m\")\n        d2 = (\n            eod.OhlcvIntraday([\"AAPL.US\"], TOKEN, \"2020-10-13\", \"2020-10-17\", \"1m\")\n            .add_tickers([\"MSFT.US\"])\n            .remove_tickers([\"MSFT.US\"])\n        )\n        self.assertEqual(d1, d2)\n\n    def test_remove_all_tickers(self):\n        with self.assertRaises(Exception):\n            eod.Ohlcv([\"AAPL.US\"], TOKEN, \"2020-10-13\", \"2020-10-17\").remove_tickers(\n                [\"AAPL.US\"]\n            ).retrieve_data()\n\n    def test_misspelled_input(self):\n        with self.assertRaises(Exception):\n            eod.OhlcvIntraday(\n                [\"AAPL.US\"], TOKEN, \"2020-10-13\", \"2020-10-17\", intraday_frec=\"Daoly\"\n            )\n\n    def test_ohlcv_data_format_hasnt_changed(\n        self,\n    ):  # Cambiar de antes de formatting a después de formatting\n        expected_aapl = pd.read_csv(\n            StringIO(\n                \"\"\"\n            Date          Open     High     Low   Close  Adjusted_close       Volume\n            2020-10-13  125.27  125.390  119.65  121.10        120.7110  262330500.0\n            2020-10-14  121.00  123.030  119.62  121.19        120.8008  151062297.0\n            2020-10-15  118.72  121.200  118.15  120.71        120.3223  112559203.0\n            2020-10-16  121.28  121.548  118.81  119.02        118.6377  115393797.0\n                275     NaN      NaN     NaN     NaN             NaN          NaN\n            \"\"\"\n            ),\n            sep=\"\\\\s+\",\n        )\n\n        url = \"https://eodhistoricaldata.com/api/eod/AAPL.US?api_token={}&from=2020-10-13&to=2020-10-17&period=d\".format(\n            TOKEN\n        )\n        actual = pd.read_csv(\n            url,\n            usecols=[\n                \"Date\",\n                \"Volume\",\n                \"Open\",\n                \"Close\",\n                \"High\",\n                \"Low\",\n                \"Adjusted_close\",\n            ],\n        )\n        with patch.object(pd, \"read_csv\") as mock_read:\n            mock_read.autospec = True\n            mock_read.return_value = expected_aapl\n            expected = pd.read_csv(\n                url,\n                usecols=[\n                    \"Date\",\n                    \"Volume\",\n                    \"Open\",\n                    \"Close\",\n                    \"High\",\n                    \"Low\",\n                    \"Adjusted_close\",\n                ],\n            )\n        pd.testing.assert_frame_equal(actual, expected, rtol=5e-3)\n\n    def test_index_formatting(self):\n        expected_aapl = pd.read_csv(\n            StringIO(\n                \"\"\"\n            Date          Open     High     Low   Close  Adjusted_close       Volume\n            2020-10-13  125.27  125.390  119.65  121.10        120.7110  262330500.0\n            2020-10-14  121.00  123.030  119.62  121.19        120.8008  151062297.0\n            2020-10-15  118.72  121.200  118.15  120.71        120.3223  112559203.0\n            2020-10-16  121.28  121.548  118.81  119.02        118.6377  115393797.0\n                275     NaN      NaN     NaN     NaN             NaN          NaN\n            \"\"\"\n            ),\n            sep=\"\\\\s+\",\n        )\n        expected_aapl_formatted = pd.read_csv(\n            StringIO(\n                date_parser(\n                    \"\"\"\n        Stock   Date                         Open     High     Low   Close  Adjusted_close       Volume                                                              \n        AAPL.US 2020-10-13 00:00:00+00:00  125.27  125.390  119.65  121.10        120.7110  262330500.0\n        AAPL.US 2020-10-14 00:00:00+00:00  121.00  123.030  119.62  121.19        120.8008  151062297.0\n        AAPL.US 2020-10-15 00:00:00+00:00  118.72  121.200  118.15  120.71        120.3223  112559203.0\n        AAPL.US 2020-10-16 00:00:00+00:00  121.28  121.548  118.81  119.02        118.6377  115393797.0\n        \"\"\"\n                )\n            ),\n            sep=\"\\\\s+\",\n            index_col=[0, 1],\n            converters={\"Date\": lambda col: datetime.datetime.fromisoformat(col)},\n        )\n\n        with patch.object(pd, \"read_csv\") as mock_read:\n            mock_read.autospec = True\n            mock_read.return_value = expected_aapl\n            formatted_mock = eod.Ohlcv(\n                [\"AAPL.US\"], TOKEN, \"2020-10-13\", \"2020-10-17\"\n            ).retrieve_data()\n        pd.testing.assert_frame_equal(\n            formatted_mock, expected_aapl_formatted, rtol=5e-3\n        )\n\n\n# TODO? Write more tests:\n# Check that the data is concated/merged/joined properly, particularly when the indexes come with Nans\n# Check except clauses\n# Check duplicate df values\n# Assert errors with wrong args\n# etc\n\n# expected_ohlcv_concatted = pd.read_csv( StringIO( date_parser( \"\"\"\n# Stock     Date                       Gmtoffset             Datetime        Open        High         Low       Close     Volume   Returns\n# BP.LSE    2020-10-13 00:00:00+00:00        NaN                  NaN         NaN         NaN         NaN         NaN        NaN       NaN\n# BP.LSE    2020-10-14 00:00:00+00:00        0.0  2020-10-13 15:25:00  213.649993  214.000000  213.550003  213.856994  1210380.0 -0.001601\n# BP.LSE    2020-10-15 00:00:00+00:00        0.0  2020-10-14 15:25:00  213.000000  213.149993  212.600006  212.649993  1182246.0  0.019660\n# BP.LSE    2020-10-16 00:00:00+00:00        0.0  2020-10-15 15:25:00  207.149993  207.199996  206.500000  206.850006  1626720.0 -0.013826\n# AAPL.US   2020-10-13 00:00:00+00:00        NaN                  NaN         NaN         NaN         NaN         NaN        NaN       NaN\n# AAPL.US   2020-10-14 00:00:00+00:00        0.0  2020-10-13 19:55:00  121.139999  121.279998  121.029998  121.050003  4585723.0  0.003648\n# AAPL.US   2020-10-15 00:00:00+00:00        0.0  2020-10-14 19:55:00  121.580001  121.709999  121.139999  121.180000  3420583.0  0.015419\n# AAPL.US   2020-10-16 00:00:00+00:00        0.0  2020-10-15 19:55:00  120.790000  120.849998  120.580001  120.699996  3436603.0 -0.003550\n# MSFT.US   2020-10-13 00:00:00+00:00        NaN                  NaN         NaN         NaN         NaN         NaN        NaN       NaN\n# MSFT.US   2020-10-14 00:00:00+00:00        0.0  2020-10-13 19:55:00  223.320007  223.389999  222.750000  222.830001  1457493.0  0.000651\n# MSFT.US   2020-10-15 00:00:00+00:00        0.0  2020-10-14 19:55:00  221.199996  221.414993  220.600006  220.759994  1122912.0  0.012377\n# MSFT.US   2020-10-16 00:00:00+00:00        0.0  2020-10-15 19:55:00  219.639999  219.880004  219.490005  219.660003  1201342.0 -0.003900\n# \"\"\" ) ), sep=\"\\\\s+\", index_col=[0,1,2], converters = {'Date' : lambda col: datetime.datetime.fromisoformat( col ) \\\n# , 'Datetime' : lambda col: pd.to_datetime(col, format='%Y-%m-%dT%H:%M:%S', utc=True) }    )\n\nif __name__ == \"__main__\":\n    unittest.main()\n    \n```\n"
  },
  "feature_stats": {
    "indices": [
      1,
      4860,
      1662,
      6728,
      1094,
      6870,
      2250,
      7351,
      7851,
      1231,
      5800
    ],
    "f_before": [
      50.950740814208984,
      0.0,
      0.43093743920326233,
      0.0,
      0.0,
      0.0,
      0.0,
      0.0,
      0.0,
      0.0,
      0.0
    ],
    "f_after": [
      50.950740814208984,
      0.0,
      0.43093743920326233,
      0.0,
      0.0,
      0.0,
      0.0,
      0.0,
      0.0,
      0.0,
      0.0
    ],
    "g_before": [
      0.04659951105713844,
      5.396736145019531,
      5.475235462188721,
      4.726635932922363,
      0.0,
      0.0,
      0.021131914108991623,
      4.961851119995117,
      4.99417781829834,
      4.846884727478027,
      0.0
    ],
    "g_after": [
      0.04659951105713844,
      5.396736145019531,
      5.475235462188721,
      4.726635932922363,
      0.0,
      0.0,
      0.021131914108991623,
      4.961851119995117,
      4.99417781829834,
      4.846884727478027,
      0.0
    ],
    "num_batches_for_stats": 10
  },
  "loss_summary": {
    "train_mean_loss": 10.201878755688668,
    "train_mean_l2": 7.170743455663324,
    "train_mean_l1": 2.9389141985476015,
    "num_steps": 2000,
    "num_batches": 2000
  },
  "feature_std_summary": {
    "plot_path": "outputs/plots/20251128-004442/feature_std_layer_12.html",
    "mean_std": 1.2031725645065308,
    "max_std": 42.59959411621094
  }
}