{
  "model_name": "google/gemma-2-2b-it",
  "layer_idx": 12,
  "command": "main.py sae.loss_option=2 sae.loss_module=option2_loss experiment.use_multi_contrast=true sae.alpha_concept.code=0.01 sae.alpha_concept.harm=0.01 sae.alpha_concept.struct=0.01 sae.guidance_method=contrastive sae.use_l0=false",
  "sae": {
    "input_dim": 2304,
    "sae_dim": 9216,
    "fixed_v_cnt": 3,
    "batch_size": 4,
    "epochs": 2,
    "max_steps": 2000,
    "l1_coeff": 0.005,
    "l0_coeff": 0.0,
    "use_l0": false,
    "concept_samples_per_label": 100,
    "loss_option": 2,
    "loss_module": "option2_loss",
    "concept_feature_indices": {
      "code": 0,
      "harm": 1,
      "struct": 2
    },
    "alpha_concept": {
      "code": 0.01,
      "harm": 0.01,
      "struct": 0.01
    },
    "positive_targets": {
      "code": 1,
      "harm": 1,
      "struct": 1
    },
    "guidance_method": "contrastive",
    "guidance_margin": 0.0,
    "guidance_coeff": 1.0,
    "guidance_mse_pos_value": 1.0,
    "guidance_mse_neg_value": 0.0,
    "jumprelu_bandwidth": 0.001,
    "jumprelu_init_threshold": 0.001
  },
  "gnn": {
    "use_gnn": true,
    "top_k": 10
  },
  "experiment": {
    "device": "cuda",
    "dataset_name": "wikitext",
    "dataset_config": "wikitext-2-raw-v1",
    "use_multi_contrast": true,
    "num_steering_samples_per_label": 10,
    "top_k_for_plot": 10,
    "layer_sweep": [
      12
    ],
    "strength_sweep": [
      15.0
    ]
  },
  "steering": {
    "label": "struct",
    "feature_idx": 2,
    "strength": 15.0
  },
  "prompt": "# (C) Datadog, Inc. 2018\n# All rights reserved\n# Licensed under Simplified BSD License (see LICENSE)\nimport mock\nimport logging\nimport copy\nimport pytest\nimport simplejson as json\n\nimport requests\n\nfrom datadog_checks.openstack_controller.api import ApiFactory, SimpleApi, Authenticator, Credential\nfrom datadog_checks.openstack_controller.exceptions import (\n    IncompleteIdentity,\n    MissingNovaEndpoint,\n    MissingNeutronEndpoint,\n    AuthenticationNeeded,\n    InstancePowerOffFailure,\n    RetryLimitExceeded,\n)\nfrom . import common\n\nlog = logging.getLogger('test_openstack_controller')\n\n\ndef test_get_endpoint():\n    authenticator = Authenticator()\n    assert authenticator._get_nova_endpoint(\n        common.EXAMPLE_AUTH_RESPONSE) == u'http://10.0.2.15:8774/v2.1/0850707581fe4d738221a72db0182876'\n    with pytest.raises(MissingNovaEndpoint):\n        authenticator._get_nova_endpoint({})\n\n    assert authenticator._get_neutron_endpoint(common.EXAMPLE_AUTH_RESPONSE) == u'http://10.0.2.15:9292'\n    with pytest.raises(MissingNeutronEndpoint):\n        authenticator._get_neutron_endpoint({})\n\n    assert authenticator._get_valid_endpoint({}, None, None) is None\n    assert authenticator._get_valid_endpoint({'token': {}}, None, None) is None\n    assert authenticator._get_valid_endpoint({'token': {\"catalog\": []}}, None, None) is None\n    assert authenticator._get_valid_endpoint({'token': {\"catalog\": []}}, None, None) is None\n    assert authenticator._get_valid_endpoint({'token': {\"catalog\": [{}]}}, None, None) is None\n    assert authenticator._get_valid_endpoint({'token': {\"catalog\": [{\n        u'type': u'compute',\n        u'name': u'nova'}]}}, None, None) is None\n    assert authenticator._get_valid_endpoint({'token': {\"catalog\": [{\n        u'endpoints': [],\n        u'type': u'compute',\n        u'name': u'nova'}]}}, None, None) is None\n    assert authenticator._get_valid_endpoint({'token': {\"catalog\": [{\n        u'endpoints': [{}],\n        u'type': u'compute',\n        u'name': u'nova'}]}}, 'nova', 'compute') is None\n    assert authenticator._get_valid_endpoint({'token': {\"catalog\": [{\n        u'endpoints': [{u'url': u'dummy_url', u'interface': u'dummy'}],\n        u'type': u'compute',\n        u'name': u'nova'}]}}, 'nova', 'compute') is None\n    assert authenticator._get_valid_endpoint({'token': {\"catalog\": [{\n        u'endpoints': [{u'url': u'dummy_url'}],\n        u'type': u'compute',\n        u'name': u'nova'}]}}, 'nova', 'compute') is None\n    assert authenticator._get_valid_endpoint({'token': {\"catalog\": [{\n        u'endpoints': [{u'interface': u'public'}],\n        u'type': u'compute',\n        u'name': u'nova'}]}}, 'nova', 'compute') is None\n    assert authenticator._get_valid_endpoint({'token': {\"catalog\": [{\n        u'endpoints': [{u'url': u'dummy_url', u'interface': u'internal'}],\n        u'type': u'compute',\n        u'name': u'nova'}]}}, 'nova', 'compute') == 'dummy_url'\n\n\nBAD_USERS = [\n    {'user': {}},\n    {'user': {'name': ''}},\n    {'user': {'name': 'test_name', 'password': ''}},\n    {'user': {'name': 'test_name', 'password': 'test_pass', 'domain': {}}},\n    {'user': {'name': 'test_name', 'password': 'test_pass', 'domain': {'id': ''}}},\n]\n\nGOOD_USERS = [\n    {'user': {'name': 'test_name', 'password': 'test_pass', 'domain': {'id': 'test_id'}}},\n]\n\n\ndef _test_bad_user(user):\n    authenticator = Authenticator()\n    with pytest.raises(IncompleteIdentity):\n        authenticator._get_user_identity(user['user'])\n\n\ndef test_get_user_identity():\n    authenticator = Authenticator()\n    for user in BAD_USERS:\n        _test_bad_user(user)\n\n    for user in GOOD_USERS:\n        parsed_user = authenticator._get_user_identity(user['user'])\n        assert parsed_user == {'methods': ['password'], 'password': user}\n\n\nclass MockHTTPResponse(object):\n    def __init__(self, response_dict, headers):\n        self.response_dict = response_dict\n        self.headers = headers\n\n    def json(self):\n        return self.response_dict\n\n\nPROJECTS_RESPONSE = [\n        {},\n        {\n            \"domain_id\": \"0000\",\n        },\n        {\n            \"domain_id\": \"1111\",\n            \"id\": \"0000\",\n        },\n        {\n            \"domain_id\": \"2222\",\n            \"id\": \"1111\",\n            \"name\": \"name 1\"\n        },\n        {\n            \"domain_id\": \"3333\",\n            \"id\": \"2222\",\n            \"name\": \"name 2\"\n        },\n    ]\n\nPROJECT_RESPONSE = [\n        {\n            \"domain_id\": \"1111\",\n            \"id\": \"3333\",\n            \"name\": \"name 1\"\n        }\n    ]\n\n\ndef test_from_config():\n    mock_http_response = copy.deepcopy(common.EXAMPLE_AUTH_RESPONSE)\n    mock_response = MockHTTPResponse(response_dict=mock_http_response, headers={'X-Subject-Token': 'fake_token'})\n\n    with mock.patch('datadog_checks.openstack_controller.api.Authenticator._post_auth_token',\n                    return_value=mock_response):\n        with mock.patch('datadog_checks.openstack_controller.api.Authenticator._get_auth_projects',\n                        return_value=PROJECTS_RESPONSE):\n            cred = Authenticator.from_config(log, 'http://10.0.2.15:5000', GOOD_USERS[0]['user'])\n            assert isinstance(cred, Credential)\n            assert cred.auth_token == \"fake_token\"\n            assert cred.name == \"name 2\"\n            assert cred.domain_id == \"3333\"\n            assert cred.tenant_id == \"2222\"\n            assert cred.nova_endpoint == \"http://10.0.2.15:8774/v2.1/0850707581fe4d738221a72db0182876\"\n            assert cred.neutron_endpoint == \"http://10.0.2.15:9292\"\n\n\ndef test_from_config_with_missing_name():\n    mock_http_response = copy.deepcopy(common.EXAMPLE_AUTH_RESPONSE)\n    mock_response = MockHTTPResponse(response_dict=mock_http_response, headers={'X-Subject-Token': 'fake_token'})\n\n    project_response_without_name = copy.deepcopy(PROJECT_RESPONSE)\n    del project_response_without_name[0][\"name\"]\n\n    with mock.patch('datadog_checks.openstack_controller.api.Authenticator._post_auth_token',\n                    return_value=mock_response):\n        with mock.patch('datadog_checks.openstack_controller.api.Authenticator._get_auth_projects',\n                        return_value=project_response_without_name):\n            cred = Authenticator.from_config(log, 'http://10.0.2.15:5000', GOOD_USERS[0]['user'])\n            assert cred is None\n\n\ndef test_from_config_with_missing_id():\n    mock_http_response = copy.deepcopy(common.EXAMPLE_AUTH_RESPONSE)\n    mock_response = MockHTTPResponse(response_dict=mock_http_response, headers={'X-Subject-Token': 'fake_token'})\n\n    project_response_without_name = copy.deepcopy(PROJECT_RESPONSE)\n    del project_response_without_name[0][\"id\"]\n\n    with mock.patch('datadog_checks.openstack_controller.api.Authenticator._post_auth_token',\n                    return_value=mock_response):\n        with mock.patch('datadog_checks.openstack_controller.api.Authenticator._get_auth_projects',\n                        return_value=project_response_without_name):\n            cred = Authenticator.from_config(log, 'http://10.0.2.15:5000', GOOD_USERS[0]['user'])\n            assert cred is None\n\n\ndef get_os_hypervisor_uptime_pre_v2_52_response(url, header, params=None, timeout=None):\n    return json.loads(\"\"\"{\n        \"hypervisor\": {\n            \"hypervisor_hostname\": \"fake-mini\",\n            \"id\": 1,\n            \"state\": \"up\",\n            \"status\": \"enabled\",\n            \"uptime\": \" 08:32:11 up 93 days, 18:25, 12 users,  load average: 0.20, 0.12, 0.14\"\n        }\n    }\"\"\")\n\n\ndef get_os_hypervisor_uptime_post_v2_53_response(url, header, params=None, timeout=None):\n    return json.loads(\"\"\"{\n        \"hypervisor\": {\n            \"hypervisor_hostname\": \"fake-mini\",\n            \"id\": \"b1e43b5f-eec1-44e0-9f10-7b4945c0226d\",\n            \"state\": \"up\",\n            \"status\": \"enabled\",\n            \"uptime\": \" 08:32:11 up 93 days, 18:25, 12 users,  load average: 0.20, 0.12, 0.14\"\n        }\n    }\"\"\")\n\n\ndef test_get_os_hypervisor_uptime(aggregator):\n    with mock.patch('datadog_checks.openstack_controller.api.SimpleApi._make_request',\n                    side_effect=get_os_hypervisor_uptime_pre_v2_52_response):\n        api = SimpleApi(None, None)\n        assert api.get_os_hypervisor_uptime(1) == \\\n            \" 08:32:11 up 93 days, 18:25, 12 users,  load average: 0.20, 0.12, 0.14\"\n\n    with mock.patch('datadog_checks.openstack_controller.api.SimpleApi._make_request',\n                    side_effect=get_os_hypervisor_uptime_post_v2_53_response):\n        api = SimpleApi(None, None)\n        assert api.get_os_hypervisor_uptime(1) == \\\n            \" 08:32:11 up 93 days, 18:25, 12 users,  load average: 0.20, 0.12, 0.14\"\n\n\ndef get_os_aggregates_response(url, headers, params=None, timeout=None):\n    return json.loads(\"\"\"{\n        \"aggregates\": [\n            {\n                \"availability_zone\": \"london\",\n                \"created_at\": \"2016-12-27T23:47:32.911515\",\n                \"deleted\": false,\n                \"deleted_at\": null,\n                \"hosts\": [\n                    \"compute\"\n                ],\n                \"id\": 1,\n                \"metadata\": {\n                    \"availability_zone\": \"london\"\n                },\n                \"name\": \"name\",\n                \"updated_at\": null,\n                \"uuid\": \"6ba28ba7-f29b-45cc-a30b-6e3a40c2fb14\"\n            }\n        ]\n    }\"\"\")\n\n\ndef test_get_os_aggregates(aggregator):\n    with mock.patch('datadog_checks.openstack_controller.api.SimpleApi._make_request',\n                    side_effect=get_os_aggregates_response):\n        api = SimpleApi(None, None)\n\n        aggregates = api.get_os_aggregates()\n\n        for i in range(len(aggregates)):\n            for key, value in common.EXAMPLE_GET_OS_AGGREGATES_RETURN_VALUE[i].items():\n                assert value == aggregates[i][key]\n\n\ndef get_os_hypervisors_detail_post_v2_33_response(url, headers, params=None, timeout=None):\n    return json.loads(\"\"\"{\n        \"hypervisors\": [\n            {\n                \"cpu_info\": {\n                    \"arch\": \"x86_64\",\n                    \"model\": \"Nehalem\",\n                    \"vendor\": \"Intel\",\n                    \"features\": [\n                        \"pge\",\n                        \"clflush\"\n                    ],\n                    \"topology\": {\n                        \"cores\": 1,\n                        \"threads\": 1,\n                        \"sockets\": 4\n                    }\n                },\n                \"current_workload\": 0,\n                \"status\": \"enabled\",\n                \"state\": \"up\",\n                \"disk_available_least\": 0,\n                \"host_ip\": \"1.1.1.1\",\n                \"free_disk_gb\": 1028,\n                \"free_ram_mb\": 7680,\n                \"hypervisor_hostname\": \"host1\",\n                \"hypervisor_type\": \"fake\",\n                \"hypervisor_version\": 1000,\n                \"id\": 2,\n                \"local_gb\": 1028,\n                \"local_gb_used\": 0,\n                \"memory_mb\": 8192,\n                \"memory_mb_used\": 512,\n                \"running_vms\": 0,\n                \"service\": {\n                    \"host\": \"host1\",\n                    \"id\": 7,\n                    \"disabled_reason\": null\n                },\n                \"vcpus\": 2,\n                \"vcpus_used\": 0\n            }\n        ],\n        \"hypervisors_links\": [\n            {\n                \"href\": \"http://openstack.example.com/v2.1/6f70656e737461636b20342065766572/hypervisors/detail?limit=1&marker=2\",\n                \"rel\": \"next\"\n            }\n        ]\n    }\"\"\")  # noqa: E501\n\n\ndef get_os_hypervisors_detail_post_v2_53_response(url, headers, params=None, timeout=None):\n    return json.loads(\"\"\"{\n        \"hypervisors\": [\n            {\n                \"cpu_info\": {\n                    \"arch\": \"x86_64\",\n                    \"model\": \"Nehalem\",\n                    \"vendor\": \"Intel\",\n                    \"features\": [\n                        \"pge\",\n                        \"clflush\"\n                    ],\n                    \"topology\": {\n                        \"cores\": 1,\n                        \"threads\": 1,\n                        \"sockets\": 4\n                    }\n                },\n                \"current_workload\": 0,\n                \"status\": \"enabled\",\n                \"state\": \"up\",\n                \"disk_available_least\": 0,\n                \"host_ip\": \"1.1.1.1\",\n                \"free_disk_gb\": 1028,\n                \"free_ram_mb\": 7680,\n                \"hypervisor_hostname\": \"host2\",\n                \"hypervisor_type\": \"fake\",\n                \"hypervisor_version\": 1000,\n                \"id\": \"1bb62a04-c576-402c-8147-9e89757a09e3\",\n                \"local_gb\": 1028,\n                \"local_gb_used\": 0,\n                \"memory_mb\": 8192,\n                \"memory_mb_used\": 512,\n                \"running_vms\": 0,\n                \"service\": {\n                    \"host\": \"host1\",\n                    \"id\": \"62f62f6e-a713-4cbe-87d3-3ecf8a1e0f8d\",\n                    \"disabled_reason\": null\n                },\n                \"vcpus\": 2,\n                \"vcpus_used\": 0\n            }\n        ],\n        \"hypervisors_links\": [\n            {\n                \"href\": \"http://openstack.example.com/v2.1/6f70656e737461636b20342065766572/hypervisors/detail?limit=1&marker=1bb62a04-c576-402c-8147-9e89757a09e3\",\n                \"rel\": \"next\"\n            }\n        ]\n    }\"\"\")  # noqa: E501\n\n\ndef test_get_os_hypervisors_detail(aggregator):\n    with mock.patch('datadog_checks.openstack_controller.api.SimpleApi._make_request',\n                    side_effect=get_os_hypervisors_detail_post_v2_33_response):\n        api = SimpleApi(None, None)\n        assert api.get_os_hypervisors_detail() == common.EXAMPLE_GET_OS_HYPERVISORS_RETURN_VALUE\n\n    with mock.patch('datadog_checks.openstack_controller.api.SimpleApi._make_request',\n                    side_effect=get_os_hypervisors_detail_post_v2_53_response):\n        api = SimpleApi(None, None)\n        assert api.get_os_hypervisors_detail() == [\n            {\n                \"cpu_info\": {\n                    \"arch\": \"x86_64\",\n                    \"model\": \"Nehalem\",\n                    \"vendor\": \"Intel\",\n                    \"features\": [\n                        \"pge\",\n                        \"clflush\"\n                    ],\n                    \"topology\": {\n                        \"cores\": 1,\n                        \"threads\": 1,\n                        \"sockets\": 4\n                    }\n                },\n                \"current_workload\": 0,\n                \"status\": \"enabled\",\n                \"state\": \"up\",\n                \"disk_available_least\": 0,\n                \"host_ip\": \"1.1.1.1\",\n                \"free_disk_gb\": 1028,\n                \"free_ram_mb\": 7680,\n                \"hypervisor_hostname\": \"host2\",\n                \"hypervisor_type\": \"fake\",\n                \"hypervisor_version\": 1000,\n                \"id\": \"1bb62a04-c576-402c-8147-9e89757a09e3\",\n                \"local_gb\": 1028,\n                \"local_gb_used\": 0,\n                \"memory_mb\": 8192,\n                \"memory_mb_used\": 512,\n                \"running_vms\": 0,\n                \"service\": {\n                    \"host\": \"host1\",\n                    \"id\": \"62f62f6e-a713-4cbe-87d3-3ecf8a1e0f8d\",\n                    \"disabled_reason\": None\n                },\n                \"vcpus\": 2,\n                \"vcpus_used\": 0\n            }]\n\n\ndef get_servers_detail_post_v2_63_response(url, headers, params=None, timeout=None):\n    return json.loads(\"\"\"{\n        \"servers\": [\n            {\n                \"OS-DCF:diskConfig\": \"AUTO\",\n                \"OS-EXT-AZ:availability_zone\": \"nova\",\n                \"OS-EXT-SRV-ATTR:host\": \"compute\",\n                \"OS-EXT-SRV-ATTR:hostname\": \"new-server-test\",\n                \"OS-EXT-SRV-ATTR:hypervisor_hostname\": \"fake-mini\",\n                \"OS-EXT-SRV-ATTR:instance_name\": \"instance-00000001\",\n                \"OS-EXT-SRV-ATTR:kernel_id\": \"\",\n                \"OS-EXT-SRV-ATTR:launch_index\": 0,\n                \"OS-EXT-SRV-ATTR:ramdisk_id\": \"\",\n                \"OS-EXT-SRV-ATTR:reservation_id\": \"r-y0w4v32k\",\n                \"OS-EXT-SRV-ATTR:root_device_name\": \"/dev/sda\",\n                \"OS-EXT-SRV-ATTR:user_data\": \"IyEvYmluL2Jhc2gKL2Jpbi9zdQplY2hvICJJIGFtIGluIHlvdSEiCg==\",\n                \"OS-EXT-STS:power_state\": 1,\n                \"OS-EXT-STS:task_state\": null,\n                \"OS-EXT-STS:vm_state\": \"active\",\n                \"OS-SRV-USG:launched_at\": \"2017-10-10T15:49:09.516729\",\n                \"OS-SRV-USG:terminated_at\": null,\n                \"accessIPv4\": \"1.2.3.4\",\n                \"accessIPv6\": \"80fe::\",\n                \"addresses\": {\n                    \"private\": [\n                        {\n                            \"OS-EXT-IPS-MAC:mac_addr\": \"aa:bb:cc:dd:ee:ff\",\n                            \"OS-EXT-IPS:type\": \"fixed\",\n                            \"addr\": \"192.168.0.3\",\n                            \"version\": 4\n                        }\n                    ]\n                },\n                \"config_drive\": \"\",\n                \"created\": \"2017-10-10T15:49:08Z\",\n                \"description\": null,\n                \"flavor\": {\n                    \"disk\": 1,\n                    \"ephemeral\": 0,\n                    \"extra_specs\": {\n                        \"hw:cpu_policy\": \"dedicated\",\n                        \"hw:mem_page_size\": \"2048\"\n                    },\n                    \"original_name\": \"m1.tiny.specs\",\n                    \"ram\": 512,\n                    \"swap\": 0,\n                    \"vcpus\": 1\n                },\n                \"hostId\": \"2091634baaccdc4c5a1d57069c833e402921df696b7f970791b12ec6\",\n                \"host_status\": \"UP\",\n                \"id\": \"569f39f9-7c76-42a1-9c2d-8394e2638a6d\",\n                \"image\": {\n                    \"id\": \"70a599e0-31e7-49b7-b260-868f441e862b\",\n                    \"links\": [\n                        {\n                            \"href\": \"http://openstack.example.com/6f70656e737461636b20342065766572/images/70a599e0-31e7-49b7-b260-868f441e862b\",\n                            \"rel\": \"bookmark\"\n                        }\n                    ]\n                },\n                \"key_name\": null,\n                \"links\": [\n                    {\n                        \"href\": \"http://openstack.example.com/v2.1/6f70656e737461636b20342065766572/servers/569f39f9-7c76-42a1-9c2d-8394e2638a6d\",\n                        \"rel\": \"self\"\n                    },\n                    {\n                        \"href\": \"http://openstack.example.com/6f70656e737461636b20342065766572/servers/569f39f9-7c76-42a1-9c2d-8394e2638a6d\",\n                        \"rel\": \"bookmark\"\n                    }\n                ],\n                \"locked\": false,\n                \"metadata\": {\n                    \"My Server Name\": \"Apache1\"\n                },\n                \"name\": \"new-server-test\",\n                \"os-extended-volumes:volumes_attached\": [],\n                \"progress\": 0,\n                \"security_groups\": [\n                    {\n                        \"name\": \"default\"\n                    }\n                ],\n                \"status\": \"ACTIVE\",\n                \"tags\": [],\n                \"tenant_id\": \"6f70656e737461636b20342065766572\",\n                \"trusted_image_certificates\": [\n                    \"0b5d2c72-12cc-4ba6-a8d7-3ff5cc1d8cb8\",\n                    \"674736e3-f25c-405c-8362-bbf991e0ce0a\"\n                ],\n                \"updated\": \"2017-10-10T15:49:09Z\",\n                \"user_id\": \"fake\"\n            }\n        ]\n    }\"\"\")  # noqa: E501\n\n\ndef test_get_servers_detail(aggregator):\n    with mock.patch('datadog_checks.openstack_controller.api.SimpleApi._make_request',\n                    side_effect=get_servers_detail_post_v2_63_response):\n        api = SimpleApi(None, None)\n        assert api.get_servers_detail(None) == [\n            {\n                \"OS-DCF:diskConfig\": \"AUTO\",\n                \"OS-EXT-AZ:availability_zone\": \"nova\",\n                \"OS-EXT-SRV-ATTR:host\": \"compute\",\n                \"OS-EXT-SRV-ATTR:hostname\": \"new-server-test\",\n                \"OS-EXT-SRV-ATTR:hypervisor_hostname\": \"fake-mini\",\n                \"OS-EXT-SRV-ATTR:instance_name\": \"instance-00000001\",\n                \"OS-EXT-SRV-ATTR:kernel_id\": \"\",\n                \"OS-EXT-SRV-ATTR:launch_index\": 0,\n                \"OS-EXT-SRV-ATTR:ramdisk_id\": \"\",\n                \"OS-EXT-SRV-ATTR:reservation_id\": \"r-y0w4v32k\",\n                \"OS-EXT-SRV-ATTR:root_device_name\": \"/dev/sda\",\n                \"OS-EXT-SRV-ATTR:user_data\": \"IyEvYmluL2Jhc2gKL2Jpbi9zdQplY2hvICJJIGFtIGluIHlvdSEiCg==\",\n                \"OS-EXT-STS:power_state\": 1,\n                \"OS-EXT-STS:task_state\": None,\n                \"OS-EXT-STS:vm_state\": \"active\",\n                \"OS-SRV-USG:launched_at\": \"2017-10-10T15:49:09.516729\",\n                \"OS-SRV-USG:terminated_at\": None,\n                \"accessIPv4\": \"1.2.3.4\",\n                \"accessIPv6\": \"80fe::\",\n                \"addresses\": {\n                    \"private\": [\n                        {\n                            \"OS-EXT-IPS-MAC:mac_addr\": \"aa:bb:cc:dd:ee:ff\",\n                            \"OS-EXT-IPS:type\": \"fixed\",\n                            \"addr\": \"192.168.0.3\",\n                            \"version\": 4\n                        }\n                    ]\n                },\n                \"config_drive\": \"\",\n                \"created\": \"2017-10-10T15:49:08Z\",\n                \"description\": None,\n                \"flavor\": {\n                    \"disk\": 1,\n                    \"ephemeral\": 0,\n                    \"extra_specs\": {\n                        \"hw:cpu_policy\": \"dedicated\",\n                        \"hw:mem_page_size\": \"2048\"\n                    },\n                    \"original_name\": \"m1.tiny.specs\",\n                    \"ram\": 512,\n                    \"swap\": 0,\n                    \"vcpus\": 1\n                },\n                \"hostId\": \"2091634baaccdc4c5a1d57069c833e402921df696b7f970791b12ec6\",\n                \"host_status\": \"UP\",\n                \"id\": \"569f39f9-7c76-42a1-9c2d-8394e2638a6d\",\n                \"image\": {\n                    \"id\": \"70a599e0-31e7-49b7-b260-868f441e862b\",\n                    \"links\": [\n                        {\n                            \"href\": \"http://openstack.example.com/6f70656e737461636b20342065766572/images/70a599e0-31e7-49b7-b260-868f441e862b\",  # noqa: E501\n                            \"rel\": \"bookmark\"\n                        }\n                    ]\n                },\n                \"key_name\": None,\n                \"links\": [\n                    {\n                        \"href\": \"http://openstack.example.com/v2.1/6f70656e737461636b20342065766572/servers/569f39f9-7c76-42a1-9c2d-8394e2638a6d\",  # noqa: E501\n                        \"rel\": \"self\"\n                    },\n                    {\n                        \"href\": \"http://openstack.example.com/6f70656e737461636b20342065766572/servers/569f39f9-7c76-42a1-9c2d-8394e2638a6d\",  # noqa: E501\n                        \"rel\": \"bookmark\"\n                    }\n                ],\n                \"locked\": False,\n                \"metadata\": {\n                    \"My Server Name\": \"Apache1\"\n                },\n                \"name\": \"new-server-test\",\n                \"os-extended-volumes:volumes_attached\": [],\n                \"progress\": 0,\n                \"security_groups\": [\n                    {\n                        \"name\": \"default\"\n                    }\n                ],\n                \"status\": \"ACTIVE\",\n                \"tags\": [],\n                \"tenant_id\": \"6f70656e737461636b20342065766572\",\n                \"trusted_image_certificates\": [\n                    \"0b5d2c72-12cc-4ba6-a8d7-3ff5cc1d8cb8\",\n                    \"674736e3-f25c-405c-8362-bbf991e0ce0a\"\n                ],\n                \"updated\": \"2017-10-10T15:49:09Z\",\n                \"user_id\": \"fake\"\n            }\n        ]\n\n\ndef test__get_paginated_list():\n\n    log = mock.MagicMock()\n\n    instance = copy.deepcopy(common.MOCK_CONFIG[\"instances\"][0])\n    instance[\"paginated_limit\"] = 4\n\n    with mock.patch(\"datadog_checks.openstack_controller.api.SimpleApi.connect\"):\n        api = ApiFactory.create(log, None, instance)\n    with mock.patch(\n        \"datadog_checks.openstack_controller.api.SimpleApi._make_request\",\n        side_effect=[\n            # First call: 3 exceptions -> failure\n            requests.exceptions.HTTPError,\n            requests.exceptions.HTTPError,\n            requests.exceptions.HTTPError,\n        ]\n    ):\n        # First call\n        with pytest.raises(RetryLimitExceeded):\n            api._get_paginated_list(\"url\", \"obj\", {})\n        assert log.debug.call_count == 3\n        log.reset_mock()\n\n    with mock.patch(\n        \"datadog_checks.openstack_controller.api.SimpleApi._make_request\",\n        side_effect=[\n            # Second call: all good, 1 page with 4 results, one with 1\n            {\n                \"obj\": [{\"id\": 0}, {\"id\": 1}, {\"id\": 2}, {\"id\": 3}],\n                \"obj_links\": \"test\"\n            },\n            {\n                \"obj\": [{\"id\": 4}]\n            },\n        ]\n    ):\n        # Second call\n        assert api.paginated_limit == 4\n        result = api._get_paginated_list(\"url\", \"obj\", {})\n        assert log.debug.call_count == 0\n        assert result == [{\"id\": 0}, {\"id\": 1}, {\"id\": 2}, {\"id\": 3}, {\"id\": 4}]\n\n    with mock.patch(\n        \"datadog_checks.openstack_controller.api.SimpleApi._make_request\",\n        side_effect=[\n            # Third call: 1 exception, limit is divided once by 2\n            requests.exceptions.HTTPError,\n            {\n                \"obj\": [{\"id\": 0}, {\"id\": 1}],\n                \"obj_links\": \"test\"\n            },\n            {\n                \"obj\": [{\"id\": 2}, {\"id\": 3}],\n                \"obj_links\": \"test\"\n            },\n            {\n                \"obj\": [{\"id\": 4}]\n            }\n        ]\n    ):\n        # Third call\n        result = api._get_paginated_list(\"url\", \"obj\", {})\n        assert log.debug.call_count == 1\n        assert result == [{\"id\": 0}, {\"id\": 1}, {\"id\": 2}, {\"id\": 3}, {\"id\": 4}]\n        log.reset_mock()\n\n    with mock.patch(\n        \"datadog_checks.openstack_controller.api.SimpleApi._make_request\",\n        side_effect=[\n            # Fourth call: 1 AuthenticationNeeded exception -> no retries\n            AuthenticationNeeded,\n            # Fifth call: any other exception -> no retries\n            Exception,\n        ]\n    ):\n        with pytest.raises(AuthenticationNeeded):\n            api._get_paginated_list(\"url\", \"obj\", {})\n        with pytest.raises(Exception):\n            api._get_paginated_list(\"url\", \"obj\", {})\n\n\ndef test__make_request_failure():\n    log = mock.MagicMock()\n\n    instance = copy.deepcopy(common.MOCK_CONFIG[\"instances\"][0])\n    instance[\"paginated_limit\"] = 4\n\n    with mock.patch(\"datadog_checks.openstack_controller.api.SimpleApi.connect\"):\n        api = ApiFactory.create(log, None, instance)\n\n    response_mock = mock.MagicMock()\n    with mock.patch(\n        \"datadog_checks.openstack_controller.api.requests.get\",\n        return_value=response_mock\n    ):\n        response_mock.raise_for_status.side_effect = requests.exceptions.HTTPError\n        response_mock.status_code = 401\n        with pytest.raises(AuthenticationNeeded):\n            api._make_request(\"\", {})\n\n        response_mock.status_code = 409\n        with pytest.raises(InstancePowerOffFailure):\n            api._make_request(\"\", {})\n\n        response_mock.status_code = 500\n        with pytest.raises(requests.exceptions.HTTPError):\n            api._make_request(\"\", {})\n\n        response_mock.raise_for_status.side_effect = Exception\n        with pytest.raises(Exception):\n            api._make_request(\"\", {})\n\n\ndef get_server_diagnostics_post_v2_48_response(url, headers, params=None, timeout=None):\n    return json.loads(\"\"\"{\n        \"config_drive\": true,\n        \"cpu_details\": [\n            {\n                \"id\": 0,\n                \"time\": 17300000000,\n                \"utilisation\": 15\n            }\n        ],\n        \"disk_details\": [\n            {\n                \"errors_count\": 1,\n                \"read_bytes\": 262144,\n                \"read_requests\": 112,\n                \"write_bytes\": 5778432,\n                \"write_requests\": 488\n            }\n        ],\n        \"driver\": \"libvirt\",\n        \"hypervisor\": \"kvm\",\n        \"hypervisor_os\": \"ubuntu\",\n        \"memory_details\": {\n            \"maximum\": 524288,\n            \"used\": 0\n        },\n        \"nic_details\": [\n            {\n                \"mac_address\": \"01:23:45:67:89:ab\",\n                \"rx_drop\": 200,\n                \"rx_errors\": 100,\n                \"rx_octets\": 2070139,\n                \"rx_packets\": 26701,\n                \"rx_rate\": 300,\n                \"tx_drop\": 500,\n                \"tx_errors\": 400,\n                \"tx_octets\": 140208,\n                \"tx_packets\": 662,\n                \"tx_rate\": 600\n            }\n        ],\n        \"num_cpus\": 1,\n        \"num_disks\": 1,\n        \"num_nics\": 1,\n        \"state\": \"running\",\n        \"uptime\": 46664\n    }\"\"\")\n\n\ndef get_server_diagnostics_post_v2_1_response(url, headers, params=None, timeout=None):\n    return json.loads(\"\"\"{\n        \"cpu0_time\": 17300000000,\n        \"memory\": 524288,\n        \"vda_errors\": -1,\n        \"vda_read\": 262144,\n        \"vda_read_req\": 112,\n        \"vda_write\": 5778432,\n        \"vda_write_req\": 488,\n        \"vnet1_rx\": 2070139,\n        \"vnet1_rx_drop\": 0,\n        \"vnet1_rx_errors\": 0,\n        \"vnet1_rx_packets\": 26701,\n        \"vnet1_tx\": 140208,\n        \"vnet1_tx_drop\": 0,\n        \"vnet1_tx_errors\": 0,\n        \"vnet1_tx_packets\": 662\n    }\"\"\")\n\n\ndef test_get_server_diagnostics(aggregator):\n    with mock.patch('datadog_checks.openstack_controller.api.SimpleApi._make_request',\n                    side_effect=get_server_diagnostics_post_v2_48_response):\n        api = SimpleApi(None, None)\n        assert api.get_server_diagnostics(None) == {\n            \"config_drive\": True,\n            \"cpu_details\": [\n                {\n                    \"id\": 0,\n                    \"time\": 17300000000,\n                    \"utilisation\": 15\n                }\n            ],\n            \"disk_details\": [\n                {\n                    \"errors_count\": 1,\n                    \"read_bytes\": 262144,\n                    \"read_requests\": 112,\n                    \"write_bytes\": 5778432,\n                    \"write_requests\": 488\n                }\n            ],\n            \"driver\": \"libvirt\",\n            \"hypervisor\": \"kvm\",\n            \"hypervisor_os\": \"ubuntu\",\n            \"memory_details\": {\n                \"maximum\": 524288,\n                \"used\": 0\n            },\n            \"nic_details\": [\n                {\n                    \"mac_address\": \"01:23:45:67:89:ab\",\n                    \"rx_drop\": 200,\n                    \"rx_errors\": 100,\n                    \"rx_octets\": 2070139,\n                    \"rx_packets\": 26701,\n                    \"rx_rate\": 300,\n                    \"tx_drop\": 500,\n                    \"tx_errors\": 400,\n                    \"tx_octets\": 140208,\n                    \"tx_packets\": 662,\n                    \"tx_rate\": 600\n                }\n            ],\n            \"num_cpus\": 1,\n            \"num_disks\": 1,\n            \"num_nics\": 1,\n            \"state\": \"running\",\n            \"uptime\": 46664\n        }\n\n    with mock.patch('datadog_checks.openstack_controller.api.SimpleApi._make_request',\n                    side_effect=get_server_diagnostics_post_v2_1_response):\n        api = SimpleApi(None, None)\n        assert api.get_server_diagnostics(None) == {\n            \"cpu0_time\": 17300000000,\n            \"memory\": 524288,\n            \"vda_errors\": -1,\n            \"vda_read\": 262144,\n            \"vda_read_req\": 112,\n            \"vda_write\": 5778432,\n            \"vda_write_req\": 488,\n            \"vnet1_rx\": 2070139,\n            \"vnet1_rx_drop\": 0,\n            \"vnet1_rx_errors\": 0,\n            \"vnet1_rx_packets\": 26701,\n            \"vnet1_tx\": 140208,\n            \"vnet1_tx_drop\": 0,\n            \"vnet1_tx_errors\": 0,\n            \"vnet1_tx_packets\": 662\n        }\n\n\ndef get_project_limits_response(url, headers, params=None, timeout=None):\n    return json.loads(\"\"\"{\n        \"limits\": {\n            \"absolute\": {\n                \"maxImageMeta\": 128,\n                \"maxPersonality\": 5,\n                \"maxPersonalitySize\": 10240,\n                \"maxSecurityGroupRules\": 20,\n                \"maxSecurityGroups\": 10,\n                \"maxServerMeta\": 128,\n                \"maxTotalCores\": 20,\n                \"maxTotalFloatingIps\": 10,\n                \"maxTotalInstances\": 10,\n                \"maxTotalKeypairs\": 100,\n                \"maxTotalRAMSize\": 51200,\n                \"maxServerGroups\": 10,\n                \"maxServerGroupMembers\": 10,\n                \"totalCoresUsed\": 0,\n                \"totalInstancesUsed\": 0,\n                \"totalRAMUsed\": 0,\n                \"totalSecurityGroupsUsed\": 0,\n                \"totalFloatingIpsUsed\": 0,\n                \"totalServerGroupsUsed\": 0\n            },\n            \"rate\": []\n        }\n    }\"\"\")\n\n\ndef test_get_project_limits(aggregator):\n    with mock.patch('datadog_checks.openstack_controller.api.SimpleApi._make_request',\n                    side_effect=get_project_limits_response):\n        api = SimpleApi(None, None)\n        assert api.get_project_limits(None) == common.EXAMPLE_GET_PROJECT_LIMITS_RETURN_VALUE\n",
  "output": {
    "before": "# (C) Datadog, Inc. 2018\n# All rights reserved\n# Licensed under Simplified BSD License (see LICENSE)\nimport mock\nimport logging\nimport copy\nimport pytest\nimport simplejson as json\n\nimport requests\n\nfrom datadog_checks.openstack_controller.api import ApiFactory, SimpleApi, Authenticator, Credential\nfrom datadog_checks.openstack_controller.exceptions import (\n    IncompleteIdentity,\n    MissingNovaEndpoint,\n    MissingNeutronEndpoint,\n    AuthenticationNeeded,\n    InstancePowerOffFailure,\n    RetryLimitExceeded,\n)\nfrom . import common\n\nlog = logging.getLogger('test_openstack_controller')\n\n\ndef test_get_endpoint():\n    authenticator = Authenticator()\n    assert authenticator._get_nova_endpoint(\n        common.EXAMPLE_AUTH_RESPONSE) == u'http://10.0.2.15:8774/v2.1/0850707581fe4d738221a72db0182876'\n    with pytest.raises(MissingNovaEndpoint):\n        authenticator._get_nova_endpoint({})\n\n    assert authenticator._get_neutron_endpoint(common.EXAMPLE_AUTH_RESPONSE) == u'http://10.0.2.15:9292'\n    with pytest.raises(MissingNeutronEndpoint):\n        authenticator._get_neutron_endpoint({})\n\n    assert authenticator._get_valid_endpoint({}, None, None) is None\n    assert authenticator._get_valid_endpoint({'token': {}}, None, None) is None\n    assert authenticator._get_valid_endpoint({'token': {\"catalog\": []}}, None, None) is None\n    assert authenticator._get_valid_endpoint({'token': {\"catalog\": []}}, None, None) is None\n    assert authenticator._get_valid_endpoint({'token': {\"catalog\": [{}]}}, None, None) is None\n    assert authenticator._get_valid_endpoint({'token': {\"catalog\": [{\n        u'type': u'compute',\n        u'name': u'nova'}]}}, None, None) is None\n    assert authenticator._get_valid_endpoint({'token': {\"catalog\": [{\n        u'endpoints': [],\n        u'type': u'compute',\n        u'name': u'nova'}]}}, None, None) is None\n    assert authenticator._get_valid_endpoint({'token': {\"catalog\": [{\n        u'endpoints': [{}],\n        u'type': u'compute',\n        u'name': u'nova'}]}}, 'nova', 'compute') is None\n    assert authenticator._get_valid_endpoint({'token': {\"catalog\": [{\n        u'endpoints': [{u'url': u'dummy_url', u'interface': u'dummy'}],\n        u'type': u'compute',\n        u'name': u'nova'}]}}, 'nova', 'compute') is None\n    assert authenticator._get_valid_endpoint({'token': {\"catalog\": [{\n        u'endpoints': [{u'url': u'dummy_url'}],\n        u'type': u'compute',\n        u'name': u'nova'}]}}, 'nova', 'compute') is None\n    assert authenticator._get_valid_endpoint({'token': {\"catalog\": [{\n        u'endpoints': [{u'interface': u'public'}],\n        u'type': u'compute',\n        u'name': u'nova'}]}}, 'nova', 'compute') is None\n    assert authenticator._get_valid_endpoint({'token': {\"catalog\": [{\n        u'endpoints': [{u'url': u'dummy_url', u'interface': u'internal'}],\n        u'type': u'compute',\n        u'name': u'nova'}]}}, 'nova', 'compute') == 'dummy_url'\n\n\nBAD_USERS = [\n    {'user': {}},\n    {'user': {'name': ''}},\n    {'user': {'name': 'test_name', 'password': ''}},\n    {'user': {'name': 'test_name', 'password': 'test_pass', 'domain': {}}},\n    {'user': {'name': 'test_name', 'password': 'test_pass', 'domain': {'id': ''}}},\n]\n\nGOOD_USERS = [\n    {'user': {'name': 'test_name', 'password': 'test_pass', 'domain': {'id': 'test_id'}}},\n]\n\n\ndef _test_bad_user(user):\n    authenticator = Authenticator()\n    with pytest.raises(IncompleteIdentity):\n        authenticator._get_user_identity(user['user'])\n\n\ndef test_get_user_identity():\n    authenticator = Authenticator()\n    for user in BAD_USERS:\n        _test_bad_user(user)\n\n    for user in GOOD_USERS:\n        parsed_user = authenticator._get_user_identity(user['user'])\n        assert parsed_user == {'methods': ['password'], 'password': user}\n\n\nclass MockHTTPResponse(object):\n    def __init__(self, response_dict, headers):\n        self.response_dict = response_dict\n        self.headers = headers\n\n    def json(self):\n        return self.response_dict\n\n\nPROJECTS_RESPONSE = [\n        {},\n        {\n            \"domain_id\": \"0000\",\n        },\n        {\n            \"domain_id\": \"1111\",\n            \"id\": \"0000\",\n        },\n        {\n            \"domain_id\": \"2222\",\n            \"id\": \"1111\",\n            \"name\": \"name 1\"\n        },\n        {\n            \"domain_id\": \"3333\",\n            \"id\": \"2222\",\n            \"name\": \"name 2\"\n        },\n    ]\n\nPROJECT_RESPONSE = [\n        {\n            \"domain_id\": \"1111\",\n            \"id\": \"3333\",\n            \"name\": \"name 1\"\n        }\n    ]\n\n\ndef test_from_config():\n    mock_http_response = copy.deepcopy(common.EXAMPLE_AUTH_RESPONSE)\n    mock_response = MockHTTPResponse(response_dict=mock_http_response, headers={'X-Subject-Token': 'fake_token'})\n\n    with mock.patch('datadog_checks.openstack_controller.api.Authenticator._post_auth_token',\n                    return_value=mock_response):\n        with mock.patch('datadog_checks.openstack_controller.api.Authenticator._get_auth_projects',\n                        return_value=PROJECTS_RESPONSE):\n            cred = Authenticator.from_config(log, 'http://10.0.2.15:5000', GOOD_USERS[0]['user'])\n            assert isinstance(cred, Credential)\n            assert cred.auth_token == \"fake_token\"\n            assert cred.name == \"name 2\"\n            assert cred.domain_id == \"3333\"\n            assert cred.tenant_id == \"2222\"\n            assert cred.nova_endpoint == \"http://10.0.2.15:8774/v2.1/0850707581fe4d738221a72db0182876\"\n            assert cred.neutron_endpoint == \"http://10.0.2.15:9292\"\n\n\ndef test_from_config_with_missing_name():\n    mock_http_response = copy.deepcopy(common.EXAMPLE_AUTH_RESPONSE)\n    mock_response = MockHTTPResponse(response_dict=mock_http_response, headers={'X-Subject-Token': 'fake_token'})\n\n    project_response_without_name = copy.deepcopy(PROJECT_RESPONSE)\n    del project_response_without_name[0][\"name\"]\n\n    with mock.patch('datadog_checks.openstack_controller.api.Authenticator._post_auth_token',\n                    return_value=mock_response):\n        with mock.patch('datadog_checks.openstack_controller.api.Authenticator._get_auth_projects',\n                        return_value=project_response_without_name):\n            cred = Authenticator.from_config(log, 'http://10.0.2.15:5000', GOOD_USERS[0]['user'])\n            assert cred is None\n\n\ndef test_from_config_with_missing_id():\n    mock_http_response = copy.deepcopy(common.EXAMPLE_AUTH_RESPONSE)\n    mock_response = MockHTTPResponse(response_dict=mock_http_response, headers={'X-Subject-Token': 'fake_token'})\n\n    project_response_without_name = copy.deepcopy(PROJECT_RESPONSE)\n    del project_response_without_name[0][\"id\"]\n\n    with mock.patch('datadog_checks.openstack_controller.api.Authenticator._post_auth_token',\n                    return_value=mock_response):\n        with mock.patch('datadog_checks.openstack_controller.api.Authenticator._get_auth_projects',\n                        return_value=project_response_without_name):\n            cred = Authenticator.from_config(log, 'http://10.0.2.15:5000', GOOD_USERS[0]['user'])\n            assert cred is None\n\n\ndef get_os_hypervisor_uptime_pre_v2_52_response(url, header, params=None, timeout=None):\n    return json.loads(\"\"\"{\n        \"hypervisor\": {\n            \"hypervisor_hostname\": \"fake-mini\",\n            \"id\": 1,\n            \"state\": \"up\",\n            \"status\": \"enabled\",\n            \"uptime\": \" 08:32:11 up 93 days, 18:25, 12 users,  load average: 0.20, 0.12, 0.14\"\n        }\n    }\"\"\")\n\n\ndef get_os_hypervisor_uptime_post_v2_53_response(url, header, params=None, timeout=None):\n    return json.loads(\"\"\"{\n        \"hypervisor\": {\n            \"hypervisor_hostname\": \"fake-mini\",\n            \"id\": \"b1e43b5f-eec1-44e0-9f10-7b4945c0226d\",\n            \"state\": \"up\",\n            \"status\": \"enabled\",\n            \"uptime\": \" 08:32:11 up 93 days, 18:25, 12 users,  load average: 0.20, 0.12, 0.14\"\n        }\n    }\"\"\")\n\n\ndef test_get_os_hypervisor_uptime(aggregator):\n    with mock.patch('datadog_checks.openstack_controller.api.SimpleApi._make_request',\n                    side_effect=get_os_hypervisor_uptime_pre_v2_52_response):\n        api = SimpleApi(None, None)\n        assert api.get_os_hypervisor_uptime(1) == \\\n            \" 08:32:11 up 93 days, 18:25, 12 users,  load average: 0.20, 0.12, 0.14\"\n\n    with mock.patch('datadog_checks.openstack_controller.api.SimpleApi._make_request',\n                    side_effect=get_os_hypervisor_uptime_post_v2_53_response):\n        api = SimpleApi(None, None)\n        assert api.get_os_hypervisor_uptime(1) == \\\n            \" 08:32:11 up 93 days, 18:25, 12 users,  load average: 0.20, 0.12, 0.14\"\n\n\ndef get_os_aggregates_response(url, headers, params=None, timeout=None):\n    return json.loads(\"\"\"{\n        \"aggregates\": [\n            {\n                \"availability_zone\": \"london\",\n                \"created_at\": \"2016-12-27T23:47:32.911515\",\n                \"deleted\": false,\n                \"deleted_at\": null,\n                \"hosts\": [\n                    \"compute\"\n                ],\n                \"id\": 1,\n                \"metadata\": {\n                    \"availability_zone\": \"london\"\n                },\n                \"name\": \"name\",\n                \"updated_at\": null,\n                \"uuid\": \"6ba28ba7-f29b-45cc-a30b-6e3a40c2fb14\"\n            }\n        ]\n    }\"\"\")\n\n\ndef test_get_os_aggregates(aggregator):\n    with mock.patch('datadog_checks.openstack_controller.api.SimpleApi._make_request',\n                    side_effect=get_os_aggregates_response):\n        api = SimpleApi(None, None)\n\n        aggregates = api.get_os_aggregates()\n\n        for i in range(len(aggregates)):\n            for key, value in common.EXAMPLE_GET_OS_AGGREGATES_RETURN_VALUE[i].items():\n                assert value == aggregates[i][key]\n\n\ndef get_os_hypervisors_detail_post_v2_33_response(url, headers, params=None, timeout=None):\n    return json.loads(\"\"\"{\n        \"hypervisors\": [\n            {\n                \"cpu_info\": {\n                    \"arch\": \"x86_64\",\n                    \"model\": \"Nehalem\",\n                    \"vendor\": \"Intel\",\n                    \"features\": [\n                        \"pge\",\n                        \"clflush\"\n                    ],\n                    \"topology\": {\n                        \"cores\": 1,\n                        \"threads\": 1,\n                        \"sockets\": 4\n                    }\n                },\n                \"current_workload\": 0,\n                \"status\": \"enabled\",\n                \"state\": \"up\",\n                \"disk_available_least\": 0,\n                \"host_ip\": \"1.1.1.1\",\n                \"free_disk_gb\": 1028,\n                \"free_ram_mb\": 7680,\n                \"hypervisor_hostname\": \"host1\",\n                \"hypervisor_type\": \"fake\",\n                \"hypervisor_version\": 1000,\n                \"id\": 2,\n                \"local_gb\": 1028,\n                \"local_gb_used\": 0,\n                \"memory_mb\": 8192,\n                \"memory_mb_used\": 512,\n                \"running_vms\": 0,\n                \"service\": {\n                    \"host\": \"host1\",\n                    \"id\": 7,\n                    \"disabled_reason\": null\n                },\n                \"vcpus\": 2,\n                \"vcpus_used\": 0\n            }\n        ],\n        \"hypervisors_links\": [\n            {\n                \"href\": \"http://openstack.example.com/v2.1/6f70656e737461636b20342065766572/hypervisors/detail?limit=1&marker=2\",\n                \"rel\": \"next\"\n            }\n        ]\n    }\"\"\")  # noqa: E501\n\n\ndef get_os_hypervisors_detail_post_v2_53_response(url, headers, params=None, timeout=None):\n    return json.loads(\"\"\"{\n        \"hypervisors\": [\n            {\n                \"cpu_info\": {\n                    \"arch\": \"x86_64\",\n                    \"model\": \"Nehalem\",\n                    \"vendor\": \"Intel\",\n                    \"features\": [\n                        \"pge\",\n                        \"clflush\"\n                    ],\n                    \"topology\": {\n                        \"cores\": 1,\n                        \"threads\": 1,\n                        \"sockets\": 4\n                    }\n                },\n                \"current_workload\": 0,\n                \"status\": \"enabled\",\n                \"state\": \"up\",\n                \"disk_available_least\": 0,\n                \"host_ip\": \"1.1.1.1\",\n                \"free_disk_gb\": 1028,\n                \"free_ram_mb\": 7680,\n                \"hypervisor_hostname\": \"host2\",\n                \"hypervisor_type\": \"fake\",\n                \"hypervisor_version\": 1000,\n                \"id\": \"1bb62a04-c576-402c-8147-9e89757a09e3\",\n                \"local_gb\": 1028,\n                \"local_gb_used\": 0,\n                \"memory_mb\": 8192,\n                \"memory_mb_used\": 512,\n                \"running_vms\": 0,\n                \"service\": {\n                    \"host\": \"host1\",\n                    \"id\": \"62f62f6e-a713-4cbe-87d3-3ecf8a1e0f8d\",\n                    \"disabled_reason\": null\n                },\n                \"vcpus\": 2,\n                \"vcpus_used\": 0\n            }\n        ],\n        \"hypervisors_links\": [\n            {\n                \"href\": \"http://openstack.example.com/v2.1/6f70656e737461636b20342065766572/hypervisors/detail?limit=1&marker=1bb62a04-c576-402c-8147-9e89757a09e3\",\n                \"rel\": \"next\"\n            }\n        ]\n    }\"\"\")  # noqa: E501\n\n\ndef test_get_os_hypervisors_detail(aggregator):\n    with mock.patch('datadog_checks.openstack_controller.api.SimpleApi._make_request',\n                    side_effect=get_os_hypervisors_detail_post_v2_33_response):\n        api = SimpleApi(None, None)\n        assert api.get_os_hypervisors_detail() == common.EXAMPLE_GET_OS_HYPERVISORS_RETURN_VALUE\n\n    with mock.patch('datadog_checks.openstack_controller.api.SimpleApi._make_request',\n                    side_effect=get_os_hypervisors_detail_post_v2_53_response):\n        api = SimpleApi(None, None)\n        assert api.get_os_hypervisors_detail() == [\n            {\n                \"cpu_info\": {\n                    \"arch\": \"x86_64\",\n                    \"model\": \"Nehalem\",\n                    \"vendor\": \"Intel\",\n                    \"features\": [\n                        \"pge\",\n                        \"clflush\"\n                    ],\n                    \"topology\": {\n                        \"cores\": 1,\n                        \"threads\": 1,\n                        \"sockets\": 4\n                    }\n                },\n                \"current_workload\": 0,\n                \"status\": \"enabled\",\n                \"state\": \"up\",\n                \"disk_available_least\": 0,\n                \"host_ip\": \"1.1.1.1\",\n                \"free_disk_gb\": 1028,\n                \"free_ram_mb\": 7680,\n                \"hypervisor_hostname\": \"host2\",\n                \"hypervisor_type\": \"fake\",\n                \"hypervisor_version\": 1000,\n                \"id\": \"1bb62a04-c576-402c-8147-9e89757a09e3\",\n                \"local_gb\": 1028,\n                \"local_gb_used\": 0,\n                \"memory_mb\": 8192,\n                \"memory_mb_used\": 512,\n                \"running_vms\": 0,\n                \"service\": {\n                    \"host\": \"host1\",\n                    \"id\": \"62f62f6e-a713-4cbe-87d3-3ecf8a1e0f8d\",\n                    \"disabled_reason\": None\n                },\n                \"vcpus\": 2,\n                \"vcpus_used\": 0\n            }]\n\n\ndef get_servers_detail_post_v2_63_response(url, headers, params=None, timeout=None):\n    return json.loads(\"\"\"{\n        \"servers\": [\n            {\n                \"OS-DCF:diskConfig\": \"AUTO\",\n                \"OS-EXT-AZ:availability_zone\": \"nova\",\n                \"OS-EXT-SRV-ATTR:host\": \"compute\",\n                \"OS-EXT-SRV-ATTR:hostname\": \"new-server-test\",\n                \"OS-EXT-SRV-ATTR:hypervisor_hostname\": \"fake-mini\",\n                \"OS-EXT-SRV-ATTR:instance_name\": \"instance-00000001\",\n                \"OS-EXT-SRV-ATTR:kernel_id\": \"\",\n                \"OS-EXT-SRV-ATTR:launch_index\": 0,\n                \"OS-EXT-SRV-ATTR:ramdisk_id\": \"\",\n                \"OS-EXT-SRV-ATTR:reservation_id\": \"r-y0w4v32k\",\n                \"OS-EXT-SRV-ATTR:root_device_name\": \"/dev/sda\",\n                \"OS-EXT-SRV-ATTR:user_data\": \"IyEvYmluL2Jhc2gKL2Jpbi9zdQplY2hvICJJIGFtIGluIHlvdSEiCg==\",\n                \"OS-EXT-STS:power_state\": 1,\n                \"OS-EXT-STS:task_state\": null,\n                \"OS-EXT-STS:vm_state\": \"active\",\n                \"OS-SRV-USG:launched_at\": \"2017-10-10T15:49:09.516729\",\n                \"OS-SRV-USG:terminated_at\": null,\n                \"accessIPv4\": \"1.2.3.4\",\n                \"accessIPv6\": \"80fe::\",\n                \"addresses\": {\n                    \"private\": [\n                        {\n                            \"OS-EXT-IPS-MAC:mac_addr\": \"aa:bb:cc:dd:ee:ff\",\n                            \"OS-EXT-IPS:type\": \"fixed\",\n                            \"addr\": \"192.168.0.3\",\n                            \"version\": 4\n                        }\n                    ]\n                },\n                \"config_drive\": \"\",\n                \"created\": \"2017-10-10T15:49:08Z\",\n                \"description\": null,\n                \"flavor\": {\n                    \"disk\": 1,\n                    \"ephemeral\": 0,\n                    \"extra_specs\": {\n                        \"hw:cpu_policy\": \"dedicated\",\n                        \"hw:mem_page_size\": \"2048\"\n                    },\n                    \"original_name\": \"m1.tiny.specs\",\n                    \"ram\": 512,\n                    \"swap\": 0,\n                    \"vcpus\": 1\n                },\n                \"hostId\": \"2091634baaccdc4c5a1d57069c833e402921df696b7f970791b12ec6\",\n                \"host_status\": \"UP\",\n                \"id\": \"569f39f9-7c76-42a1-9c2d-8394e2638a6d\",\n                \"image\": {\n                    \"id\": \"70a599e0-31e7-49b7-b260-868f441e862b\",\n                    \"links\": [\n                        {\n                            \"href\": \"http://openstack.example.com/6f70656e737461636b20342065766572/images/70a599e0-31e7-49b7-b260-868f441e862b\",\n                            \"rel\": \"bookmark\"\n                        }\n                    ]\n                },\n                \"key_name\": null,\n                \"links\": [\n                    {\n                        \"href\": \"http://openstack.example.com/v2.1/6f70656e737461636b20342065766572/servers/569f39f9-7c76-42a1-9c2d-8394e2638a6d\",\n                        \"rel\": \"self\"\n                    },\n                    {\n                        \"href\": \"http://openstack.example.com/6f70656e737461636b20342065766572/servers/569f39f9-7c76-42a1-9c2d-8394e2638a6d\",\n                        \"rel\": \"bookmark\"\n                    }\n                ],\n                \"locked\": false,\n                \"metadata\": {\n                    \"My Server Name\": \"Apache1\"\n                },\n                \"name\": \"new-server-test\",\n                \"os-extended-volumes:volumes_attached\": [],\n                \"progress\": 0,\n                \"security_groups\": [\n                    {\n                        \"name\": \"default\"\n                    }\n                ],\n                \"status\": \"ACTIVE\",\n                \"tags\": [],\n                \"tenant_id\": \"6f70656e737461636b20342065766572\",\n                \"trusted_image_certificates\": [\n                    \"0b5d2c72-12cc-4ba6-a8d7-3ff5cc1d8cb8\",\n                    \"674736e3-f25c-405c-8362-bbf991e0ce0a\"\n                ],\n                \"updated\": \"2017-10-10T15:49:09Z\",\n                \"user_id\": \"fake\"\n            }\n        ]\n    }\"\"\")  # noqa: E501\n\n\ndef test_get_servers_detail(aggregator):\n    with mock.patch('datadog_checks.openstack_controller.api.SimpleApi._make_request',\n                    side_effect=get_servers_detail_post_v2_63_response):\n        api = SimpleApi(None, None)\n        assert api.get_servers_detail(None) == [\n            {\n                \"OS-DCF:diskConfig\": \"AUTO\",\n                \"OS-EXT-AZ:availability_zone\": \"nova\",\n                \"OS-EXT-SRV-ATTR:host\": \"compute\",\n                \"OS-EXT-SRV-ATTR:hostname\": \"new-server-test\",\n                \"OS-EXT-SRV-ATTR:hypervisor_hostname\": \"fake-mini\",\n                \"OS-EXT-SRV-ATTR:instance_name\": \"instance-00000001\",\n                \"OS-EXT-SRV-ATTR:kernel_id\": \"\",\n                \"OS-EXT-SRV-ATTR:launch_index\": 0,\n                \"OS-EXT-SRV-ATTR:ramdisk_id\": \"\",\n                \"OS-EXT-SRV-ATTR:reservation_id\": \"r-y0w4v32k\",\n                \"OS-EXT-SRV-ATTR:root_device_name\": \"/dev/sda\",\n                \"OS-EXT-SRV-ATTR:user_data\": \"IyEvYmluL2Jhc2gKL2Jpbi9zdQplY2hvICJJIGFtIGluIHlvdSEiCg==\",\n                \"OS-EXT-STS:power_state\": 1,\n                \"OS-EXT-STS:task_state\": None,\n                \"OS-EXT-STS:vm_state\": \"active\",\n                \"OS-SRV-USG:launched_at\": \"2017-10-10T15:49:09.516729\",\n                \"OS-SRV-USG:terminated_at\": None,\n                \"accessIPv4\": \"1.2.3.4\",\n                \"accessIPv6\": \"80fe::\",\n                \"addresses\": {\n                    \"private\": [\n                        {\n                            \"OS-EXT-IPS-MAC:mac_addr\": \"aa:bb:cc:dd:ee:ff\",\n                            \"OS-EXT-IPS:type\": \"fixed\",\n                            \"addr\": \"192.168.0.3\",\n                            \"version\": 4\n                        }\n                    ]\n                },\n                \"config_drive\": \"\",\n                \"created\": \"2017-10-10T15:49:08Z\",\n                \"description\": None,\n                \"flavor\": {\n                    \"disk\": 1,\n                    \"ephemeral\": 0,\n                    \"extra_specs\": {\n                        \"hw:cpu_policy\": \"dedicated\",\n                        \"hw:mem_page_size\": \"2048\"\n                    },\n                    \"original_name\": \"m1.tiny.specs\",\n                    \"ram\": 512,\n                    \"swap\": 0,\n                    \"vcpus\": 1\n                },\n                \"hostId\": \"2091634baaccdc4c5a1d57069c833e402921df696b7f970791b12ec6\",\n                \"host_status\": \"UP\",\n                \"id\": \"569f39f9-7c76-42a1-9c2d-8394e2638a6d\",\n                \"image\": {\n                    \"id\": \"70a599e0-31e7-49b7-b260-868f441e862b\",\n                    \"links\": [\n                        {\n                            \"href\": \"http://openstack.example.com/6f70656e737461636b20342065766572/images/70a599e0-31e7-49b7-b260-868f441e862b\",  # noqa: E501\n                            \"rel\": \"bookmark\"\n                        }\n                    ]\n                },\n                \"key_name\": None,\n                \"links\": [\n                    {\n                        \"href\": \"http://openstack.example.com/v2.1/6f70656e737461636b20342065766572/servers/569f39f9-7c76-42a1-9c2d-8394e2638a6d\",  # noqa: E501\n                        \"rel\": \"self\"\n                    },\n                    {\n                        \"href\": \"http://openstack.example.com/6f70656e737461636b20342065766572/servers/569f39f9-7c76-42a1-9c2d-8394e2638a6d\",  # noqa: E501\n                        \"rel\": \"bookmark\"\n                    }\n                ],\n                \"locked\": False,\n                \"metadata\": {\n                    \"My Server Name\": \"Apache1\"\n                },\n                \"name\": \"new-server-test\",\n                \"os-extended-volumes:volumes_attached\": [],\n                \"progress\": 0,\n                \"security_groups\": [\n                    {\n                        \"name\": \"default\"\n                    }\n                ],\n                \"status\": \"ACTIVE\",\n                \"tags\": [],\n                \"tenant_id\": \"6f70656e737461636b20342065766572\",\n                \"trusted_image_certificates\": [\n                    \"0b5d2c72-12cc-4ba6-a8d7-3ff5cc1d8cb8\",\n                    \"674736e3-f25c-405c-8362-bbf991e0ce0a\"\n                ],\n                \"updated\": \"2017-10-10T15:49:09Z\",\n                \"user_id\": \"fake\"\n            }\n        ]\n\n\ndef test__get_paginated_list():\n\n    log = mock.MagicMock()\n\n    instance = copy.deepcopy(common.MOCK_CONFIG[\"instances\"][0])\n    instance[\"paginated_limit\"] = 4\n\n    with mock.patch(\"datadog_checks.openstack_controller.api.SimpleApi.connect\"):\n        api = ApiFactory.create(log, None, instance)\n    with mock.patch(\n        \"datadog_checks.openstack_controller.api.SimpleApi._make_request\",\n        side_effect=[\n            # First call: 3 exceptions -> failure\n            requests.exceptions.HTTPError,\n            requests.exceptions.HTTPError,\n            requests.exceptions.HTTPError,\n        ]\n    ):\n        # First call\n        with pytest.raises(RetryLimitExceeded):\n            api._get_paginated_list(\"url\", \"obj\", {})\n        assert log.debug.call_count == 3\n        log.reset_mock()\n\n    with mock.patch(\n        \"datadog_checks.openstack_controller.api.SimpleApi._make_request\",\n        side_effect=[\n            # Second call: all good, 1 page with 4 results, one with 1\n            {\n                \"obj\": [{\"id\": 0}, {\"id\": 1}, {\"id\": 2}, {\"id\": 3}],\n                \"obj_links\": \"test\"\n            },\n            {\n                \"obj\": [{\"id\": 4}]\n            },\n        ]\n    ):\n        # Second call\n        assert api.paginated_limit == 4\n        result = api._get_paginated_list(\"url\", \"obj\", {})\n        assert log.debug.call_count == 0\n        assert result == [{\"id\": 0}, {\"id\": 1}, {\"id\": 2}, {\"id\": 3}, {\"id\": 4}]\n\n    with mock.patch(\n        \"datadog_checks.openstack_controller.api.SimpleApi._make_request\",\n        side_effect=[\n            # Third call: 1 exception, limit is divided once by 2\n            requests.exceptions.HTTPError,\n            {\n                \"obj\": [{\"id\": 0}, {\"id\": 1}],\n                \"obj_links\": \"test\"\n            },\n            {\n                \"obj\": [{\"id\": 2}, {\"id\": 3}],\n                \"obj_links\": \"test\"\n            },\n            {\n                \"obj\": [{\"id\": 4}]\n            }\n        ]\n    ):\n        # Third call\n        result = api._get_paginated_list(\"url\", \"obj\", {})\n        assert log.debug.call_count == 1\n        assert result == [{\"id\": 0}, {\"id\": 1}, {\"id\": 2}, {\"id\": 3}, {\"id\": 4}]\n        log.reset_mock()\n\n    with mock.patch(\n        \"datadog_checks.openstack_controller.api.SimpleApi._make_request\",\n        side_effect=[\n            # Fourth call: 1 AuthenticationNeeded exception -> no retries\n            AuthenticationNeeded,\n            # Fifth call: any other exception -> no retries\n            Exception,\n        ]\n    ):\n        with pytest.raises(AuthenticationNeeded):\n            api._get_paginated_list(\"url\", \"obj\", {})\n        with pytest.raises(Exception):\n            api._get_paginated_list(\"url\", \"obj\", {})\n\n\ndef test__make_request_failure():\n    log = mock.MagicMock()\n\n    instance = copy.deepcopy(common.MOCK_CONFIG[\"instances\"][0])\n    instance[\"paginated_limit\"] = 4\n\n    with mock.patch(\"datadog_checks.openstack_controller.api.SimpleApi.connect\"):\n        api = ApiFactory.create(log, None, instance)\n\n    response_mock = mock.MagicMock()\n    with mock.patch(\n        \"datadog_checks.openstack_controller.api.requests.get\",\n        return_value=response_mock\n    ):\n        response_mock.raise_for_status.side_effect = requests.exceptions.HTTPError\n        response_mock.status_code = 401\n        with pytest.raises(AuthenticationNeeded):\n            api._make_request(\"\", {})\n\n        response_mock.status_code = 409\n        with pytest.raises(InstancePowerOffFailure):\n            api._make_request(\"\", {})\n\n        response_mock.status_code = 500\n        with pytest.raises(requests.exceptions.HTTPError):\n            api._make_request(\"\", {})\n\n        response_mock.raise_for_status.side_effect = Exception\n        with pytest.raises(Exception):\n            api._make_request(\"\", {})\n\n\ndef get_server_diagnostics_post_v2_48_response(url, headers, params=None, timeout=None):\n    return json.loads(\"\"\"{\n        \"config_drive\": true,\n        \"cpu_details\": [\n            {\n                \"id\": 0,\n                \"time\": 17300000000,\n                \"utilisation\": 15\n            }\n        ],\n        \"disk_details\": [\n            {\n                \"errors_count\": 1,\n                \"read_bytes\": 262144,\n                \"read_requests\": 112,\n                \"write_bytes\": 5778432,\n                \"write_requests\": 488\n            }\n        ],\n        \"driver\": \"libvirt\",\n        \"hypervisor\": \"kvm\",\n        \"hypervisor_os\": \"ubuntu\",\n        \"memory_details\": {\n            \"maximum\": 524288,\n            \"used\": 0\n        },\n        \"nic_details\": [\n            {\n                \"mac_address\": \"01:23:45:67:89:ab\",\n                \"rx_drop\": 200,\n                \"rx_errors\": 100,\n                \"rx_octets\": 2070139,\n                \"rx_packets\": 26701,\n                \"rx_rate\": 300,\n                \"tx_drop\": 500,\n                \"tx_errors\": 400,\n                \"tx_octets\": 140208,\n                \"tx_packets\": 662,\n                \"tx_rate\": 600\n            }\n        ],\n        \"num_cpus\": 1,\n        \"num_disks\": 1,\n        \"num_nics\": 1,\n        \"state\": \"running\",\n        \"uptime\": 46664\n    }\"\"\")\n\n\ndef get_server_diagnostics_post_v2_1_response(url, headers, params=None, timeout=None):\n    return json.loads(\"\"\"{\n        \"cpu0_time\": 17300000000,\n        \"memory\": 524288,\n        \"vda_errors\": -1,\n        \"vda_read\": 262144,\n        \"vda_read_req\": 112,\n        \"vda_write\": 5778432,\n        \"vda_write_req\": 488,\n        \"vnet1_rx\": 2070139,\n        \"vnet1_rx_drop\": 0,\n        \"vnet1_rx_errors\": 0,\n        \"vnet1_rx_packets\": 26701,\n        \"vnet1_tx\": 140208,\n        \"vnet1_tx_drop\": 0,\n        \"vnet1_tx_errors\": 0,\n        \"vnet1_tx_packets\": 662\n    }\"\"\")\n\n\ndef test_get_server_diagnostics(aggregator):\n    with mock.patch('datadog_checks.openstack_controller.api.SimpleApi._make_request',\n                    side_effect=get_server_diagnostics_post_v2_48_response):\n        api = SimpleApi(None, None)\n        assert api.get_server_diagnostics(None) == {\n            \"config_drive\": True,\n            \"cpu_details\": [\n                {\n                    \"id\": 0,\n                    \"time\": 17300000000,\n                    \"utilisation\": 15\n                }\n            ],\n            \"disk_details\": [\n                {\n                    \"errors_count\": 1,\n                    \"read_bytes\": 262144,\n                    \"read_requests\": 112,\n                    \"write_bytes\": 5778432,\n                    \"write_requests\": 488\n                }\n            ],\n            \"driver\": \"libvirt\",\n            \"hypervisor\": \"kvm\",\n            \"hypervisor_os\": \"ubuntu\",\n            \"memory_details\": {\n                \"maximum\": 524288,\n                \"used\": 0\n            },\n            \"nic_details\": [\n                {\n                    \"mac_address\": \"01:23:45:67:89:ab\",\n                    \"rx_drop\": 200,\n                    \"rx_errors\": 100,\n                    \"rx_octets\": 2070139,\n                    \"rx_packets\": 26701,\n                    \"rx_rate\": 300,\n                    \"tx_drop\": 500,\n                    \"tx_errors\": 400,\n                    \"tx_octets\": 140208,\n                    \"tx_packets\": 662,\n                    \"tx_rate\": 600\n                }\n            ],\n            \"num_cpus\": 1,\n            \"num_disks\": 1,\n            \"num_nics\": 1,\n            \"state\": \"running\",\n            \"uptime\": 46664\n        }\n\n    with mock.patch('datadog_checks.openstack_controller.api.SimpleApi._make_request',\n                    side_effect=get_server_diagnostics_post_v2_1_response):\n        api = SimpleApi(None, None)\n        assert api.get_server_diagnostics(None) == {\n            \"cpu0_time\": 17300000000,\n            \"memory\": 524288,\n            \"vda_errors\": -1,\n            \"vda_read\": 262144,\n            \"vda_read_req\": 112,\n            \"vda_write\": 5778432,\n            \"vda_write_req\": 488,\n            \"vnet1_rx\": 2070139,\n            \"vnet1_rx_drop\": 0,\n            \"vnet1_rx_errors\": 0,\n            \"vnet1_rx_packets\": 26701,\n            \"vnet1_tx\": 140208,\n            \"vnet1_tx_drop\": 0,\n            \"vnet1_tx_errors\": 0,\n            \"vnet1_tx_packets\": 662\n        }\n\n\ndef get_project_limits_response(url, headers, params=None, timeout=None):\n    return json.loads(\"\"\"{\n        \"limits\": {\n            \"absolute\": {\n                \"maxImageMeta\": 128,\n                \"maxPersonality\": 5,\n                \"maxPersonalitySize\": 10240,\n                \"maxSecurityGroupRules\": 20,\n                \"maxSecurityGroups\": 10,\n                \"maxServerMeta\": 128,\n                \"maxTotalCores\": 20,\n                \"maxTotalFloatingIps\": 10,\n                \"maxTotalInstances\": 10,\n                \"maxTotalKeypairs\": 100,\n                \"maxTotalRAMSize\": 51200,\n                \"maxServerGroups\": 10,\n                \"maxServerGroupMembers\": 10,\n                \"totalCoresUsed\": 0,\n                \"totalInstancesUsed\": 0,\n                \"totalRAMUsed\": 0,\n                \"totalSecurityGroupsUsed\": 0,\n                \"totalFloatingIpsUsed\": 0,\n                \"totalServerGroupsUsed\": 0\n            },\n            \"rate\": []\n        }\n    }\"\"\")\n\n\ndef test_get_project_limits(aggregator):\n    with mock.patch('datadog_checks.openstack_controller.api.SimpleApi._make_request',\n                    side_effect=get_project_limits_response):\n        api = SimpleApi(None, None)\n        assert api.get_project_limits(None) == common.EXAMPLE_GET_PROJECT_LIMITS_RETURN_VALUE\n        }\n        \n        \"\n        \"\n\n        }\n        \n        \n        \"\n        \"\n\n        \n        \"\n        \n        }\n        \"\n        \n        \"\n        \n        \"\n        \"\n",
    "after": "# (C) Datadog, Inc. 2018\n# All rights reserved\n# Licensed under Simplified BSD License (see LICENSE)\nimport mock\nimport logging\nimport copy\nimport pytest\nimport simplejson as json\n\nimport requests\n\nfrom datadog_checks.openstack_controller.api import ApiFactory, SimpleApi, Authenticator, Credential\nfrom datadog_checks.openstack_controller.exceptions import (\n    IncompleteIdentity,\n    MissingNovaEndpoint,\n    MissingNeutronEndpoint,\n    AuthenticationNeeded,\n    InstancePowerOffFailure,\n    RetryLimitExceeded,\n)\nfrom . import common\n\nlog = logging.getLogger('test_openstack_controller')\n\n\ndef test_get_endpoint():\n    authenticator = Authenticator()\n    assert authenticator._get_nova_endpoint(\n        common.EXAMPLE_AUTH_RESPONSE) == u'http://10.0.2.15:8774/v2.1/0850707581fe4d738221a72db0182876'\n    with pytest.raises(MissingNovaEndpoint):\n        authenticator._get_nova_endpoint({})\n\n    assert authenticator._get_neutron_endpoint(common.EXAMPLE_AUTH_RESPONSE) == u'http://10.0.2.15:9292'\n    with pytest.raises(MissingNeutronEndpoint):\n        authenticator._get_neutron_endpoint({})\n\n    assert authenticator._get_valid_endpoint({}, None, None) is None\n    assert authenticator._get_valid_endpoint({'token': {}}, None, None) is None\n    assert authenticator._get_valid_endpoint({'token': {\"catalog\": []}}, None, None) is None\n    assert authenticator._get_valid_endpoint({'token': {\"catalog\": []}}, None, None) is None\n    assert authenticator._get_valid_endpoint({'token': {\"catalog\": [{}]}}, None, None) is None\n    assert authenticator._get_valid_endpoint({'token': {\"catalog\": [{\n        u'type': u'compute',\n        u'name': u'nova'}]}}, None, None) is None\n    assert authenticator._get_valid_endpoint({'token': {\"catalog\": [{\n        u'endpoints': [],\n        u'type': u'compute',\n        u'name': u'nova'}]}}, None, None) is None\n    assert authenticator._get_valid_endpoint({'token': {\"catalog\": [{\n        u'endpoints': [{}],\n        u'type': u'compute',\n        u'name': u'nova'}]}}, 'nova', 'compute') is None\n    assert authenticator._get_valid_endpoint({'token': {\"catalog\": [{\n        u'endpoints': [{u'url': u'dummy_url', u'interface': u'dummy'}],\n        u'type': u'compute',\n        u'name': u'nova'}]}}, 'nova', 'compute') is None\n    assert authenticator._get_valid_endpoint({'token': {\"catalog\": [{\n        u'endpoints': [{u'url': u'dummy_url'}],\n        u'type': u'compute',\n        u'name': u'nova'}]}}, 'nova', 'compute') is None\n    assert authenticator._get_valid_endpoint({'token': {\"catalog\": [{\n        u'endpoints': [{u'interface': u'public'}],\n        u'type': u'compute',\n        u'name': u'nova'}]}}, 'nova', 'compute') is None\n    assert authenticator._get_valid_endpoint({'token': {\"catalog\": [{\n        u'endpoints': [{u'url': u'dummy_url', u'interface': u'internal'}],\n        u'type': u'compute',\n        u'name': u'nova'}]}}, 'nova', 'compute') == 'dummy_url'\n\n\nBAD_USERS = [\n    {'user': {}},\n    {'user': {'name': ''}},\n    {'user': {'name': 'test_name', 'password': ''}},\n    {'user': {'name': 'test_name', 'password': 'test_pass', 'domain': {}}},\n    {'user': {'name': 'test_name', 'password': 'test_pass', 'domain': {'id': ''}}},\n]\n\nGOOD_USERS = [\n    {'user': {'name': 'test_name', 'password': 'test_pass', 'domain': {'id': 'test_id'}}},\n]\n\n\ndef _test_bad_user(user):\n    authenticator = Authenticator()\n    with pytest.raises(IncompleteIdentity):\n        authenticator._get_user_identity(user['user'])\n\n\ndef test_get_user_identity():\n    authenticator = Authenticator()\n    for user in BAD_USERS:\n        _test_bad_user(user)\n\n    for user in GOOD_USERS:\n        parsed_user = authenticator._get_user_identity(user['user'])\n        assert parsed_user == {'methods': ['password'], 'password': user}\n\n\nclass MockHTTPResponse(object):\n    def __init__(self, response_dict, headers):\n        self.response_dict = response_dict\n        self.headers = headers\n\n    def json(self):\n        return self.response_dict\n\n\nPROJECTS_RESPONSE = [\n        {},\n        {\n            \"domain_id\": \"0000\",\n        },\n        {\n            \"domain_id\": \"1111\",\n            \"id\": \"0000\",\n        },\n        {\n            \"domain_id\": \"2222\",\n            \"id\": \"1111\",\n            \"name\": \"name 1\"\n        },\n        {\n            \"domain_id\": \"3333\",\n            \"id\": \"2222\",\n            \"name\": \"name 2\"\n        },\n    ]\n\nPROJECT_RESPONSE = [\n        {\n            \"domain_id\": \"1111\",\n            \"id\": \"3333\",\n            \"name\": \"name 1\"\n        }\n    ]\n\n\ndef test_from_config():\n    mock_http_response = copy.deepcopy(common.EXAMPLE_AUTH_RESPONSE)\n    mock_response = MockHTTPResponse(response_dict=mock_http_response, headers={'X-Subject-Token': 'fake_token'})\n\n    with mock.patch('datadog_checks.openstack_controller.api.Authenticator._post_auth_token',\n                    return_value=mock_response):\n        with mock.patch('datadog_checks.openstack_controller.api.Authenticator._get_auth_projects',\n                        return_value=PROJECTS_RESPONSE):\n            cred = Authenticator.from_config(log, 'http://10.0.2.15:5000', GOOD_USERS[0]['user'])\n            assert isinstance(cred, Credential)\n            assert cred.auth_token == \"fake_token\"\n            assert cred.name == \"name 2\"\n            assert cred.domain_id == \"3333\"\n            assert cred.tenant_id == \"2222\"\n            assert cred.nova_endpoint == \"http://10.0.2.15:8774/v2.1/0850707581fe4d738221a72db0182876\"\n            assert cred.neutron_endpoint == \"http://10.0.2.15:9292\"\n\n\ndef test_from_config_with_missing_name():\n    mock_http_response = copy.deepcopy(common.EXAMPLE_AUTH_RESPONSE)\n    mock_response = MockHTTPResponse(response_dict=mock_http_response, headers={'X-Subject-Token': 'fake_token'})\n\n    project_response_without_name = copy.deepcopy(PROJECT_RESPONSE)\n    del project_response_without_name[0][\"name\"]\n\n    with mock.patch('datadog_checks.openstack_controller.api.Authenticator._post_auth_token',\n                    return_value=mock_response):\n        with mock.patch('datadog_checks.openstack_controller.api.Authenticator._get_auth_projects',\n                        return_value=project_response_without_name):\n            cred = Authenticator.from_config(log, 'http://10.0.2.15:5000', GOOD_USERS[0]['user'])\n            assert cred is None\n\n\ndef test_from_config_with_missing_id():\n    mock_http_response = copy.deepcopy(common.EXAMPLE_AUTH_RESPONSE)\n    mock_response = MockHTTPResponse(response_dict=mock_http_response, headers={'X-Subject-Token': 'fake_token'})\n\n    project_response_without_name = copy.deepcopy(PROJECT_RESPONSE)\n    del project_response_without_name[0][\"id\"]\n\n    with mock.patch('datadog_checks.openstack_controller.api.Authenticator._post_auth_token',\n                    return_value=mock_response):\n        with mock.patch('datadog_checks.openstack_controller.api.Authenticator._get_auth_projects',\n                        return_value=project_response_without_name):\n            cred = Authenticator.from_config(log, 'http://10.0.2.15:5000', GOOD_USERS[0]['user'])\n            assert cred is None\n\n\ndef get_os_hypervisor_uptime_pre_v2_52_response(url, header, params=None, timeout=None):\n    return json.loads(\"\"\"{\n        \"hypervisor\": {\n            \"hypervisor_hostname\": \"fake-mini\",\n            \"id\": 1,\n            \"state\": \"up\",\n            \"status\": \"enabled\",\n            \"uptime\": \" 08:32:11 up 93 days, 18:25, 12 users,  load average: 0.20, 0.12, 0.14\"\n        }\n    }\"\"\")\n\n\ndef get_os_hypervisor_uptime_post_v2_53_response(url, header, params=None, timeout=None):\n    return json.loads(\"\"\"{\n        \"hypervisor\": {\n            \"hypervisor_hostname\": \"fake-mini\",\n            \"id\": \"b1e43b5f-eec1-44e0-9f10-7b4945c0226d\",\n            \"state\": \"up\",\n            \"status\": \"enabled\",\n            \"uptime\": \" 08:32:11 up 93 days, 18:25, 12 users,  load average: 0.20, 0.12, 0.14\"\n        }\n    }\"\"\")\n\n\ndef test_get_os_hypervisor_uptime(aggregator):\n    with mock.patch('datadog_checks.openstack_controller.api.SimpleApi._make_request',\n                    side_effect=get_os_hypervisor_uptime_pre_v2_52_response):\n        api = SimpleApi(None, None)\n        assert api.get_os_hypervisor_uptime(1) == \\\n            \" 08:32:11 up 93 days, 18:25, 12 users,  load average: 0.20, 0.12, 0.14\"\n\n    with mock.patch('datadog_checks.openstack_controller.api.SimpleApi._make_request',\n                    side_effect=get_os_hypervisor_uptime_post_v2_53_response):\n        api = SimpleApi(None, None)\n        assert api.get_os_hypervisor_uptime(1) == \\\n            \" 08:32:11 up 93 days, 18:25, 12 users,  load average: 0.20, 0.12, 0.14\"\n\n\ndef get_os_aggregates_response(url, headers, params=None, timeout=None):\n    return json.loads(\"\"\"{\n        \"aggregates\": [\n            {\n                \"availability_zone\": \"london\",\n                \"created_at\": \"2016-12-27T23:47:32.911515\",\n                \"deleted\": false,\n                \"deleted_at\": null,\n                \"hosts\": [\n                    \"compute\"\n                ],\n                \"id\": 1,\n                \"metadata\": {\n                    \"availability_zone\": \"london\"\n                },\n                \"name\": \"name\",\n                \"updated_at\": null,\n                \"uuid\": \"6ba28ba7-f29b-45cc-a30b-6e3a40c2fb14\"\n            }\n        ]\n    }\"\"\")\n\n\ndef test_get_os_aggregates(aggregator):\n    with mock.patch('datadog_checks.openstack_controller.api.SimpleApi._make_request',\n                    side_effect=get_os_aggregates_response):\n        api = SimpleApi(None, None)\n\n        aggregates = api.get_os_aggregates()\n\n        for i in range(len(aggregates)):\n            for key, value in common.EXAMPLE_GET_OS_AGGREGATES_RETURN_VALUE[i].items():\n                assert value == aggregates[i][key]\n\n\ndef get_os_hypervisors_detail_post_v2_33_response(url, headers, params=None, timeout=None):\n    return json.loads(\"\"\"{\n        \"hypervisors\": [\n            {\n                \"cpu_info\": {\n                    \"arch\": \"x86_64\",\n                    \"model\": \"Nehalem\",\n                    \"vendor\": \"Intel\",\n                    \"features\": [\n                        \"pge\",\n                        \"clflush\"\n                    ],\n                    \"topology\": {\n                        \"cores\": 1,\n                        \"threads\": 1,\n                        \"sockets\": 4\n                    }\n                },\n                \"current_workload\": 0,\n                \"status\": \"enabled\",\n                \"state\": \"up\",\n                \"disk_available_least\": 0,\n                \"host_ip\": \"1.1.1.1\",\n                \"free_disk_gb\": 1028,\n                \"free_ram_mb\": 7680,\n                \"hypervisor_hostname\": \"host1\",\n                \"hypervisor_type\": \"fake\",\n                \"hypervisor_version\": 1000,\n                \"id\": 2,\n                \"local_gb\": 1028,\n                \"local_gb_used\": 0,\n                \"memory_mb\": 8192,\n                \"memory_mb_used\": 512,\n                \"running_vms\": 0,\n                \"service\": {\n                    \"host\": \"host1\",\n                    \"id\": 7,\n                    \"disabled_reason\": null\n                },\n                \"vcpus\": 2,\n                \"vcpus_used\": 0\n            }\n        ],\n        \"hypervisors_links\": [\n            {\n                \"href\": \"http://openstack.example.com/v2.1/6f70656e737461636b20342065766572/hypervisors/detail?limit=1&marker=2\",\n                \"rel\": \"next\"\n            }\n        ]\n    }\"\"\")  # noqa: E501\n\n\ndef get_os_hypervisors_detail_post_v2_53_response(url, headers, params=None, timeout=None):\n    return json.loads(\"\"\"{\n        \"hypervisors\": [\n            {\n                \"cpu_info\": {\n                    \"arch\": \"x86_64\",\n                    \"model\": \"Nehalem\",\n                    \"vendor\": \"Intel\",\n                    \"features\": [\n                        \"pge\",\n                        \"clflush\"\n                    ],\n                    \"topology\": {\n                        \"cores\": 1,\n                        \"threads\": 1,\n                        \"sockets\": 4\n                    }\n                },\n                \"current_workload\": 0,\n                \"status\": \"enabled\",\n                \"state\": \"up\",\n                \"disk_available_least\": 0,\n                \"host_ip\": \"1.1.1.1\",\n                \"free_disk_gb\": 1028,\n                \"free_ram_mb\": 7680,\n                \"hypervisor_hostname\": \"host2\",\n                \"hypervisor_type\": \"fake\",\n                \"hypervisor_version\": 1000,\n                \"id\": \"1bb62a04-c576-402c-8147-9e89757a09e3\",\n                \"local_gb\": 1028,\n                \"local_gb_used\": 0,\n                \"memory_mb\": 8192,\n                \"memory_mb_used\": 512,\n                \"running_vms\": 0,\n                \"service\": {\n                    \"host\": \"host1\",\n                    \"id\": \"62f62f6e-a713-4cbe-87d3-3ecf8a1e0f8d\",\n                    \"disabled_reason\": null\n                },\n                \"vcpus\": 2,\n                \"vcpus_used\": 0\n            }\n        ],\n        \"hypervisors_links\": [\n            {\n                \"href\": \"http://openstack.example.com/v2.1/6f70656e737461636b20342065766572/hypervisors/detail?limit=1&marker=1bb62a04-c576-402c-8147-9e89757a09e3\",\n                \"rel\": \"next\"\n            }\n        ]\n    }\"\"\")  # noqa: E501\n\n\ndef test_get_os_hypervisors_detail(aggregator):\n    with mock.patch('datadog_checks.openstack_controller.api.SimpleApi._make_request',\n                    side_effect=get_os_hypervisors_detail_post_v2_33_response):\n        api = SimpleApi(None, None)\n        assert api.get_os_hypervisors_detail() == common.EXAMPLE_GET_OS_HYPERVISORS_RETURN_VALUE\n\n    with mock.patch('datadog_checks.openstack_controller.api.SimpleApi._make_request',\n                    side_effect=get_os_hypervisors_detail_post_v2_53_response):\n        api = SimpleApi(None, None)\n        assert api.get_os_hypervisors_detail() == [\n            {\n                \"cpu_info\": {\n                    \"arch\": \"x86_64\",\n                    \"model\": \"Nehalem\",\n                    \"vendor\": \"Intel\",\n                    \"features\": [\n                        \"pge\",\n                        \"clflush\"\n                    ],\n                    \"topology\": {\n                        \"cores\": 1,\n                        \"threads\": 1,\n                        \"sockets\": 4\n                    }\n                },\n                \"current_workload\": 0,\n                \"status\": \"enabled\",\n                \"state\": \"up\",\n                \"disk_available_least\": 0,\n                \"host_ip\": \"1.1.1.1\",\n                \"free_disk_gb\": 1028,\n                \"free_ram_mb\": 7680,\n                \"hypervisor_hostname\": \"host2\",\n                \"hypervisor_type\": \"fake\",\n                \"hypervisor_version\": 1000,\n                \"id\": \"1bb62a04-c576-402c-8147-9e89757a09e3\",\n                \"local_gb\": 1028,\n                \"local_gb_used\": 0,\n                \"memory_mb\": 8192,\n                \"memory_mb_used\": 512,\n                \"running_vms\": 0,\n                \"service\": {\n                    \"host\": \"host1\",\n                    \"id\": \"62f62f6e-a713-4cbe-87d3-3ecf8a1e0f8d\",\n                    \"disabled_reason\": None\n                },\n                \"vcpus\": 2,\n                \"vcpus_used\": 0\n            }]\n\n\ndef get_servers_detail_post_v2_63_response(url, headers, params=None, timeout=None):\n    return json.loads(\"\"\"{\n        \"servers\": [\n            {\n                \"OS-DCF:diskConfig\": \"AUTO\",\n                \"OS-EXT-AZ:availability_zone\": \"nova\",\n                \"OS-EXT-SRV-ATTR:host\": \"compute\",\n                \"OS-EXT-SRV-ATTR:hostname\": \"new-server-test\",\n                \"OS-EXT-SRV-ATTR:hypervisor_hostname\": \"fake-mini\",\n                \"OS-EXT-SRV-ATTR:instance_name\": \"instance-00000001\",\n                \"OS-EXT-SRV-ATTR:kernel_id\": \"\",\n                \"OS-EXT-SRV-ATTR:launch_index\": 0,\n                \"OS-EXT-SRV-ATTR:ramdisk_id\": \"\",\n                \"OS-EXT-SRV-ATTR:reservation_id\": \"r-y0w4v32k\",\n                \"OS-EXT-SRV-ATTR:root_device_name\": \"/dev/sda\",\n                \"OS-EXT-SRV-ATTR:user_data\": \"IyEvYmluL2Jhc2gKL2Jpbi9zdQplY2hvICJJIGFtIGluIHlvdSEiCg==\",\n                \"OS-EXT-STS:power_state\": 1,\n                \"OS-EXT-STS:task_state\": null,\n                \"OS-EXT-STS:vm_state\": \"active\",\n                \"OS-SRV-USG:launched_at\": \"2017-10-10T15:49:09.516729\",\n                \"OS-SRV-USG:terminated_at\": null,\n                \"accessIPv4\": \"1.2.3.4\",\n                \"accessIPv6\": \"80fe::\",\n                \"addresses\": {\n                    \"private\": [\n                        {\n                            \"OS-EXT-IPS-MAC:mac_addr\": \"aa:bb:cc:dd:ee:ff\",\n                            \"OS-EXT-IPS:type\": \"fixed\",\n                            \"addr\": \"192.168.0.3\",\n                            \"version\": 4\n                        }\n                    ]\n                },\n                \"config_drive\": \"\",\n                \"created\": \"2017-10-10T15:49:08Z\",\n                \"description\": null,\n                \"flavor\": {\n                    \"disk\": 1,\n                    \"ephemeral\": 0,\n                    \"extra_specs\": {\n                        \"hw:cpu_policy\": \"dedicated\",\n                        \"hw:mem_page_size\": \"2048\"\n                    },\n                    \"original_name\": \"m1.tiny.specs\",\n                    \"ram\": 512,\n                    \"swap\": 0,\n                    \"vcpus\": 1\n                },\n                \"hostId\": \"2091634baaccdc4c5a1d57069c833e402921df696b7f970791b12ec6\",\n                \"host_status\": \"UP\",\n                \"id\": \"569f39f9-7c76-42a1-9c2d-8394e2638a6d\",\n                \"image\": {\n                    \"id\": \"70a599e0-31e7-49b7-b260-868f441e862b\",\n                    \"links\": [\n                        {\n                            \"href\": \"http://openstack.example.com/6f70656e737461636b20342065766572/images/70a599e0-31e7-49b7-b260-868f441e862b\",\n                            \"rel\": \"bookmark\"\n                        }\n                    ]\n                },\n                \"key_name\": null,\n                \"links\": [\n                    {\n                        \"href\": \"http://openstack.example.com/v2.1/6f70656e737461636b20342065766572/servers/569f39f9-7c76-42a1-9c2d-8394e2638a6d\",\n                        \"rel\": \"self\"\n                    },\n                    {\n                        \"href\": \"http://openstack.example.com/6f70656e737461636b20342065766572/servers/569f39f9-7c76-42a1-9c2d-8394e2638a6d\",\n                        \"rel\": \"bookmark\"\n                    }\n                ],\n                \"locked\": false,\n                \"metadata\": {\n                    \"My Server Name\": \"Apache1\"\n                },\n                \"name\": \"new-server-test\",\n                \"os-extended-volumes:volumes_attached\": [],\n                \"progress\": 0,\n                \"security_groups\": [\n                    {\n                        \"name\": \"default\"\n                    }\n                ],\n                \"status\": \"ACTIVE\",\n                \"tags\": [],\n                \"tenant_id\": \"6f70656e737461636b20342065766572\",\n                \"trusted_image_certificates\": [\n                    \"0b5d2c72-12cc-4ba6-a8d7-3ff5cc1d8cb8\",\n                    \"674736e3-f25c-405c-8362-bbf991e0ce0a\"\n                ],\n                \"updated\": \"2017-10-10T15:49:09Z\",\n                \"user_id\": \"fake\"\n            }\n        ]\n    }\"\"\")  # noqa: E501\n\n\ndef test_get_servers_detail(aggregator):\n    with mock.patch('datadog_checks.openstack_controller.api.SimpleApi._make_request',\n                    side_effect=get_servers_detail_post_v2_63_response):\n        api = SimpleApi(None, None)\n        assert api.get_servers_detail(None) == [\n            {\n                \"OS-DCF:diskConfig\": \"AUTO\",\n                \"OS-EXT-AZ:availability_zone\": \"nova\",\n                \"OS-EXT-SRV-ATTR:host\": \"compute\",\n                \"OS-EXT-SRV-ATTR:hostname\": \"new-server-test\",\n                \"OS-EXT-SRV-ATTR:hypervisor_hostname\": \"fake-mini\",\n                \"OS-EXT-SRV-ATTR:instance_name\": \"instance-00000001\",\n                \"OS-EXT-SRV-ATTR:kernel_id\": \"\",\n                \"OS-EXT-SRV-ATTR:launch_index\": 0,\n                \"OS-EXT-SRV-ATTR:ramdisk_id\": \"\",\n                \"OS-EXT-SRV-ATTR:reservation_id\": \"r-y0w4v32k\",\n                \"OS-EXT-SRV-ATTR:root_device_name\": \"/dev/sda\",\n                \"OS-EXT-SRV-ATTR:user_data\": \"IyEvYmluL2Jhc2gKL2Jpbi9zdQplY2hvICJJIGFtIGluIHlvdSEiCg==\",\n                \"OS-EXT-STS:power_state\": 1,\n                \"OS-EXT-STS:task_state\": None,\n                \"OS-EXT-STS:vm_state\": \"active\",\n                \"OS-SRV-USG:launched_at\": \"2017-10-10T15:49:09.516729\",\n                \"OS-SRV-USG:terminated_at\": None,\n                \"accessIPv4\": \"1.2.3.4\",\n                \"accessIPv6\": \"80fe::\",\n                \"addresses\": {\n                    \"private\": [\n                        {\n                            \"OS-EXT-IPS-MAC:mac_addr\": \"aa:bb:cc:dd:ee:ff\",\n                            \"OS-EXT-IPS:type\": \"fixed\",\n                            \"addr\": \"192.168.0.3\",\n                            \"version\": 4\n                        }\n                    ]\n                },\n                \"config_drive\": \"\",\n                \"created\": \"2017-10-10T15:49:08Z\",\n                \"description\": None,\n                \"flavor\": {\n                    \"disk\": 1,\n                    \"ephemeral\": 0,\n                    \"extra_specs\": {\n                        \"hw:cpu_policy\": \"dedicated\",\n                        \"hw:mem_page_size\": \"2048\"\n                    },\n                    \"original_name\": \"m1.tiny.specs\",\n                    \"ram\": 512,\n                    \"swap\": 0,\n                    \"vcpus\": 1\n                },\n                \"hostId\": \"2091634baaccdc4c5a1d57069c833e402921df696b7f970791b12ec6\",\n                \"host_status\": \"UP\",\n                \"id\": \"569f39f9-7c76-42a1-9c2d-8394e2638a6d\",\n                \"image\": {\n                    \"id\": \"70a599e0-31e7-49b7-b260-868f441e862b\",\n                    \"links\": [\n                        {\n                            \"href\": \"http://openstack.example.com/6f70656e737461636b20342065766572/images/70a599e0-31e7-49b7-b260-868f441e862b\",  # noqa: E501\n                            \"rel\": \"bookmark\"\n                        }\n                    ]\n                },\n                \"key_name\": None,\n                \"links\": [\n                    {\n                        \"href\": \"http://openstack.example.com/v2.1/6f70656e737461636b20342065766572/servers/569f39f9-7c76-42a1-9c2d-8394e2638a6d\",  # noqa: E501\n                        \"rel\": \"self\"\n                    },\n                    {\n                        \"href\": \"http://openstack.example.com/6f70656e737461636b20342065766572/servers/569f39f9-7c76-42a1-9c2d-8394e2638a6d\",  # noqa: E501\n                        \"rel\": \"bookmark\"\n                    }\n                ],\n                \"locked\": False,\n                \"metadata\": {\n                    \"My Server Name\": \"Apache1\"\n                },\n                \"name\": \"new-server-test\",\n                \"os-extended-volumes:volumes_attached\": [],\n                \"progress\": 0,\n                \"security_groups\": [\n                    {\n                        \"name\": \"default\"\n                    }\n                ],\n                \"status\": \"ACTIVE\",\n                \"tags\": [],\n                \"tenant_id\": \"6f70656e737461636b20342065766572\",\n                \"trusted_image_certificates\": [\n                    \"0b5d2c72-12cc-4ba6-a8d7-3ff5cc1d8cb8\",\n                    \"674736e3-f25c-405c-8362-bbf991e0ce0a\"\n                ],\n                \"updated\": \"2017-10-10T15:49:09Z\",\n                \"user_id\": \"fake\"\n            }\n        ]\n\n\ndef test__get_paginated_list():\n\n    log = mock.MagicMock()\n\n    instance = copy.deepcopy(common.MOCK_CONFIG[\"instances\"][0])\n    instance[\"paginated_limit\"] = 4\n\n    with mock.patch(\"datadog_checks.openstack_controller.api.SimpleApi.connect\"):\n        api = ApiFactory.create(log, None, instance)\n    with mock.patch(\n        \"datadog_checks.openstack_controller.api.SimpleApi._make_request\",\n        side_effect=[\n            # First call: 3 exceptions -> failure\n            requests.exceptions.HTTPError,\n            requests.exceptions.HTTPError,\n            requests.exceptions.HTTPError,\n        ]\n    ):\n        # First call\n        with pytest.raises(RetryLimitExceeded):\n            api._get_paginated_list(\"url\", \"obj\", {})\n        assert log.debug.call_count == 3\n        log.reset_mock()\n\n    with mock.patch(\n        \"datadog_checks.openstack_controller.api.SimpleApi._make_request\",\n        side_effect=[\n            # Second call: all good, 1 page with 4 results, one with 1\n            {\n                \"obj\": [{\"id\": 0}, {\"id\": 1}, {\"id\": 2}, {\"id\": 3}],\n                \"obj_links\": \"test\"\n            },\n            {\n                \"obj\": [{\"id\": 4}]\n            },\n        ]\n    ):\n        # Second call\n        assert api.paginated_limit == 4\n        result = api._get_paginated_list(\"url\", \"obj\", {})\n        assert log.debug.call_count == 0\n        assert result == [{\"id\": 0}, {\"id\": 1}, {\"id\": 2}, {\"id\": 3}, {\"id\": 4}]\n\n    with mock.patch(\n        \"datadog_checks.openstack_controller.api.SimpleApi._make_request\",\n        side_effect=[\n            # Third call: 1 exception, limit is divided once by 2\n            requests.exceptions.HTTPError,\n            {\n                \"obj\": [{\"id\": 0}, {\"id\": 1}],\n                \"obj_links\": \"test\"\n            },\n            {\n                \"obj\": [{\"id\": 2}, {\"id\": 3}],\n                \"obj_links\": \"test\"\n            },\n            {\n                \"obj\": [{\"id\": 4}]\n            }\n        ]\n    ):\n        # Third call\n        result = api._get_paginated_list(\"url\", \"obj\", {})\n        assert log.debug.call_count == 1\n        assert result == [{\"id\": 0}, {\"id\": 1}, {\"id\": 2}, {\"id\": 3}, {\"id\": 4}]\n        log.reset_mock()\n\n    with mock.patch(\n        \"datadog_checks.openstack_controller.api.SimpleApi._make_request\",\n        side_effect=[\n            # Fourth call: 1 AuthenticationNeeded exception -> no retries\n            AuthenticationNeeded,\n            # Fifth call: any other exception -> no retries\n            Exception,\n        ]\n    ):\n        with pytest.raises(AuthenticationNeeded):\n            api._get_paginated_list(\"url\", \"obj\", {})\n        with pytest.raises(Exception):\n            api._get_paginated_list(\"url\", \"obj\", {})\n\n\ndef test__make_request_failure():\n    log = mock.MagicMock()\n\n    instance = copy.deepcopy(common.MOCK_CONFIG[\"instances\"][0])\n    instance[\"paginated_limit\"] = 4\n\n    with mock.patch(\"datadog_checks.openstack_controller.api.SimpleApi.connect\"):\n        api = ApiFactory.create(log, None, instance)\n\n    response_mock = mock.MagicMock()\n    with mock.patch(\n        \"datadog_checks.openstack_controller.api.requests.get\",\n        return_value=response_mock\n    ):\n        response_mock.raise_for_status.side_effect = requests.exceptions.HTTPError\n        response_mock.status_code = 401\n        with pytest.raises(AuthenticationNeeded):\n            api._make_request(\"\", {})\n\n        response_mock.status_code = 409\n        with pytest.raises(InstancePowerOffFailure):\n            api._make_request(\"\", {})\n\n        response_mock.status_code = 500\n        with pytest.raises(requests.exceptions.HTTPError):\n            api._make_request(\"\", {})\n\n        response_mock.raise_for_status.side_effect = Exception\n        with pytest.raises(Exception):\n            api._make_request(\"\", {})\n\n\ndef get_server_diagnostics_post_v2_48_response(url, headers, params=None, timeout=None):\n    return json.loads(\"\"\"{\n        \"config_drive\": true,\n        \"cpu_details\": [\n            {\n                \"id\": 0,\n                \"time\": 17300000000,\n                \"utilisation\": 15\n            }\n        ],\n        \"disk_details\": [\n            {\n                \"errors_count\": 1,\n                \"read_bytes\": 262144,\n                \"read_requests\": 112,\n                \"write_bytes\": 5778432,\n                \"write_requests\": 488\n            }\n        ],\n        \"driver\": \"libvirt\",\n        \"hypervisor\": \"kvm\",\n        \"hypervisor_os\": \"ubuntu\",\n        \"memory_details\": {\n            \"maximum\": 524288,\n            \"used\": 0\n        },\n        \"nic_details\": [\n            {\n                \"mac_address\": \"01:23:45:67:89:ab\",\n                \"rx_drop\": 200,\n                \"rx_errors\": 100,\n                \"rx_octets\": 2070139,\n                \"rx_packets\": 26701,\n                \"rx_rate\": 300,\n                \"tx_drop\": 500,\n                \"tx_errors\": 400,\n                \"tx_octets\": 140208,\n                \"tx_packets\": 662,\n                \"tx_rate\": 600\n            }\n        ],\n        \"num_cpus\": 1,\n        \"num_disks\": 1,\n        \"num_nics\": 1,\n        \"state\": \"running\",\n        \"uptime\": 46664\n    }\"\"\")\n\n\ndef get_server_diagnostics_post_v2_1_response(url, headers, params=None, timeout=None):\n    return json.loads(\"\"\"{\n        \"cpu0_time\": 17300000000,\n        \"memory\": 524288,\n        \"vda_errors\": -1,\n        \"vda_read\": 262144,\n        \"vda_read_req\": 112,\n        \"vda_write\": 5778432,\n        \"vda_write_req\": 488,\n        \"vnet1_rx\": 2070139,\n        \"vnet1_rx_drop\": 0,\n        \"vnet1_rx_errors\": 0,\n        \"vnet1_rx_packets\": 26701,\n        \"vnet1_tx\": 140208,\n        \"vnet1_tx_drop\": 0,\n        \"vnet1_tx_errors\": 0,\n        \"vnet1_tx_packets\": 662\n    }\"\"\")\n\n\ndef test_get_server_diagnostics(aggregator):\n    with mock.patch('datadog_checks.openstack_controller.api.SimpleApi._make_request',\n                    side_effect=get_server_diagnostics_post_v2_48_response):\n        api = SimpleApi(None, None)\n        assert api.get_server_diagnostics(None) == {\n            \"config_drive\": True,\n            \"cpu_details\": [\n                {\n                    \"id\": 0,\n                    \"time\": 17300000000,\n                    \"utilisation\": 15\n                }\n            ],\n            \"disk_details\": [\n                {\n                    \"errors_count\": 1,\n                    \"read_bytes\": 262144,\n                    \"read_requests\": 112,\n                    \"write_bytes\": 5778432,\n                    \"write_requests\": 488\n                }\n            ],\n            \"driver\": \"libvirt\",\n            \"hypervisor\": \"kvm\",\n            \"hypervisor_os\": \"ubuntu\",\n            \"memory_details\": {\n                \"maximum\": 524288,\n                \"used\": 0\n            },\n            \"nic_details\": [\n                {\n                    \"mac_address\": \"01:23:45:67:89:ab\",\n                    \"rx_drop\": 200,\n                    \"rx_errors\": 100,\n                    \"rx_octets\": 2070139,\n                    \"rx_packets\": 26701,\n                    \"rx_rate\": 300,\n                    \"tx_drop\": 500,\n                    \"tx_errors\": 400,\n                    \"tx_octets\": 140208,\n                    \"tx_packets\": 662,\n                    \"tx_rate\": 600\n                }\n            ],\n            \"num_cpus\": 1,\n            \"num_disks\": 1,\n            \"num_nics\": 1,\n            \"state\": \"running\",\n            \"uptime\": 46664\n        }\n\n    with mock.patch('datadog_checks.openstack_controller.api.SimpleApi._make_request',\n                    side_effect=get_server_diagnostics_post_v2_1_response):\n        api = SimpleApi(None, None)\n        assert api.get_server_diagnostics(None) == {\n            \"cpu0_time\": 17300000000,\n            \"memory\": 524288,\n            \"vda_errors\": -1,\n            \"vda_read\": 262144,\n            \"vda_read_req\": 112,\n            \"vda_write\": 5778432,\n            \"vda_write_req\": 488,\n            \"vnet1_rx\": 2070139,\n            \"vnet1_rx_drop\": 0,\n            \"vnet1_rx_errors\": 0,\n            \"vnet1_rx_packets\": 26701,\n            \"vnet1_tx\": 140208,\n            \"vnet1_tx_drop\": 0,\n            \"vnet1_tx_errors\": 0,\n            \"vnet1_tx_packets\": 662\n        }\n\n\ndef get_project_limits_response(url, headers, params=None, timeout=None):\n    return json.loads(\"\"\"{\n        \"limits\": {\n            \"absolute\": {\n                \"maxImageMeta\": 128,\n                \"maxPersonality\": 5,\n                \"maxPersonalitySize\": 10240,\n                \"maxSecurityGroupRules\": 20,\n                \"maxSecurityGroups\": 10,\n                \"maxServerMeta\": 128,\n                \"maxTotalCores\": 20,\n                \"maxTotalFloatingIps\": 10,\n                \"maxTotalInstances\": 10,\n                \"maxTotalKeypairs\": 100,\n                \"maxTotalRAMSize\": 51200,\n                \"maxServerGroups\": 10,\n                \"maxServerGroupMembers\": 10,\n                \"totalCoresUsed\": 0,\n                \"totalInstancesUsed\": 0,\n                \"totalRAMUsed\": 0,\n                \"totalSecurityGroupsUsed\": 0,\n                \"totalFloatingIpsUsed\": 0,\n                \"totalServerGroupsUsed\": 0\n            },\n            \"rate\": []\n        }\n    }\"\"\")\n\n\ndef test_get_project_limits(aggregator):\n    with mock.patch('datadog_checks.openstack_controller.api.SimpleApi._make_request',\n                    side_effect=get_project_limits_response):\n        api = SimpleApi(None, None)\n        assert api.get_project_limits(None) == common.EXAMPLE_GET_PROJECT_LIMITS_RETURN_VALUE\n        )\n    }\n\n    return\n        })\n\n        #1\n        (\n        )\n        )\n\n        #\n        )\n        #\n\n        )\n        \n\n        )\n        \n        \n        \n\n        )"
  },
  "feature_stats": {
    "indices": [
      2,
      0,
      1426,
      832,
      460,
      6189,
      6848,
      7425,
      5643,
      4583,
      4863
    ],
    "f_before": [
      1.4412624835968018,
      0.0,
      0.0,
      0.0,
      0.0,
      0.0,
      0.0,
      2.9627506732940674,
      0.0,
      0.0,
      0.0
    ],
    "f_after": [
      1.4412624835968018,
      0.0,
      0.0,
      0.0,
      0.0,
      0.0,
      0.0,
      2.9627506732940674,
      0.0,
      0.0,
      0.0
    ],
    "g_before": [
      0.12840723991394043,
      0.8475884199142456,
      0.17131298780441284,
      0.15613700449466705,
      0.1533384770154953,
      0.18319198489189148,
      0.13086779415607452,
      0.13838228583335876,
      0.15930119156837463,
      0.1350475549697876,
      0.045550957322120667
    ],
    "g_after": [
      0.12840723991394043,
      0.8475884199142456,
      0.17131298780441284,
      0.15613700449466705,
      0.1533384770154953,
      0.18319198489189148,
      0.13086779415607452,
      0.13838228583335876,
      0.15930119156837463,
      0.1350475549697876,
      0.045550957322120667
    ],
    "num_batches_for_stats": 10
  },
  "loss_summary": {
    "train_mean_loss": 8.922674083650111,
    "train_mean_l2": 6.179721740648151,
    "train_mean_l1": 2.9495802549421786,
    "num_steps": 2000,
    "num_batches": 2000
  },
  "feature_std_summary": {
    "plot_path": "outputs/plots/20251128-003140/feature_std_layer_12.html",
    "mean_std": 1.1792261600494385,
    "max_std": 44.42379379272461
  }
}