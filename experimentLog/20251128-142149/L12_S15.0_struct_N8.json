{
  "model_name": "google/gemma-2-2b-it",
  "layer_idx": 12,
  "command": "python main.py experiment.use_multi_contrast=true sae.loss_option=2 sae.loss_module=option2_loss sae.guidance_method=contrastive sae.guidance_coeff=1.0 sae.alpha_concept.code=0.05 sae.alpha_concept.harm=0.03 sae.alpha_concept.struct=0.0 sae.use_l0=true sae.l0_coeff=0.00037731631260996427 sae.role_sep_coeff=0.0095",
  "sae": {
    "input_dim": 2304,
    "sae_dim": 9216,
    "fixed_v_cnt": 3,
    "batch_size": 3,
    "epochs": 2,
    "max_steps": 2000,
    "l1_coeff": 0.005,
    "l0_coeff": 0.00037731631260996427,
    "use_l0": true,
    "concept_samples_per_label": 100,
    "loss_option": 2,
    "loss_module": "option2_loss",
    "concept_feature_indices": {
      "code": 0,
      "harm": 1,
      "struct": 2
    },
    "alpha_concept": {
      "code": 0.05,
      "harm": 0.03,
      "struct": 0.0
    },
    "positive_targets": {
      "code": 1,
      "harm": 1,
      "struct": 1
    },
    "guidance_method": "contrastive",
    "guidance_margin": 0.0,
    "guidance_coeff": 1.0,
    "guidance_mse_pos_value": 1.0,
    "guidance_mse_neg_value": 0.0,
    "jumprelu_bandwidth": 0.001,
    "jumprelu_init_threshold": 0.001,
    "role_sep_coeff": 0.0095
  },
  "gnn": {
    "use_gnn": true,
    "top_k": 10
  },
  "experiment": {
    "device": "cuda",
    "dataset_name": "wikitext",
    "dataset_config": "wikitext-2-raw-v1",
    "use_multi_contrast": true,
    "num_steering_samples_per_label": 10,
    "top_k_for_plot": 10,
    "layer_sweep": [
      12
    ],
    "strength_sweep": [
      15.0
    ]
  },
  "steering": {
    "label": "struct",
    "feature_idx": 2,
    "strength": 15.0
  },
  "prompt": "#!/usr/bin/env python\n\"\"\"Test of \"New Hunt\" wizard.\"\"\"\nfrom __future__ import absolute_import\nfrom __future__ import division\nfrom __future__ import unicode_literals\n\nfrom absl import app\nfrom selenium.webdriver.common import keys\n\nfrom grr_response_core.lib import rdfvalue\nfrom grr_response_core.lib.rdfvalues import paths as rdf_paths\nfrom grr_response_server import data_store\nfrom grr_response_server import foreman\nfrom grr_response_server import foreman_rules\nfrom grr_response_server import hunt as lib_hunt\nfrom grr_response_server.flows.general import file_finder\nfrom grr_response_server.flows.general import transfer\nfrom grr_response_server.gui import gui_test_lib\nfrom grr_response_server.rdfvalues import flow_runner as rdf_flow_runner\nfrom grr_response_server.rdfvalues import output_plugin as rdf_output_plugin\nfrom grr.test_lib import test_lib\n\n\nclass TestNewHuntWizard(gui_test_lib.GRRSeleniumHuntTest):\n  \"\"\"Test the \"new hunt wizard\" GUI.\"\"\"\n\n  @staticmethod\n  def FindForemanRules(hunt_urn, token):\n    rules = data_store.REL_DB.ReadAllForemanRules()\n    return [rule for rule in rules if rule.hunt_id == hunt_urn.Basename()]\n\n  def testNewHuntWizard(self):\n    # Open up and click on View Hunts.\n    self.Open(\"/\")\n    self.WaitUntil(self.IsElementPresent, \"client_query\")\n    self.WaitUntil(self.IsElementPresent, \"css=a[grrtarget=hunts]\")\n    self.Click(\"css=a[grrtarget=hunts]\")\n    self.WaitUntil(self.IsElementPresent, \"css=button[name=NewHunt]\")\n\n    # Open up \"New Hunt\" wizard\n    self.Click(\"css=button[name=NewHunt]\")\n    self.WaitUntil(self.IsElementPresent,\n                   \"css=grr-wizard-form:contains('What to run?')\")\n\n    # Click on Filesystem item in flows list\n    self.WaitUntil(self.IsElementPresent, \"css=#_Filesystem > i.jstree-icon\")\n    self.Click(\"css=#_Filesystem > i.jstree-icon\")\n\n    # Click on the FileFinder item in Filesystem flows list\n    self.Click(\"link=File Finder\")\n\n    # Wait for flow configuration form to be rendered (just wait for first\n    # input field).\n    self.WaitUntil(self.IsElementPresent,\n                   \"css=grr-new-hunt-wizard-form label:contains('Paths')\")\n\n    # Change \"path\" and \"pathtype\" values\n    self.Type(\n        \"css=grr-new-hunt-wizard-form \"\n        \"grr-form-proto-repeated-field:has(label:contains('Paths')) \"\n        \"input\", \"/tmp\")\n    self.Select(\n        \"css=grr-new-hunt-wizard-form \"\n        \"grr-form-proto-single-field:has(label:contains('Pathtype')) \"\n        \"select\", \"TSK\")\n\n    # Click on \"Next\" button\n    self.Click(\"css=grr-new-hunt-wizard-form button.Next\")\n    self.WaitUntil(self.IsElementPresent,\n                   \"css=grr-wizard-form:contains('Hunt parameters')\")\n\n    # Click on \"Next\" button\n    self.Click(\"css=grr-new-hunt-wizard-form button.Next\")\n    self.WaitUntil(self.IsElementPresent,\n                   \"css=grr-wizard-form:contains('How to process results')\")\n\n    # Click on \"Back\" button and check that all the values in the form\n    # remain intact.\n    self.Click(\"css=grr-new-hunt-wizard-form button.Back\")\n    self.WaitUntil(self.IsElementPresent,\n                   \"css=grr-wizard-form:contains('Hunt parameters')\")\n\n    self.Click(\"css=grr-new-hunt-wizard-form button.Back\")\n    self.WaitUntil(self.IsElementPresent,\n                   \"css=grr-new-hunt-wizard-form label:contains('Paths')\")\n\n    self.assertEqual(\n        \"/tmp\",\n        self.GetValue(\n            \"css=grr-new-hunt-wizard-form \"\n            \"grr-form-proto-repeated-field:has(label:contains('Paths')) input\"))\n\n    self.assertEqual(\n        \"TSK\",\n        self.GetSelectedLabel(\n            \"css=grr-new-hunt-wizard-form \"\n            \"grr-form-proto-single-field:has(label:contains('Pathtype')) select\"\n        ))\n\n    # Click on \"Next\" button\n    self.Click(\"css=grr-new-hunt-wizard-form button.Next\")\n    self.WaitUntil(self.IsElementPresent,\n                   \"css=grr-wizard-form:contains('Hunt parameters')\")\n\n    # Click on \"Next\" button\n    self.Click(\"css=grr-new-hunt-wizard-form button.Next\")\n    self.WaitUntil(self.IsElementPresent,\n                   \"css=grr-wizard-form:contains('How to process results')\")\n\n    # Configure the hunt to use dummy output plugin.\n    self.Click(\"css=grr-new-hunt-wizard-form button[name=Add]\")\n    self.Select(\"css=grr-new-hunt-wizard-form select\", \"DummyOutputPlugin\")\n    self.Type(\n        \"css=grr-new-hunt-wizard-form \"\n        \"grr-form-proto-single-field:has(label:contains('Filepath Regex')) \"\n        \"input\", \"some regex\")\n\n    # Click on \"Next\" button\n    self.Click(\"css=grr-new-hunt-wizard-form button.Next\")\n    self.WaitUntil(self.IsElementPresent,\n                   \"css=grr-wizard-form:contains('Where to run?')\")\n\n    # Empty set of rules should be valid.\n    self.WaitUntil(self.IsElementPresent, \"css=button.Next:not([disabled])\")\n\n    # A note informs what an empty set of rules means.\n    self.WaitUntil(self.IsElementPresent,\n                   \"css=grr-wizard-form:contains('No rules specified!')\")\n\n    # Alternative match mode that matches a client if\n    # any of the rules evaluates to true can be selected.\n    self.Select(\n        \"css=grr-configure-rules-page \"\n        \"label:contains('Match mode') ~ * select\", \"Match any\")\n\n    # The note depends on the match mode.\n    self.WaitUntil(self.IsElementPresent,\n                   \"css=grr-wizard-form:contains('No rules specified!')\")\n\n    # Create 3 foreman rules. Note that \"Add\" button adds rules\n    # to the beginning of a list. So we always use :nth(0) selector.\n    self.Click(\"css=grr-configure-rules-page button[name=Add]\")\n    self.Select(\"css=grr-configure-rules-page div.well:nth(0) select\", \"Regex\")\n    rule = foreman_rules.ForemanRegexClientRule\n    label = rule.ForemanStringField.SYSTEM.description\n    self.Select(\n        \"css=grr-configure-rules-page div.well:nth(0) \"\n        \"label:contains('Field') ~ * select\", label)\n    self.Type(\n        \"css=grr-configure-rules-page div.well:nth(0) \"\n        \"label:contains('Attribute regex') ~ * input\", \"Linux\")\n\n    self.Click(\"css=grr-configure-rules-page button[name=Add]\")\n    self.Select(\"css=grr-configure-rules-page div.well:nth(0) select\",\n                \"Integer\")\n\n    rule = foreman_rules.ForemanIntegerClientRule\n    label = rule.ForemanIntegerField.CLIENT_CLOCK.description\n    self.Select(\n        \"css=grr-configure-rules-page div.well:nth(0) \"\n        \"label:contains('Field') ~ * select\", label)\n    self.Select(\n        \"css=grr-configure-rules-page div.well:nth(0) \"\n        \"label:contains('Operator') ~ * select\", \"GREATER_THAN\")\n    self.Type(\n        \"css=grr-configure-rules-page div.well:nth(0) \"\n        \"label:contains('Value') ~ * input\", \"1336650631137737\")\n\n    self.Click(\"css=grr-configure-rules-page button[name=Add]\")\n    self.Click(\"css=grr-configure-rules-page div.well:nth(0) \"\n               \"label:contains('Os darwin') ~ * input[type=checkbox]\")\n\n    # Click on \"Back\" button\n    self.Click(\"css=grr-new-hunt-wizard-form button.Back\")\n    self.WaitUntil(self.IsElementPresent,\n                   \"css=grr-wizard-form:contains('How to process results')\")\n\n    # Click on \"Next\" button again and check that all the values that\n    # we've just entered remain intact.\n    self.Click(\"css=grr-new-hunt-wizard-form button.Next\")\n    self.WaitUntil(self.IsElementPresent,\n                   \"css=grr-wizard-form:contains('Where to run?')\")\n\n    # Click on \"Next\" button\n    self.Click(\"css=grr-new-hunt-wizard-form button.Next\")\n    self.WaitUntil(self.IsElementPresent,\n                   \"css=grr-wizard-form:contains('Review')\")\n\n    # Check that the arguments summary is present.\n    self.WaitUntil(self.IsElementPresent,\n                   \"css=grr-wizard-form:contains('Paths')\")\n    self.WaitUntil(self.IsElementPresent,\n                   \"css=grr-wizard-form:contains('/tmp')\")\n\n    # Check that output plugins are shown.\n    self.assertTrue(\n        self.IsElementPresent(\n            \"css=grr-wizard-form:contains('DummyOutputPlugin')\"))\n    self.assertTrue(\n        self.IsElementPresent(\"css=grr-wizard-form:contains('some regex')\"))\n\n    # Check that there's no deprecated rules summary.\n    self.assertFalse(\n        self.IsElementPresent(\"css=grr-wizard-form:contains('Regex rules')\"))\n    self.assertFalse(\n        self.IsElementPresent(\"css=grr-wizard-form:contains('Integer rules')\"))\n\n    # Check that rules summary is present.\n    self.assertTrue(\n        self.IsElementPresent(\n            \"css=grr-wizard-form:contains('Client rule set')\"))\n\n    # Click on \"Run\" button\n    self.Click(\"css=grr-new-hunt-wizard-form button.Next\")\n\n    self.WaitUntil(self.IsElementPresent,\n                   \"css=grr-wizard-form:contains('Created Hunt')\")\n\n    # Close the window and check that the hunt was created.\n    self.Click(\"css=button.Next\")\n\n    # Select newly created hunt.\n    self.Click(\"css=grr-hunts-list td:contains('gui_user')\")\n\n    # Check that correct details are displayed in hunt details tab.\n    self.WaitUntil(self.IsElementPresent,\n                   \"css=grr-hunt-inspector:contains('GenericHunt')\")\n    self.WaitUntil(self.IsElementPresent,\n                   \"css=grr-hunt-inspector:contains('Flow Arguments')\")\n\n    self.assertTrue(\n        self.IsElementPresent(\"css=grr-hunt-inspector:contains('Paths')\"))\n    self.assertTrue(\n        self.IsElementPresent(\"css=grr-hunt-inspector:contains('/tmp')\"))\n\n    self.assertTrue(\n        self.IsElementPresent(\n            \"css=grr-hunt-inspector:contains('DummyOutputPlugin')\"))\n    self.assertTrue(\n        self.IsElementPresent(\"css=grr-hunt-inspector:contains('some regex')\"))\n\n    # Check that there's no deprecated rules summary.\n    self.assertFalse(\n        self.IsElementPresent(\"css=grr-hunt-inspector:contains('Regex rules')\"))\n    self.assertFalse(\n        self.IsElementPresent(\n            \"css=grr-hunt-inspector:contains('Integer rules')\"))\n\n    # Check that rules summary is present.\n    self.assertTrue(\n        self.IsElementPresent(\n            \"css=grr-hunt-inspector:contains('Client Rule Set')\"))\n\n    # Check that the hunt object was actually created\n    hunts_list = sorted(\n        data_store.REL_DB.ReadHuntObjects(offset=0, count=10),\n        key=lambda x: x.create_time)\n    self.assertLen(hunts_list, 1)\n\n    # Check that the hunt was created with a correct flow\n    hunt = hunts_list[0]\n\n    self.assertEqual(hunt.args.standard.flow_name,\n                     file_finder.FileFinder.__name__)\n    self.assertEqual(hunt.args.standard.flow_args.paths[0], \"/tmp\")\n    self.assertEqual(hunt.args.standard.flow_args.pathtype,\n                     rdf_paths.PathSpec.PathType.TSK)\n    # self.assertEqual(hunt.args.flow_args.ignore_errors, True)\n    self.assertEqual(hunt.output_plugins[0].plugin_name, \"DummyOutputPlugin\")\n\n    # Check that hunt was not started\n    self.assertEqual(hunt.hunt_state, hunt.HuntState.PAUSED)\n\n    lib_hunt.StartHunt(hunt.hunt_id)\n\n    hunt_rules = self.FindForemanRules(\n        rdfvalue.RDFURN(\"hunts\").Add(hunt.hunt_id), token=self.token)\n\n    # Check that the hunt was created with correct rules\n    self.assertLen(hunt_rules, 1)\n    lifetime = hunt_rules[0].GetLifetime()\n    lifetime -= rdfvalue.DurationSeconds(\"2w\")\n    self.assertLessEqual(lifetime, rdfvalue.DurationSeconds(\"1s\"))\n\n    r = hunt_rules[0].client_rule_set\n\n    self.assertEqual(r.match_mode,\n                     foreman_rules.ForemanClientRuleSet.MatchMode.MATCH_ANY)\n    self.assertLen(r.rules, 3)\n\n    self.assertEqual(r.rules[0].rule_type,\n                     foreman_rules.ForemanClientRule.Type.OS)\n    self.assertEqual(r.rules[0].os.os_windows, False)\n    self.assertEqual(r.rules[0].os.os_linux, False)\n    self.assertEqual(r.rules[0].os.os_darwin, True)\n\n    self.assertEqual(r.rules[1].rule_type,\n                     foreman_rules.ForemanClientRule.Type.INTEGER)\n    self.assertEqual(r.rules[1].integer.field, \"CLIENT_CLOCK\")\n    self.assertEqual(\n        r.rules[1].integer.operator,\n        foreman_rules.ForemanIntegerClientRule.Operator.GREATER_THAN)\n    self.assertEqual(r.rules[1].integer.value, 1336650631137737)\n\n    self.assertEqual(r.rules[2].rule_type,\n                     foreman_rules.ForemanClientRule.Type.REGEX)\n    self.assertEqual(r.rules[2].regex.field, \"SYSTEM\")\n    self.assertEqual(r.rules[2].regex.attribute_regex, \"Linux\")\n\n  def testWizardStepCounterIsShownCorrectly(self):\n    # Open up and click on View Hunts.\n    self.Open(\"/#/hunts\")\n\n    # Open up \"New Hunt\" wizard\n    self.Click(\"css=button[name=NewHunt]\")\n    self.WaitUntil(self.IsElementPresent,\n                   \"css=grr-wizard-form:contains('What to run?')\")\n\n    # Click on the FileFinder item in Filesystem flows list\n    self.WaitUntil(self.IsElementPresent, \"css=#_Filesystem > i.jstree-icon\")\n    self.Click(\"css=#_Filesystem > i.jstree-icon\")\n    self.Click(\"link=File Finder\")\n\n    self.WaitUntil(self.IsElementPresent,\n                   \"css=grr-wizard-form:contains('Step 1 out of 6')\")\n\n    # Click on \"Next\" button\n    self.Click(\"css=grr-new-hunt-wizard-form button.Next\")\n\n    self.WaitUntil(self.IsElementPresent,\n                   \"css=grr-wizard-form:contains('Step 2 out of 6')\")\n\n  def testLiteralExpressionIsProcessedCorrectly(self):\n    \"\"\"Literals are raw bytes. Testing that raw bytes are processed right.\"\"\"\n\n    # Open up and click on View Hunts.\n    self.Open(\"/\")\n    self.Click(\"css=a[grrtarget=hunts]\")\n\n    # Open up \"New Hunt\" wizard\n    self.Click(\"css=button[name=NewHunt]\")\n    self.WaitUntil(self.IsElementPresent,\n                   \"css=grr-wizard-form:contains('What to run?')\")\n\n    # Click on Filesystem item in flows list\n    self.WaitUntil(self.IsElementPresent, \"css=#_Filesystem > i.jstree-icon\")\n    self.Click(\"css=#_Filesystem > i.jstree-icon\")\n\n    # Click on the FileFinder item in Filesystem flows list\n    self.Click(\"link=File Finder\")\n\n    self.Click(\"css=label:contains('Conditions') ~ * button\")\n    self.Select(\"css=label:contains('Condition type') ~ * select\",\n                \"Contents literal match\")\n    self.Type(\"css=label:contains('Literal') ~ * input\", \"foo\\\\x0d\\\\xc8bar\")\n\n    # Click on \"Next\" button\n    self.Click(\"css=grr-new-hunt-wizard-form button.Next\")\n    self.WaitUntil(self.IsElementPresent,\n                   \"css=grr-wizard-form:contains('Hunt parameters')\")\n    # Click on \"Next\" button\n    self.Click(\"css=grr-new-hunt-wizard-form button.Next\")\n    self.WaitUntil(self.IsElementPresent,\n                   \"css=grr-wizard-form:contains('How to process results')\")\n    # Click on \"Next\" button\n    self.Click(\"css=grr-new-hunt-wizard-form button.Next\")\n    self.WaitUntil(self.IsElementPresent,\n                   \"css=grr-wizard-form:contains('Where to run?')\")\n    # Click on \"Next\" button\n    self.Click(\"css=grr-new-hunt-wizard-form button.Next\")\n    self.WaitUntil(self.IsElementPresent,\n                   \"css=grr-wizard-form:contains('Review')\")\n\n    # Check that the arguments summary is present.\n    self.WaitUntil(\n        self.IsElementPresent,\n        \"css=grr-wizard-form:contains('%s')\" % file_finder.FileFinder.__name__)\n    self.WaitUntil(self.IsTextPresent, b\"foo\\\\x0d\\\\xc8bar\")\n\n    # Click on \"Run\" button\n    self.Click(\"css=grr-new-hunt-wizard-form button.Next\")\n    self.WaitUntil(self.IsElementPresent,\n                   \"css=grr-wizard-form:contains('Created Hunt')\")\n    # Close the window and check that the hunt was created.\n    self.Click(\"css=button.Next\")\n\n    # Check that the hunt object was actually created\n    hunts_list = sorted(\n        data_store.REL_DB.ReadHuntObjects(offset=0, count=10),\n        key=lambda x: x.create_time)\n    self.assertLen(hunts_list, 1)\n\n    # Check that the hunt was created with a correct literal value.\n    hunt = hunts_list[0]\n    self.assertEqual(hunt.args.standard.flow_name,\n                     file_finder.FileFinder.__name__)\n    self.assertEqual(\n        hunt.args.standard.flow_args.conditions[0].contents_literal_match\n        .literal, b\"foo\\x0d\\xc8bar\")\n\n  def testOutputPluginsListEmptyWhenNoDefaultOutputPluginSet(self):\n    self.Open(\"/#main=ManageHunts\")\n    self.Click(\"css=button[name=NewHunt]\")\n\n    # Select \"List Processes\" flow.\n    self.Click(\"css=#_Processes > i.jstree-icon\")\n    self.Click(\"link=ListProcesses\")\n\n    # Click on \"Next\" button\n    self.Click(\"css=grr-new-hunt-wizard-form button.Next\")\n    self.WaitUntil(self.IsElementPresent,\n                   \"css=grr-wizard-form:contains('Hunt parameters')\")\n\n    # There should be no dummy output plugin visible.\n    self.Click(\"css=grr-new-hunt-wizard-form button.Next\")\n    self.WaitUntil(self.IsElementPresent,\n                   \"css=grr-wizard-form:contains('How to process results')\")\n    self.WaitUntilNot(self.IsElementPresent,\n                      \"css=grr-wizard-form:contains('Dummy do do')\")\n\n  def testDefaultOutputPluginIsCorrectlyAddedToThePluginsList(self):\n    with test_lib.ConfigOverrider(\n        {\"AdminUI.new_hunt_wizard.default_output_plugin\": \"DummyOutputPlugin\"}):\n      self.Open(\"/#main=ManageHunts\")\n      self.Click(\"css=button[name=NewHunt]\")\n\n      # Select \"List Processes\" flow.\n      self.Click(\"css=#_Processes > i.jstree-icon\")\n      self.Click(\"link=ListProcesses\")\n\n      # Click on \"Next\" button\n      self.Click(\"css=grr-new-hunt-wizard-form button.Next\")\n      self.WaitUntil(self.IsElementPresent,\n                     \"css=grr-wizard-form:contains('Hunt parameters')\")\n\n      # Dummy output plugin should be added by default.\n      self.Click(\"css=grr-new-hunt-wizard-form button.Next\")\n      self.WaitUntil(self.IsElementPresent,\n                     \"css=grr-wizard-form:contains('How to process results')\")\n      self.WaitUntil(self.IsElementPresent,\n                     \"css=grr-wizard-form:contains('DummyOutputPlugin')\")\n\n  def testLabelsHuntRuleDisplaysAvailableLabels(self):\n    client_id = self.SetupClient(0)\n\n    self.AddClientLabel(client_id, u\"owner1\", u\"foo\")\n    self.AddClientLabel(client_id, u\"owner2\", u\"bar\")\n\n    self.Open(\"/#main=ManageHunts\")\n    self.Click(\"css=button[name=NewHunt]\")\n\n    # Select \"List Processes\" flow.\n    self.Click(\"css=#_Processes > i.jstree-icon\")\n    self.Click(\"link=ListProcesses\")\n\n    # Click 'Next' to go to hunt parameters page.\n    self.Click(\"css=grr-new-hunt-wizard-form button.Next\")\n\n    # Click 'Next' to go to output plugins page.\n    self.Click(\"css=grr-new-hunt-wizard-form button.Next\")\n\n    # Click 'Next' to go to hunt rules page.\n    self.Click(\"css=grr-new-hunt-wizard-form button.Next\")\n\n    self.Click(\"css=grr-new-hunt-wizard-form button[name=Add]\")\n\n    # Select 'Clients With Label' rule.\n    self.Select(\"css=grr-new-hunt-wizard-form div.well select\", \"Label\")\n    # Check that there's an option present for labels 'bar' (this option\n    # should be selected) and for label 'foo'.\n    self.WaitUntil(\n        self.IsElementPresent, \"css=grr-new-hunt-wizard-form div.well \"\n        \".form-group:has(label:contains('Label')) \"\n        \"select option:selected[label=bar]\")\n    self.WaitUntil(\n        self.IsElementPresent, \"css=grr-new-hunt-wizard-form div.well \"\n        \".form-group:has(label:contains('Label')) \"\n        \"select option:not(:selected)[label=foo]\")\n\n  def testLabelsHuntRuleMatchesCorrectClients(self):\n    client_ids = self.SetupClients(10)\n\n    self.AddClientLabel(client_ids[1], u\"owner1\", u\"foo\")\n    self.AddClientLabel(client_ids[1], u\"owner2\", u\"bar\")\n    self.AddClientLabel(client_ids[7], u\"GRR\", u\"bar\")\n\n    self.Open(\"/#main=ManageHunts\")\n    self.Click(\"css=button[name=NewHunt]\")\n\n    # Select \"List Processes\" flow.\n    self.Click(\"css=#_Processes > i.jstree-icon\")\n    self.Click(\"link=ListProcesses\")\n\n    # Click 'Next' to go to the output plugins page, hunt parameters page\n    # and then to hunt rules page.\n    self.Click(\"css=grr-new-hunt-wizard-form button.Next\")\n    self.WaitUntil(self.IsElementPresent,\n                   \"css=grr-wizard-form:contains('Hunt parameters')\")\n    self.Click(\"css=grr-new-hunt-wizard-form button.Next\")\n    self.WaitUntil(self.IsElementPresent,\n                   \"css=grr-wizard-form:contains('How to process results')\")\n    self.Click(\"css=grr-new-hunt-wizard-form button.Next\")\n    self.WaitUntil(self.IsElementPresent,\n                   \"css=grr-wizard-form:contains('Where to run?')\")\n\n    # Select 'Clients With Label' rule.\n    self.Click(\"css=grr-configure-rules-page button[name=Add]\")\n    self.Select(\"css=grr-new-hunt-wizard-form div.well select\", \"Label\")\n    self.Select(\n        \"css=grr-new-hunt-wizard-form div.well .form-group \"\n        \".form-group:has(label:contains('Label')):nth-last-of-type(1) \"\n        \"select\", \"foo\")\n    self.Click(\"css=grr-new-hunt-wizard-form div.well .form-group \"\n               \".form-group:has(label:contains('Add label')) button\")\n    self.Select(\n        \"css=grr-new-hunt-wizard-form div.well .form-group \"\n        \".form-group:has(label:contains('Label')):nth-last-of-type(1) \"\n        \"select\", \"bar\")\n    self.Select(\n        \"css=grr-new-hunt-wizard-form div.well .form-group \"\n        \".form-group:has(label:contains('Match mode')) select\", \"Match any\")\n\n    # Click 'Next' to go to hunt overview page.  Then click 'Next' to go to\n    # submit the hunt and wait until it's created.\n    self.Click(\"css=grr-new-hunt-wizard-form button.Next\")\n    self.Click(\"css=grr-new-hunt-wizard-form button.Next\")\n    self.WaitUntil(self.IsElementPresent,\n                   \"css=grr-wizard-form:contains('Created Hunt')\")\n\n    hunts_list = sorted(\n        data_store.REL_DB.ReadHuntObjects(offset=0, count=10),\n        key=lambda x: x.create_time)\n    hunt = hunts_list[0]\n    lib_hunt.StartHunt(hunt.hunt_id)\n\n    foreman_obj = foreman.Foreman()\n    for client_id in client_ids:\n      tasks_assigned = foreman_obj.AssignTasksToClient(client_id)\n      if client_id in [client_ids[1], client_ids[7]]:\n        self.assertTrue(tasks_assigned)\n      else:\n        self.assertFalse(tasks_assigned)\n\n  def CreateSampleHunt(self, description, token=None):\n    self.StartHunt(\n        description=description,\n        flow_runner_args=rdf_flow_runner.FlowRunnerArgs(\n            flow_name=transfer.GetFile.__name__),\n        flow_args=transfer.GetFileArgs(\n            pathspec=rdf_paths.PathSpec(\n                path=\"/tmp/evil.txt\",\n                pathtype=rdf_paths.PathSpec.PathType.TSK,\n            )),\n        client_rule_set=self._CreateForemanClientRuleSet(),\n        output_plugins=[\n            rdf_output_plugin.OutputPluginDescriptor(\n                plugin_name=\"DummyOutputPlugin\",\n                plugin_args=gui_test_lib.DummyOutputPlugin.args_type(\n                    filename_regex=\"blah!\", fetch_binaries=True))\n        ],\n        client_rate=60,\n        paused=True,\n        token=token)\n\n  def testPathAutocomplete(self):\n    # Open Hunts\n    self.Open(\"/#/hunts\")\n\n    # Open \"New Hunt\" wizard\n    self.Click(\"css=button[name=NewHunt]\")\n    self.WaitUntil(self.IsElementPresent,\n                   \"css=grr-wizard-form:contains('What to run?')\")\n\n    # Click on Filesystem item in flows list\n    self.Click(\"css=#_Filesystem > i.jstree-icon\")\n\n    # Click on the FileFinder item in Filesystem flows list\n    self.Click(\"link=File Finder\")\n\n    input_selector = \"css=grr-form-glob-expression input[uib-typeahead]\"\n\n    # Change \"path\"\n    self.Type(input_selector, \"/foo/%%path\")\n\n    self.WaitUntil(self.IsElementPresent,\n                   \"css=[uib-typeahead-popup]:contains('%%environ_path%%')\")\n\n    self.GetElement(input_selector).send_keys(keys.Keys.ENTER)\n\n    self.WaitUntilEqual(\"/foo/%%environ_path%%\", self.GetValue,\n                        input_selector + \":text\")\n\n\nif __name__ == \"__main__\":\n  app.run(test_lib.main)\n",
  "output": {
    "before": "#!/usr/bin/env python\n\"\"\"Test of \"New Hunt\" wizard.\"\"\"\nfrom __future__ import absolute_import\nfrom __future__ import division\nfrom __future__ import unicode_literals\n\nfrom absl import app\nfrom selenium.webdriver.common import keys\n\nfrom grr_response_core.lib import rdfvalue\nfrom grr_response_core.lib.rdfvalues import paths as rdf_paths\nfrom grr_response_server import data_store\nfrom grr_response_server import foreman\nfrom grr_response_server import foreman_rules\nfrom grr_response_server import hunt as lib_hunt\nfrom grr_response_server.flows.general import file_finder\nfrom grr_response_server.flows.general import transfer\nfrom grr_response_server.gui import gui_test_lib\nfrom grr_response_server.rdfvalues import flow_runner as rdf_flow_runner\nfrom grr_response_server.rdfvalues import output_plugin as rdf_output_plugin\nfrom grr.test_lib import test_lib\n\n\nclass TestNewHuntWizard(gui_test_lib.GRRSeleniumHuntTest):\n  \"\"\"Test the \"new hunt wizard\" GUI.\"\"\"\n\n  @staticmethod\n  def FindForemanRules(hunt_urn, token):\n    rules = data_store.REL_DB.ReadAllForemanRules()\n    return [rule for rule in rules if rule.hunt_id == hunt_urn.Basename()]\n\n  def testNewHuntWizard(self):\n    # Open up and click on View Hunts.\n    self.Open(\"/\")\n    self.WaitUntil(self.IsElementPresent, \"client_query\")\n    self.WaitUntil(self.IsElementPresent, \"css=a[grrtarget=hunts]\")\n    self.Click(\"css=a[grrtarget=hunts]\")\n    self.WaitUntil(self.IsElementPresent, \"css=button[name=NewHunt]\")\n\n    # Open up \"New Hunt\" wizard\n    self.Click(\"css=button[name=NewHunt]\")\n    self.WaitUntil(self.IsElementPresent,\n                   \"css=grr-wizard-form:contains('What to run?')\")\n\n    # Click on Filesystem item in flows list\n    self.WaitUntil(self.IsElementPresent, \"css=#_Filesystem > i.jstree-icon\")\n    self.Click(\"css=#_Filesystem > i.jstree-icon\")\n\n    # Click on the FileFinder item in Filesystem flows list\n    self.Click(\"link=File Finder\")\n\n    # Wait for flow configuration form to be rendered (just wait for first\n    # input field).\n    self.WaitUntil(self.IsElementPresent,\n                   \"css=grr-new-hunt-wizard-form label:contains('Paths')\")\n\n    # Change \"path\" and \"pathtype\" values\n    self.Type(\n        \"css=grr-new-hunt-wizard-form \"\n        \"grr-form-proto-repeated-field:has(label:contains('Paths')) \"\n        \"input\", \"/tmp\")\n    self.Select(\n        \"css=grr-new-hunt-wizard-form \"\n        \"grr-form-proto-single-field:has(label:contains('Pathtype')) \"\n        \"select\", \"TSK\")\n\n    # Click on \"Next\" button\n    self.Click(\"css=grr-new-hunt-wizard-form button.Next\")\n    self.WaitUntil(self.IsElementPresent,\n                   \"css=grr-wizard-form:contains('Hunt parameters')\")\n\n    # Click on \"Next\" button\n    self.Click(\"css=grr-new-hunt-wizard-form button.Next\")\n    self.WaitUntil(self.IsElementPresent,\n                   \"css=grr-wizard-form:contains('How to process results')\")\n\n    # Click on \"Back\" button and check that all the values in the form\n    # remain intact.\n    self.Click(\"css=grr-new-hunt-wizard-form button.Back\")\n    self.WaitUntil(self.IsElementPresent,\n                   \"css=grr-wizard-form:contains('Hunt parameters')\")\n\n    self.Click(\"css=grr-new-hunt-wizard-form button.Back\")\n    self.WaitUntil(self.IsElementPresent,\n                   \"css=grr-new-hunt-wizard-form label:contains('Paths')\")\n\n    self.assertEqual(\n        \"/tmp\",\n        self.GetValue(\n            \"css=grr-new-hunt-wizard-form \"\n            \"grr-form-proto-repeated-field:has(label:contains('Paths')) input\"))\n\n    self.assertEqual(\n        \"TSK\",\n        self.GetSelectedLabel(\n            \"css=grr-new-hunt-wizard-form \"\n            \"grr-form-proto-single-field:has(label:contains('Pathtype')) select\"\n        ))\n\n    # Click on \"Next\" button\n    self.Click(\"css=grr-new-hunt-wizard-form button.Next\")\n    self.WaitUntil(self.IsElementPresent,\n                   \"css=grr-wizard-form:contains('Hunt parameters')\")\n\n    # Click on \"Next\" button\n    self.Click(\"css=grr-new-hunt-wizard-form button.Next\")\n    self.WaitUntil(self.IsElementPresent,\n                   \"css=grr-wizard-form:contains('How to process results')\")\n\n    # Configure the hunt to use dummy output plugin.\n    self.Click(\"css=grr-new-hunt-wizard-form button[name=Add]\")\n    self.Select(\"css=grr-new-hunt-wizard-form select\", \"DummyOutputPlugin\")\n    self.Type(\n        \"css=grr-new-hunt-wizard-form \"\n        \"grr-form-proto-single-field:has(label:contains('Filepath Regex')) \"\n        \"input\", \"some regex\")\n\n    # Click on \"Next\" button\n    self.Click(\"css=grr-new-hunt-wizard-form button.Next\")\n    self.WaitUntil(self.IsElementPresent,\n                   \"css=grr-wizard-form:contains('Where to run?')\")\n\n    # Empty set of rules should be valid.\n    self.WaitUntil(self.IsElementPresent, \"css=button.Next:not([disabled])\")\n\n    # A note informs what an empty set of rules means.\n    self.WaitUntil(self.IsElementPresent,\n                   \"css=grr-wizard-form:contains('No rules specified!')\")\n\n    # Alternative match mode that matches a client if\n    # any of the rules evaluates to true can be selected.\n    self.Select(\n        \"css=grr-configure-rules-page \"\n        \"label:contains('Match mode') ~ * select\", \"Match any\")\n\n    # The note depends on the match mode.\n    self.WaitUntil(self.IsElementPresent,\n                   \"css=grr-wizard-form:contains('No rules specified!')\")\n\n    # Create 3 foreman rules. Note that \"Add\" button adds rules\n    # to the beginning of a list. So we always use :nth(0) selector.\n    self.Click(\"css=grr-configure-rules-page button[name=Add]\")\n    self.Select(\"css=grr-configure-rules-page div.well:nth(0) select\", \"Regex\")\n    rule = foreman_rules.ForemanRegexClientRule\n    label = rule.ForemanStringField.SYSTEM.description\n    self.Select(\n        \"css=grr-configure-rules-page div.well:nth(0) \"\n        \"label:contains('Field') ~ * select\", label)\n    self.Type(\n        \"css=grr-configure-rules-page div.well:nth(0) \"\n        \"label:contains('Attribute regex') ~ * input\", \"Linux\")\n\n    self.Click(\"css=grr-configure-rules-page button[name=Add]\")\n    self.Select(\"css=grr-configure-rules-page div.well:nth(0) select\",\n                \"Integer\")\n\n    rule = foreman_rules.ForemanIntegerClientRule\n    label = rule.ForemanIntegerField.CLIENT_CLOCK.description\n    self.Select(\n        \"css=grr-configure-rules-page div.well:nth(0) \"\n        \"label:contains('Field') ~ * select\", label)\n    self.Select(\n        \"css=grr-configure-rules-page div.well:nth(0) \"\n        \"label:contains('Operator') ~ * select\", \"GREATER_THAN\")\n    self.Type(\n        \"css=grr-configure-rules-page div.well:nth(0) \"\n        \"label:contains('Value') ~ * input\", \"1336650631137737\")\n\n    self.Click(\"css=grr-configure-rules-page button[name=Add]\")\n    self.Click(\"css=grr-configure-rules-page div.well:nth(0) \"\n               \"label:contains('Os darwin') ~ * input[type=checkbox]\")\n\n    # Click on \"Back\" button\n    self.Click(\"css=grr-new-hunt-wizard-form button.Back\")\n    self.WaitUntil(self.IsElementPresent,\n                   \"css=grr-wizard-form:contains('How to process results')\")\n\n    # Click on \"Next\" button again and check that all the values that\n    # we've just entered remain intact.\n    self.Click(\"css=grr-new-hunt-wizard-form button.Next\")\n    self.WaitUntil(self.IsElementPresent,\n                   \"css=grr-wizard-form:contains('Where to run?')\")\n\n    # Click on \"Next\" button\n    self.Click(\"css=grr-new-hunt-wizard-form button.Next\")\n    self.WaitUntil(self.IsElementPresent,\n                   \"css=grr-wizard-form:contains('Review')\")\n\n    # Check that the arguments summary is present.\n    self.WaitUntil(self.IsElementPresent,\n                   \"css=grr-wizard-form:contains('Paths')\")\n    self.WaitUntil(self.IsElementPresent,\n                   \"css=grr-wizard-form:contains('/tmp')\")\n\n    # Check that output plugins are shown.\n    self.assertTrue(\n        self.IsElementPresent(\n            \"css=grr-wizard-form:contains('DummyOutputPlugin')\"))\n    self.assertTrue(\n        self.IsElementPresent(\"css=grr-wizard-form:contains('some regex')\"))\n\n    # Check that there's no deprecated rules summary.\n    self.assertFalse(\n        self.IsElementPresent(\"css=grr-wizard-form:contains('Regex rules')\"))\n    self.assertFalse(\n        self.IsElementPresent(\"css=grr-wizard-form:contains('Integer rules')\"))\n\n    # Check that rules summary is present.\n    self.assertTrue(\n        self.IsElementPresent(\n            \"css=grr-wizard-form:contains('Client rule set')\"))\n\n    # Click on \"Run\" button\n    self.Click(\"css=grr-new-hunt-wizard-form button.Next\")\n\n    self.WaitUntil(self.IsElementPresent,\n                   \"css=grr-wizard-form:contains('Created Hunt')\")\n\n    # Close the window and check that the hunt was created.\n    self.Click(\"css=button.Next\")\n\n    # Select newly created hunt.\n    self.Click(\"css=grr-hunts-list td:contains('gui_user')\")\n\n    # Check that correct details are displayed in hunt details tab.\n    self.WaitUntil(self.IsElementPresent,\n                   \"css=grr-hunt-inspector:contains('GenericHunt')\")\n    self.WaitUntil(self.IsElementPresent,\n                   \"css=grr-hunt-inspector:contains('Flow Arguments')\")\n\n    self.assertTrue(\n        self.IsElementPresent(\"css=grr-hunt-inspector:contains('Paths')\"))\n    self.assertTrue(\n        self.IsElementPresent(\"css=grr-hunt-inspector:contains('/tmp')\"))\n\n    self.assertTrue(\n        self.IsElementPresent(\n            \"css=grr-hunt-inspector:contains('DummyOutputPlugin')\"))\n    self.assertTrue(\n        self.IsElementPresent(\"css=grr-hunt-inspector:contains('some regex')\"))\n\n    # Check that there's no deprecated rules summary.\n    self.assertFalse(\n        self.IsElementPresent(\"css=grr-hunt-inspector:contains('Regex rules')\"))\n    self.assertFalse(\n        self.IsElementPresent(\n            \"css=grr-hunt-inspector:contains('Integer rules')\"))\n\n    # Check that rules summary is present.\n    self.assertTrue(\n        self.IsElementPresent(\n            \"css=grr-hunt-inspector:contains('Client Rule Set')\"))\n\n    # Check that the hunt object was actually created\n    hunts_list = sorted(\n        data_store.REL_DB.ReadHuntObjects(offset=0, count=10),\n        key=lambda x: x.create_time)\n    self.assertLen(hunts_list, 1)\n\n    # Check that the hunt was created with a correct flow\n    hunt = hunts_list[0]\n\n    self.assertEqual(hunt.args.standard.flow_name,\n                     file_finder.FileFinder.__name__)\n    self.assertEqual(hunt.args.standard.flow_args.paths[0], \"/tmp\")\n    self.assertEqual(hunt.args.standard.flow_args.pathtype,\n                     rdf_paths.PathSpec.PathType.TSK)\n    # self.assertEqual(hunt.args.flow_args.ignore_errors, True)\n    self.assertEqual(hunt.output_plugins[0].plugin_name, \"DummyOutputPlugin\")\n\n    # Check that hunt was not started\n    self.assertEqual(hunt.hunt_state, hunt.HuntState.PAUSED)\n\n    lib_hunt.StartHunt(hunt.hunt_id)\n\n    hunt_rules = self.FindForemanRules(\n        rdfvalue.RDFURN(\"hunts\").Add(hunt.hunt_id), token=self.token)\n\n    # Check that the hunt was created with correct rules\n    self.assertLen(hunt_rules, 1)\n    lifetime = hunt_rules[0].GetLifetime()\n    lifetime -= rdfvalue.DurationSeconds(\"2w\")\n    self.assertLessEqual(lifetime, rdfvalue.DurationSeconds(\"1s\"))\n\n    r = hunt_rules[0].client_rule_set\n\n    self.assertEqual(r.match_mode,\n                     foreman_rules.ForemanClientRuleSet.MatchMode.MATCH_ANY)\n    self.assertLen(r.rules, 3)\n\n    self.assertEqual(r.rules[0].rule_type,\n                     foreman_rules.ForemanClientRule.Type.OS)\n    self.assertEqual(r.rules[0].os.os_windows, False)\n    self.assertEqual(r.rules[0].os.os_linux, False)\n    self.assertEqual(r.rules[0].os.os_darwin, True)\n\n    self.assertEqual(r.rules[1].rule_type,\n                     foreman_rules.ForemanClientRule.Type.INTEGER)\n    self.assertEqual(r.rules[1].integer.field, \"CLIENT_CLOCK\")\n    self.assertEqual(\n        r.rules[1].integer.operator,\n        foreman_rules.ForemanIntegerClientRule.Operator.GREATER_THAN)\n    self.assertEqual(r.rules[1].integer.value, 1336650631137737)\n\n    self.assertEqual(r.rules[2].rule_type,\n                     foreman_rules.ForemanClientRule.Type.REGEX)\n    self.assertEqual(r.rules[2].regex.field, \"SYSTEM\")\n    self.assertEqual(r.rules[2].regex.attribute_regex, \"Linux\")\n\n  def testWizardStepCounterIsShownCorrectly(self):\n    # Open up and click on View Hunts.\n    self.Open(\"/#/hunts\")\n\n    # Open up \"New Hunt\" wizard\n    self.Click(\"css=button[name=NewHunt]\")\n    self.WaitUntil(self.IsElementPresent,\n                   \"css=grr-wizard-form:contains('What to run?')\")\n\n    # Click on the FileFinder item in Filesystem flows list\n    self.WaitUntil(self.IsElementPresent, \"css=#_Filesystem > i.jstree-icon\")\n    self.Click(\"css=#_Filesystem > i.jstree-icon\")\n    self.Click(\"link=File Finder\")\n\n    self.WaitUntil(self.IsElementPresent,\n                   \"css=grr-wizard-form:contains('Step 1 out of 6')\")\n\n    # Click on \"Next\" button\n    self.Click(\"css=grr-new-hunt-wizard-form button.Next\")\n\n    self.WaitUntil(self.IsElementPresent,\n                   \"css=grr-wizard-form:contains('Step 2 out of 6')\")\n\n  def testLiteralExpressionIsProcessedCorrectly(self):\n    \"\"\"Literals are raw bytes. Testing that raw bytes are processed right.\"\"\"\n\n    # Open up and click on View Hunts.\n    self.Open(\"/\")\n    self.Click(\"css=a[grrtarget=hunts]\")\n\n    # Open up \"New Hunt\" wizard\n    self.Click(\"css=button[name=NewHunt]\")\n    self.WaitUntil(self.IsElementPresent,\n                   \"css=grr-wizard-form:contains('What to run?')\")\n\n    # Click on Filesystem item in flows list\n    self.WaitUntil(self.IsElementPresent, \"css=#_Filesystem > i.jstree-icon\")\n    self.Click(\"css=#_Filesystem > i.jstree-icon\")\n\n    # Click on the FileFinder item in Filesystem flows list\n    self.Click(\"link=File Finder\")\n\n    self.Click(\"css=label:contains('Conditions') ~ * button\")\n    self.Select(\"css=label:contains('Condition type') ~ * select\",\n                \"Contents literal match\")\n    self.Type(\"css=label:contains('Literal') ~ * input\", \"foo\\\\x0d\\\\xc8bar\")\n\n    # Click on \"Next\" button\n    self.Click(\"css=grr-new-hunt-wizard-form button.Next\")\n    self.WaitUntil(self.IsElementPresent,\n                   \"css=grr-wizard-form:contains('Hunt parameters')\")\n    # Click on \"Next\" button\n    self.Click(\"css=grr-new-hunt-wizard-form button.Next\")\n    self.WaitUntil(self.IsElementPresent,\n                   \"css=grr-wizard-form:contains('How to process results')\")\n    # Click on \"Next\" button\n    self.Click(\"css=grr-new-hunt-wizard-form button.Next\")\n    self.WaitUntil(self.IsElementPresent,\n                   \"css=grr-wizard-form:contains('Where to run?')\")\n    # Click on \"Next\" button\n    self.Click(\"css=grr-new-hunt-wizard-form button.Next\")\n    self.WaitUntil(self.IsElementPresent,\n                   \"css=grr-wizard-form:contains('Review')\")\n\n    # Check that the arguments summary is present.\n    self.WaitUntil(\n        self.IsElementPresent,\n        \"css=grr-wizard-form:contains('%s')\" % file_finder.FileFinder.__name__)\n    self.WaitUntil(self.IsTextPresent, b\"foo\\\\x0d\\\\xc8bar\")\n\n    # Click on \"Run\" button\n    self.Click(\"css=grr-new-hunt-wizard-form button.Next\")\n    self.WaitUntil(self.IsElementPresent,\n                   \"css=grr-wizard-form:contains('Created Hunt')\")\n    # Close the window and check that the hunt was created.\n    self.Click(\"css=button.Next\")\n\n    # Check that the hunt object was actually created\n    hunts_list = sorted(\n        data_store.REL_DB.ReadHuntObjects(offset=0, count=10),\n        key=lambda x: x.create_time)\n    self.assertLen(hunts_list, 1)\n\n    # Check that the hunt was created with a correct literal value.\n    hunt = hunts_list[0]\n    self.assertEqual(hunt.args.standard.flow_name,\n                     file_finder.FileFinder.__name__)\n    self.assertEqual(\n        hunt.args.standard.flow_args.conditions[0].contents_literal_match\n        .literal, b\"foo\\x0d\\xc8bar\")\n\n  def testOutputPluginsListEmptyWhenNoDefaultOutputPluginSet(self):\n    self.Open(\"/#main=ManageHunts\")\n    self.Click(\"css=button[name=NewHunt]\")\n\n    # Select \"List Processes\" flow.\n    self.Click(\"css=#_Processes > i.jstree-icon\")\n    self.Click(\"link=ListProcesses\")\n\n    # Click on \"Next\" button\n    self.Click(\"css=grr-new-hunt-wizard-form button.Next\")\n    self.WaitUntil(self.IsElementPresent,\n                   \"css=grr-wizard-form:contains('Hunt parameters')\")\n\n    # There should be no dummy output plugin visible.\n    self.Click(\"css=grr-new-hunt-wizard-form button.Next\")\n    self.WaitUntil(self.IsElementPresent,\n                   \"css=grr-wizard-form:contains('How to process results')\")\n    self.WaitUntilNot(self.IsElementPresent,\n                      \"css=grr-wizard-form:contains('Dummy do do')\")\n\n  def testDefaultOutputPluginIsCorrectlyAddedToThePluginsList(self):\n    with test_lib.ConfigOverrider(\n        {\"AdminUI.new_hunt_wizard.default_output_plugin\": \"DummyOutputPlugin\"}):\n      self.Open(\"/#main=ManageHunts\")\n      self.Click(\"css=button[name=NewHunt]\")\n\n      # Select \"List Processes\" flow.\n      self.Click(\"css=#_Processes > i.jstree-icon\")\n      self.Click(\"link=ListProcesses\")\n\n      # Click on \"Next\" button\n      self.Click(\"css=grr-new-hunt-wizard-form button.Next\")\n      self.WaitUntil(self.IsElementPresent,\n                     \"css=grr-wizard-form:contains('Hunt parameters')\")\n\n      # Dummy output plugin should be added by default.\n      self.Click(\"css=grr-new-hunt-wizard-form button.Next\")\n      self.WaitUntil(self.IsElementPresent,\n                     \"css=grr-wizard-form:contains('How to process results')\")\n      self.WaitUntil(self.IsElementPresent,\n                     \"css=grr-wizard-form:contains('DummyOutputPlugin')\")\n\n  def testLabelsHuntRuleDisplaysAvailableLabels(self):\n    client_id = self.SetupClient(0)\n\n    self.AddClientLabel(client_id, u\"owner1\", u\"foo\")\n    self.AddClientLabel(client_id, u\"owner2\", u\"bar\")\n\n    self.Open(\"/#main=ManageHunts\")\n    self.Click(\"css=button[name=NewHunt]\")\n\n    # Select \"List Processes\" flow.\n    self.Click(\"css=#_Processes > i.jstree-icon\")\n    self.Click(\"link=ListProcesses\")\n\n    # Click 'Next' to go to hunt parameters page.\n    self.Click(\"css=grr-new-hunt-wizard-form button.Next\")\n\n    # Click 'Next' to go to output plugins page.\n    self.Click(\"css=grr-new-hunt-wizard-form button.Next\")\n\n    # Click 'Next' to go to hunt rules page.\n    self.Click(\"css=grr-new-hunt-wizard-form button.Next\")\n\n    self.Click(\"css=grr-new-hunt-wizard-form button[name=Add]\")\n\n    # Select 'Clients With Label' rule.\n    self.Select(\"css=grr-new-hunt-wizard-form div.well select\", \"Label\")\n    # Check that there's an option present for labels 'bar' (this option\n    # should be selected) and for label 'foo'.\n    self.WaitUntil(\n        self.IsElementPresent, \"css=grr-new-hunt-wizard-form div.well \"\n        \".form-group:has(label:contains('Label')) \"\n        \"select option:selected[label=bar]\")\n    self.WaitUntil(\n        self.IsElementPresent, \"css=grr-new-hunt-wizard-form div.well \"\n        \".form-group:has(label:contains('Label')) \"\n        \"select option:not(:selected)[label=foo]\")\n\n  def testLabelsHuntRuleMatchesCorrectClients(self):\n    client_ids = self.SetupClients(10)\n\n    self.AddClientLabel(client_ids[1], u\"owner1\", u\"foo\")\n    self.AddClientLabel(client_ids[1], u\"owner2\", u\"bar\")\n    self.AddClientLabel(client_ids[7], u\"GRR\", u\"bar\")\n\n    self.Open(\"/#main=ManageHunts\")\n    self.Click(\"css=button[name=NewHunt]\")\n\n    # Select \"List Processes\" flow.\n    self.Click(\"css=#_Processes > i.jstree-icon\")\n    self.Click(\"link=ListProcesses\")\n\n    # Click 'Next' to go to the output plugins page, hunt parameters page\n    # and then to hunt rules page.\n    self.Click(\"css=grr-new-hunt-wizard-form button.Next\")\n    self.WaitUntil(self.IsElementPresent,\n                   \"css=grr-wizard-form:contains('Hunt parameters')\")\n    self.Click(\"css=grr-new-hunt-wizard-form button.Next\")\n    self.WaitUntil(self.IsElementPresent,\n                   \"css=grr-wizard-form:contains('How to process results')\")\n    self.Click(\"css=grr-new-hunt-wizard-form button.Next\")\n    self.WaitUntil(self.IsElementPresent,\n                   \"css=grr-wizard-form:contains('Where to run?')\")\n\n    # Select 'Clients With Label' rule.\n    self.Click(\"css=grr-configure-rules-page button[name=Add]\")\n    self.Select(\"css=grr-new-hunt-wizard-form div.well select\", \"Label\")\n    self.Select(\n        \"css=grr-new-hunt-wizard-form div.well .form-group \"\n        \".form-group:has(label:contains('Label')):nth-last-of-type(1) \"\n        \"select\", \"foo\")\n    self.Click(\"css=grr-new-hunt-wizard-form div.well .form-group \"\n               \".form-group:has(label:contains('Add label')) button\")\n    self.Select(\n        \"css=grr-new-hunt-wizard-form div.well .form-group \"\n        \".form-group:has(label:contains('Label')):nth-last-of-type(1) \"\n        \"select\", \"bar\")\n    self.Select(\n        \"css=grr-new-hunt-wizard-form div.well .form-group \"\n        \".form-group:has(label:contains('Match mode')) select\", \"Match any\")\n\n    # Click 'Next' to go to hunt overview page.  Then click 'Next' to go to\n    # submit the hunt and wait until it's created.\n    self.Click(\"css=grr-new-hunt-wizard-form button.Next\")\n    self.Click(\"css=grr-new-hunt-wizard-form button.Next\")\n    self.WaitUntil(self.IsElementPresent,\n                   \"css=grr-wizard-form:contains('Created Hunt')\")\n\n    hunts_list = sorted(\n        data_store.REL_DB.ReadHuntObjects(offset=0, count=10),\n        key=lambda x: x.create_time)\n    hunt = hunts_list[0]\n    lib_hunt.StartHunt(hunt.hunt_id)\n\n    foreman_obj = foreman.Foreman()\n    for client_id in client_ids:\n      tasks_assigned = foreman_obj.AssignTasksToClient(client_id)\n      if client_id in [client_ids[1], client_ids[7]]:\n        self.assertTrue(tasks_assigned)\n      else:\n        self.assertFalse(tasks_assigned)\n\n  def CreateSampleHunt(self, description, token=None):\n    self.StartHunt(\n        description=description,\n        flow_runner_args=rdf_flow_runner.FlowRunnerArgs(\n            flow_name=transfer.GetFile.__name__),\n        flow_args=transfer.GetFileArgs(\n            pathspec=rdf_paths.PathSpec(\n                path=\"/tmp/evil.txt\",\n                pathtype=rdf_paths.PathSpec.PathType.TSK,\n            )),\n        client_rule_set=self._CreateForemanClientRuleSet(),\n        output_plugins=[\n            rdf_output_plugin.OutputPluginDescriptor(\n                plugin_name=\"DummyOutputPlugin\",\n                plugin_args=gui_test_lib.DummyOutputPlugin.args_type(\n                    filename_regex=\"blah!\", fetch_binaries=True))\n        ],\n        client_rate=60,\n        paused=True,\n        token=token)\n\n  def testPathAutocomplete(self):\n    # Open Hunts\n    self.Open(\"/#/hunts\")\n\n    # Open \"New Hunt\" wizard\n    self.Click(\"css=button[name=NewHunt]\")\n    self.WaitUntil(self.IsElementPresent,\n                   \"css=grr-wizard-form:contains('What to run?')\")\n\n    # Click on Filesystem item in flows list\n    self.Click(\"css=#_Filesystem > i.jstree-icon\")\n\n    # Click on the FileFinder item in Filesystem flows list\n    self.Click(\"link=File Finder\")\n\n    input_selector = \"css=grr-form-glob-expression input[uib-typeahead]\"\n\n    # Change \"path\"\n    self.Type(input_selector, \"/foo/%%path\")\n\n    self.WaitUntil(self.IsElementPresent,\n                   \"css=[uib-typeahead-popup]:contains('%%environ_path%%')\")\n\n    self.GetElement(input_selector).send_keys(keys.Keys.ENTER)\n\n    self.WaitUntilEqual(\"/foo/%%environ_path%%\", self.GetValue,\n                        input_selector + \":text\")\n\n\nif __name__ == \"__main__\":\n  app.run(test_lib.main)\n```",
    "after": "#!/usr/bin/env python\n\"\"\"Test of \"New Hunt\" wizard.\"\"\"\nfrom __future__ import absolute_import\nfrom __future__ import division\nfrom __future__ import unicode_literals\n\nfrom absl import app\nfrom selenium.webdriver.common import keys\n\nfrom grr_response_core.lib import rdfvalue\nfrom grr_response_core.lib.rdfvalues import paths as rdf_paths\nfrom grr_response_server import data_store\nfrom grr_response_server import foreman\nfrom grr_response_server import foreman_rules\nfrom grr_response_server import hunt as lib_hunt\nfrom grr_response_server.flows.general import file_finder\nfrom grr_response_server.flows.general import transfer\nfrom grr_response_server.gui import gui_test_lib\nfrom grr_response_server.rdfvalues import flow_runner as rdf_flow_runner\nfrom grr_response_server.rdfvalues import output_plugin as rdf_output_plugin\nfrom grr.test_lib import test_lib\n\n\nclass TestNewHuntWizard(gui_test_lib.GRRSeleniumHuntTest):\n  \"\"\"Test the \"new hunt wizard\" GUI.\"\"\"\n\n  @staticmethod\n  def FindForemanRules(hunt_urn, token):\n    rules = data_store.REL_DB.ReadAllForemanRules()\n    return [rule for rule in rules if rule.hunt_id == hunt_urn.Basename()]\n\n  def testNewHuntWizard(self):\n    # Open up and click on View Hunts.\n    self.Open(\"/\")\n    self.WaitUntil(self.IsElementPresent, \"client_query\")\n    self.WaitUntil(self.IsElementPresent, \"css=a[grrtarget=hunts]\")\n    self.Click(\"css=a[grrtarget=hunts]\")\n    self.WaitUntil(self.IsElementPresent, \"css=button[name=NewHunt]\")\n\n    # Open up \"New Hunt\" wizard\n    self.Click(\"css=button[name=NewHunt]\")\n    self.WaitUntil(self.IsElementPresent,\n                   \"css=grr-wizard-form:contains('What to run?')\")\n\n    # Click on Filesystem item in flows list\n    self.WaitUntil(self.IsElementPresent, \"css=#_Filesystem > i.jstree-icon\")\n    self.Click(\"css=#_Filesystem > i.jstree-icon\")\n\n    # Click on the FileFinder item in Filesystem flows list\n    self.Click(\"link=File Finder\")\n\n    # Wait for flow configuration form to be rendered (just wait for first\n    # input field).\n    self.WaitUntil(self.IsElementPresent,\n                   \"css=grr-new-hunt-wizard-form label:contains('Paths')\")\n\n    # Change \"path\" and \"pathtype\" values\n    self.Type(\n        \"css=grr-new-hunt-wizard-form \"\n        \"grr-form-proto-repeated-field:has(label:contains('Paths')) \"\n        \"input\", \"/tmp\")\n    self.Select(\n        \"css=grr-new-hunt-wizard-form \"\n        \"grr-form-proto-single-field:has(label:contains('Pathtype')) \"\n        \"select\", \"TSK\")\n\n    # Click on \"Next\" button\n    self.Click(\"css=grr-new-hunt-wizard-form button.Next\")\n    self.WaitUntil(self.IsElementPresent,\n                   \"css=grr-wizard-form:contains('Hunt parameters')\")\n\n    # Click on \"Next\" button\n    self.Click(\"css=grr-new-hunt-wizard-form button.Next\")\n    self.WaitUntil(self.IsElementPresent,\n                   \"css=grr-wizard-form:contains('How to process results')\")\n\n    # Click on \"Back\" button and check that all the values in the form\n    # remain intact.\n    self.Click(\"css=grr-new-hunt-wizard-form button.Back\")\n    self.WaitUntil(self.IsElementPresent,\n                   \"css=grr-wizard-form:contains('Hunt parameters')\")\n\n    self.Click(\"css=grr-new-hunt-wizard-form button.Back\")\n    self.WaitUntil(self.IsElementPresent,\n                   \"css=grr-new-hunt-wizard-form label:contains('Paths')\")\n\n    self.assertEqual(\n        \"/tmp\",\n        self.GetValue(\n            \"css=grr-new-hunt-wizard-form \"\n            \"grr-form-proto-repeated-field:has(label:contains('Paths')) input\"))\n\n    self.assertEqual(\n        \"TSK\",\n        self.GetSelectedLabel(\n            \"css=grr-new-hunt-wizard-form \"\n            \"grr-form-proto-single-field:has(label:contains('Pathtype')) select\"\n        ))\n\n    # Click on \"Next\" button\n    self.Click(\"css=grr-new-hunt-wizard-form button.Next\")\n    self.WaitUntil(self.IsElementPresent,\n                   \"css=grr-wizard-form:contains('Hunt parameters')\")\n\n    # Click on \"Next\" button\n    self.Click(\"css=grr-new-hunt-wizard-form button.Next\")\n    self.WaitUntil(self.IsElementPresent,\n                   \"css=grr-wizard-form:contains('How to process results')\")\n\n    # Configure the hunt to use dummy output plugin.\n    self.Click(\"css=grr-new-hunt-wizard-form button[name=Add]\")\n    self.Select(\"css=grr-new-hunt-wizard-form select\", \"DummyOutputPlugin\")\n    self.Type(\n        \"css=grr-new-hunt-wizard-form \"\n        \"grr-form-proto-single-field:has(label:contains('Filepath Regex')) \"\n        \"input\", \"some regex\")\n\n    # Click on \"Next\" button\n    self.Click(\"css=grr-new-hunt-wizard-form button.Next\")\n    self.WaitUntil(self.IsElementPresent,\n                   \"css=grr-wizard-form:contains('Where to run?')\")\n\n    # Empty set of rules should be valid.\n    self.WaitUntil(self.IsElementPresent, \"css=button.Next:not([disabled])\")\n\n    # A note informs what an empty set of rules means.\n    self.WaitUntil(self.IsElementPresent,\n                   \"css=grr-wizard-form:contains('No rules specified!')\")\n\n    # Alternative match mode that matches a client if\n    # any of the rules evaluates to true can be selected.\n    self.Select(\n        \"css=grr-configure-rules-page \"\n        \"label:contains('Match mode') ~ * select\", \"Match any\")\n\n    # The note depends on the match mode.\n    self.WaitUntil(self.IsElementPresent,\n                   \"css=grr-wizard-form:contains('No rules specified!')\")\n\n    # Create 3 foreman rules. Note that \"Add\" button adds rules\n    # to the beginning of a list. So we always use :nth(0) selector.\n    self.Click(\"css=grr-configure-rules-page button[name=Add]\")\n    self.Select(\"css=grr-configure-rules-page div.well:nth(0) select\", \"Regex\")\n    rule = foreman_rules.ForemanRegexClientRule\n    label = rule.ForemanStringField.SYSTEM.description\n    self.Select(\n        \"css=grr-configure-rules-page div.well:nth(0) \"\n        \"label:contains('Field') ~ * select\", label)\n    self.Type(\n        \"css=grr-configure-rules-page div.well:nth(0) \"\n        \"label:contains('Attribute regex') ~ * input\", \"Linux\")\n\n    self.Click(\"css=grr-configure-rules-page button[name=Add]\")\n    self.Select(\"css=grr-configure-rules-page div.well:nth(0) select\",\n                \"Integer\")\n\n    rule = foreman_rules.ForemanIntegerClientRule\n    label = rule.ForemanIntegerField.CLIENT_CLOCK.description\n    self.Select(\n        \"css=grr-configure-rules-page div.well:nth(0) \"\n        \"label:contains('Field') ~ * select\", label)\n    self.Select(\n        \"css=grr-configure-rules-page div.well:nth(0) \"\n        \"label:contains('Operator') ~ * select\", \"GREATER_THAN\")\n    self.Type(\n        \"css=grr-configure-rules-page div.well:nth(0) \"\n        \"label:contains('Value') ~ * input\", \"1336650631137737\")\n\n    self.Click(\"css=grr-configure-rules-page button[name=Add]\")\n    self.Click(\"css=grr-configure-rules-page div.well:nth(0) \"\n               \"label:contains('Os darwin') ~ * input[type=checkbox]\")\n\n    # Click on \"Back\" button\n    self.Click(\"css=grr-new-hunt-wizard-form button.Back\")\n    self.WaitUntil(self.IsElementPresent,\n                   \"css=grr-wizard-form:contains('How to process results')\")\n\n    # Click on \"Next\" button again and check that all the values that\n    # we've just entered remain intact.\n    self.Click(\"css=grr-new-hunt-wizard-form button.Next\")\n    self.WaitUntil(self.IsElementPresent,\n                   \"css=grr-wizard-form:contains('Where to run?')\")\n\n    # Click on \"Next\" button\n    self.Click(\"css=grr-new-hunt-wizard-form button.Next\")\n    self.WaitUntil(self.IsElementPresent,\n                   \"css=grr-wizard-form:contains('Review')\")\n\n    # Check that the arguments summary is present.\n    self.WaitUntil(self.IsElementPresent,\n                   \"css=grr-wizard-form:contains('Paths')\")\n    self.WaitUntil(self.IsElementPresent,\n                   \"css=grr-wizard-form:contains('/tmp')\")\n\n    # Check that output plugins are shown.\n    self.assertTrue(\n        self.IsElementPresent(\n            \"css=grr-wizard-form:contains('DummyOutputPlugin')\"))\n    self.assertTrue(\n        self.IsElementPresent(\"css=grr-wizard-form:contains('some regex')\"))\n\n    # Check that there's no deprecated rules summary.\n    self.assertFalse(\n        self.IsElementPresent(\"css=grr-wizard-form:contains('Regex rules')\"))\n    self.assertFalse(\n        self.IsElementPresent(\"css=grr-wizard-form:contains('Integer rules')\"))\n\n    # Check that rules summary is present.\n    self.assertTrue(\n        self.IsElementPresent(\n            \"css=grr-wizard-form:contains('Client rule set')\"))\n\n    # Click on \"Run\" button\n    self.Click(\"css=grr-new-hunt-wizard-form button.Next\")\n\n    self.WaitUntil(self.IsElementPresent,\n                   \"css=grr-wizard-form:contains('Created Hunt')\")\n\n    # Close the window and check that the hunt was created.\n    self.Click(\"css=button.Next\")\n\n    # Select newly created hunt.\n    self.Click(\"css=grr-hunts-list td:contains('gui_user')\")\n\n    # Check that correct details are displayed in hunt details tab.\n    self.WaitUntil(self.IsElementPresent,\n                   \"css=grr-hunt-inspector:contains('GenericHunt')\")\n    self.WaitUntil(self.IsElementPresent,\n                   \"css=grr-hunt-inspector:contains('Flow Arguments')\")\n\n    self.assertTrue(\n        self.IsElementPresent(\"css=grr-hunt-inspector:contains('Paths')\"))\n    self.assertTrue(\n        self.IsElementPresent(\"css=grr-hunt-inspector:contains('/tmp')\"))\n\n    self.assertTrue(\n        self.IsElementPresent(\n            \"css=grr-hunt-inspector:contains('DummyOutputPlugin')\"))\n    self.assertTrue(\n        self.IsElementPresent(\"css=grr-hunt-inspector:contains('some regex')\"))\n\n    # Check that there's no deprecated rules summary.\n    self.assertFalse(\n        self.IsElementPresent(\"css=grr-hunt-inspector:contains('Regex rules')\"))\n    self.assertFalse(\n        self.IsElementPresent(\n            \"css=grr-hunt-inspector:contains('Integer rules')\"))\n\n    # Check that rules summary is present.\n    self.assertTrue(\n        self.IsElementPresent(\n            \"css=grr-hunt-inspector:contains('Client Rule Set')\"))\n\n    # Check that the hunt object was actually created\n    hunts_list = sorted(\n        data_store.REL_DB.ReadHuntObjects(offset=0, count=10),\n        key=lambda x: x.create_time)\n    self.assertLen(hunts_list, 1)\n\n    # Check that the hunt was created with a correct flow\n    hunt = hunts_list[0]\n\n    self.assertEqual(hunt.args.standard.flow_name,\n                     file_finder.FileFinder.__name__)\n    self.assertEqual(hunt.args.standard.flow_args.paths[0], \"/tmp\")\n    self.assertEqual(hunt.args.standard.flow_args.pathtype,\n                     rdf_paths.PathSpec.PathType.TSK)\n    # self.assertEqual(hunt.args.flow_args.ignore_errors, True)\n    self.assertEqual(hunt.output_plugins[0].plugin_name, \"DummyOutputPlugin\")\n\n    # Check that hunt was not started\n    self.assertEqual(hunt.hunt_state, hunt.HuntState.PAUSED)\n\n    lib_hunt.StartHunt(hunt.hunt_id)\n\n    hunt_rules = self.FindForemanRules(\n        rdfvalue.RDFURN(\"hunts\").Add(hunt.hunt_id), token=self.token)\n\n    # Check that the hunt was created with correct rules\n    self.assertLen(hunt_rules, 1)\n    lifetime = hunt_rules[0].GetLifetime()\n    lifetime -= rdfvalue.DurationSeconds(\"2w\")\n    self.assertLessEqual(lifetime, rdfvalue.DurationSeconds(\"1s\"))\n\n    r = hunt_rules[0].client_rule_set\n\n    self.assertEqual(r.match_mode,\n                     foreman_rules.ForemanClientRuleSet.MatchMode.MATCH_ANY)\n    self.assertLen(r.rules, 3)\n\n    self.assertEqual(r.rules[0].rule_type,\n                     foreman_rules.ForemanClientRule.Type.OS)\n    self.assertEqual(r.rules[0].os.os_windows, False)\n    self.assertEqual(r.rules[0].os.os_linux, False)\n    self.assertEqual(r.rules[0].os.os_darwin, True)\n\n    self.assertEqual(r.rules[1].rule_type,\n                     foreman_rules.ForemanClientRule.Type.INTEGER)\n    self.assertEqual(r.rules[1].integer.field, \"CLIENT_CLOCK\")\n    self.assertEqual(\n        r.rules[1].integer.operator,\n        foreman_rules.ForemanIntegerClientRule.Operator.GREATER_THAN)\n    self.assertEqual(r.rules[1].integer.value, 1336650631137737)\n\n    self.assertEqual(r.rules[2].rule_type,\n                     foreman_rules.ForemanClientRule.Type.REGEX)\n    self.assertEqual(r.rules[2].regex.field, \"SYSTEM\")\n    self.assertEqual(r.rules[2].regex.attribute_regex, \"Linux\")\n\n  def testWizardStepCounterIsShownCorrectly(self):\n    # Open up and click on View Hunts.\n    self.Open(\"/#/hunts\")\n\n    # Open up \"New Hunt\" wizard\n    self.Click(\"css=button[name=NewHunt]\")\n    self.WaitUntil(self.IsElementPresent,\n                   \"css=grr-wizard-form:contains('What to run?')\")\n\n    # Click on the FileFinder item in Filesystem flows list\n    self.WaitUntil(self.IsElementPresent, \"css=#_Filesystem > i.jstree-icon\")\n    self.Click(\"css=#_Filesystem > i.jstree-icon\")\n    self.Click(\"link=File Finder\")\n\n    self.WaitUntil(self.IsElementPresent,\n                   \"css=grr-wizard-form:contains('Step 1 out of 6')\")\n\n    # Click on \"Next\" button\n    self.Click(\"css=grr-new-hunt-wizard-form button.Next\")\n\n    self.WaitUntil(self.IsElementPresent,\n                   \"css=grr-wizard-form:contains('Step 2 out of 6')\")\n\n  def testLiteralExpressionIsProcessedCorrectly(self):\n    \"\"\"Literals are raw bytes. Testing that raw bytes are processed right.\"\"\"\n\n    # Open up and click on View Hunts.\n    self.Open(\"/\")\n    self.Click(\"css=a[grrtarget=hunts]\")\n\n    # Open up \"New Hunt\" wizard\n    self.Click(\"css=button[name=NewHunt]\")\n    self.WaitUntil(self.IsElementPresent,\n                   \"css=grr-wizard-form:contains('What to run?')\")\n\n    # Click on Filesystem item in flows list\n    self.WaitUntil(self.IsElementPresent, \"css=#_Filesystem > i.jstree-icon\")\n    self.Click(\"css=#_Filesystem > i.jstree-icon\")\n\n    # Click on the FileFinder item in Filesystem flows list\n    self.Click(\"link=File Finder\")\n\n    self.Click(\"css=label:contains('Conditions') ~ * button\")\n    self.Select(\"css=label:contains('Condition type') ~ * select\",\n                \"Contents literal match\")\n    self.Type(\"css=label:contains('Literal') ~ * input\", \"foo\\\\x0d\\\\xc8bar\")\n\n    # Click on \"Next\" button\n    self.Click(\"css=grr-new-hunt-wizard-form button.Next\")\n    self.WaitUntil(self.IsElementPresent,\n                   \"css=grr-wizard-form:contains('Hunt parameters')\")\n    # Click on \"Next\" button\n    self.Click(\"css=grr-new-hunt-wizard-form button.Next\")\n    self.WaitUntil(self.IsElementPresent,\n                   \"css=grr-wizard-form:contains('How to process results')\")\n    # Click on \"Next\" button\n    self.Click(\"css=grr-new-hunt-wizard-form button.Next\")\n    self.WaitUntil(self.IsElementPresent,\n                   \"css=grr-wizard-form:contains('Where to run?')\")\n    # Click on \"Next\" button\n    self.Click(\"css=grr-new-hunt-wizard-form button.Next\")\n    self.WaitUntil(self.IsElementPresent,\n                   \"css=grr-wizard-form:contains('Review')\")\n\n    # Check that the arguments summary is present.\n    self.WaitUntil(\n        self.IsElementPresent,\n        \"css=grr-wizard-form:contains('%s')\" % file_finder.FileFinder.__name__)\n    self.WaitUntil(self.IsTextPresent, b\"foo\\\\x0d\\\\xc8bar\")\n\n    # Click on \"Run\" button\n    self.Click(\"css=grr-new-hunt-wizard-form button.Next\")\n    self.WaitUntil(self.IsElementPresent,\n                   \"css=grr-wizard-form:contains('Created Hunt')\")\n    # Close the window and check that the hunt was created.\n    self.Click(\"css=button.Next\")\n\n    # Check that the hunt object was actually created\n    hunts_list = sorted(\n        data_store.REL_DB.ReadHuntObjects(offset=0, count=10),\n        key=lambda x: x.create_time)\n    self.assertLen(hunts_list, 1)\n\n    # Check that the hunt was created with a correct literal value.\n    hunt = hunts_list[0]\n    self.assertEqual(hunt.args.standard.flow_name,\n                     file_finder.FileFinder.__name__)\n    self.assertEqual(\n        hunt.args.standard.flow_args.conditions[0].contents_literal_match\n        .literal, b\"foo\\x0d\\xc8bar\")\n\n  def testOutputPluginsListEmptyWhenNoDefaultOutputPluginSet(self):\n    self.Open(\"/#main=ManageHunts\")\n    self.Click(\"css=button[name=NewHunt]\")\n\n    # Select \"List Processes\" flow.\n    self.Click(\"css=#_Processes > i.jstree-icon\")\n    self.Click(\"link=ListProcesses\")\n\n    # Click on \"Next\" button\n    self.Click(\"css=grr-new-hunt-wizard-form button.Next\")\n    self.WaitUntil(self.IsElementPresent,\n                   \"css=grr-wizard-form:contains('Hunt parameters')\")\n\n    # There should be no dummy output plugin visible.\n    self.Click(\"css=grr-new-hunt-wizard-form button.Next\")\n    self.WaitUntil(self.IsElementPresent,\n                   \"css=grr-wizard-form:contains('How to process results')\")\n    self.WaitUntilNot(self.IsElementPresent,\n                      \"css=grr-wizard-form:contains('Dummy do do')\")\n\n  def testDefaultOutputPluginIsCorrectlyAddedToThePluginsList(self):\n    with test_lib.ConfigOverrider(\n        {\"AdminUI.new_hunt_wizard.default_output_plugin\": \"DummyOutputPlugin\"}):\n      self.Open(\"/#main=ManageHunts\")\n      self.Click(\"css=button[name=NewHunt]\")\n\n      # Select \"List Processes\" flow.\n      self.Click(\"css=#_Processes > i.jstree-icon\")\n      self.Click(\"link=ListProcesses\")\n\n      # Click on \"Next\" button\n      self.Click(\"css=grr-new-hunt-wizard-form button.Next\")\n      self.WaitUntil(self.IsElementPresent,\n                     \"css=grr-wizard-form:contains('Hunt parameters')\")\n\n      # Dummy output plugin should be added by default.\n      self.Click(\"css=grr-new-hunt-wizard-form button.Next\")\n      self.WaitUntil(self.IsElementPresent,\n                     \"css=grr-wizard-form:contains('How to process results')\")\n      self.WaitUntil(self.IsElementPresent,\n                     \"css=grr-wizard-form:contains('DummyOutputPlugin')\")\n\n  def testLabelsHuntRuleDisplaysAvailableLabels(self):\n    client_id = self.SetupClient(0)\n\n    self.AddClientLabel(client_id, u\"owner1\", u\"foo\")\n    self.AddClientLabel(client_id, u\"owner2\", u\"bar\")\n\n    self.Open(\"/#main=ManageHunts\")\n    self.Click(\"css=button[name=NewHunt]\")\n\n    # Select \"List Processes\" flow.\n    self.Click(\"css=#_Processes > i.jstree-icon\")\n    self.Click(\"link=ListProcesses\")\n\n    # Click 'Next' to go to hunt parameters page.\n    self.Click(\"css=grr-new-hunt-wizard-form button.Next\")\n\n    # Click 'Next' to go to output plugins page.\n    self.Click(\"css=grr-new-hunt-wizard-form button.Next\")\n\n    # Click 'Next' to go to hunt rules page.\n    self.Click(\"css=grr-new-hunt-wizard-form button.Next\")\n\n    self.Click(\"css=grr-new-hunt-wizard-form button[name=Add]\")\n\n    # Select 'Clients With Label' rule.\n    self.Select(\"css=grr-new-hunt-wizard-form div.well select\", \"Label\")\n    # Check that there's an option present for labels 'bar' (this option\n    # should be selected) and for label 'foo'.\n    self.WaitUntil(\n        self.IsElementPresent, \"css=grr-new-hunt-wizard-form div.well \"\n        \".form-group:has(label:contains('Label')) \"\n        \"select option:selected[label=bar]\")\n    self.WaitUntil(\n        self.IsElementPresent, \"css=grr-new-hunt-wizard-form div.well \"\n        \".form-group:has(label:contains('Label')) \"\n        \"select option:not(:selected)[label=foo]\")\n\n  def testLabelsHuntRuleMatchesCorrectClients(self):\n    client_ids = self.SetupClients(10)\n\n    self.AddClientLabel(client_ids[1], u\"owner1\", u\"foo\")\n    self.AddClientLabel(client_ids[1], u\"owner2\", u\"bar\")\n    self.AddClientLabel(client_ids[7], u\"GRR\", u\"bar\")\n\n    self.Open(\"/#main=ManageHunts\")\n    self.Click(\"css=button[name=NewHunt]\")\n\n    # Select \"List Processes\" flow.\n    self.Click(\"css=#_Processes > i.jstree-icon\")\n    self.Click(\"link=ListProcesses\")\n\n    # Click 'Next' to go to the output plugins page, hunt parameters page\n    # and then to hunt rules page.\n    self.Click(\"css=grr-new-hunt-wizard-form button.Next\")\n    self.WaitUntil(self.IsElementPresent,\n                   \"css=grr-wizard-form:contains('Hunt parameters')\")\n    self.Click(\"css=grr-new-hunt-wizard-form button.Next\")\n    self.WaitUntil(self.IsElementPresent,\n                   \"css=grr-wizard-form:contains('How to process results')\")\n    self.Click(\"css=grr-new-hunt-wizard-form button.Next\")\n    self.WaitUntil(self.IsElementPresent,\n                   \"css=grr-wizard-form:contains('Where to run?')\")\n\n    # Select 'Clients With Label' rule.\n    self.Click(\"css=grr-configure-rules-page button[name=Add]\")\n    self.Select(\"css=grr-new-hunt-wizard-form div.well select\", \"Label\")\n    self.Select(\n        \"css=grr-new-hunt-wizard-form div.well .form-group \"\n        \".form-group:has(label:contains('Label')):nth-last-of-type(1) \"\n        \"select\", \"foo\")\n    self.Click(\"css=grr-new-hunt-wizard-form div.well .form-group \"\n               \".form-group:has(label:contains('Add label')) button\")\n    self.Select(\n        \"css=grr-new-hunt-wizard-form div.well .form-group \"\n        \".form-group:has(label:contains('Label')):nth-last-of-type(1) \"\n        \"select\", \"bar\")\n    self.Select(\n        \"css=grr-new-hunt-wizard-form div.well .form-group \"\n        \".form-group:has(label:contains('Match mode')) select\", \"Match any\")\n\n    # Click 'Next' to go to hunt overview page.  Then click 'Next' to go to\n    # submit the hunt and wait until it's created.\n    self.Click(\"css=grr-new-hunt-wizard-form button.Next\")\n    self.Click(\"css=grr-new-hunt-wizard-form button.Next\")\n    self.WaitUntil(self.IsElementPresent,\n                   \"css=grr-wizard-form:contains('Created Hunt')\")\n\n    hunts_list = sorted(\n        data_store.REL_DB.ReadHuntObjects(offset=0, count=10),\n        key=lambda x: x.create_time)\n    hunt = hunts_list[0]\n    lib_hunt.StartHunt(hunt.hunt_id)\n\n    foreman_obj = foreman.Foreman()\n    for client_id in client_ids:\n      tasks_assigned = foreman_obj.AssignTasksToClient(client_id)\n      if client_id in [client_ids[1], client_ids[7]]:\n        self.assertTrue(tasks_assigned)\n      else:\n        self.assertFalse(tasks_assigned)\n\n  def CreateSampleHunt(self, description, token=None):\n    self.StartHunt(\n        description=description,\n        flow_runner_args=rdf_flow_runner.FlowRunnerArgs(\n            flow_name=transfer.GetFile.__name__),\n        flow_args=transfer.GetFileArgs(\n            pathspec=rdf_paths.PathSpec(\n                path=\"/tmp/evil.txt\",\n                pathtype=rdf_paths.PathSpec.PathType.TSK,\n            )),\n        client_rule_set=self._CreateForemanClientRuleSet(),\n        output_plugins=[\n            rdf_output_plugin.OutputPluginDescriptor(\n                plugin_name=\"DummyOutputPlugin\",\n                plugin_args=gui_test_lib.DummyOutputPlugin.args_type(\n                    filename_regex=\"blah!\", fetch_binaries=True))\n        ],\n        client_rate=60,\n        paused=True,\n        token=token)\n\n  def testPathAutocomplete(self):\n    # Open Hunts\n    self.Open(\"/#/hunts\")\n\n    # Open \"New Hunt\" wizard\n    self.Click(\"css=button[name=NewHunt]\")\n    self.WaitUntil(self.IsElementPresent,\n                   \"css=grr-wizard-form:contains('What to run?')\")\n\n    # Click on Filesystem item in flows list\n    self.Click(\"css=#_Filesystem > i.jstree-icon\")\n\n    # Click on the FileFinder item in Filesystem flows list\n    self.Click(\"link=File Finder\")\n\n    input_selector = \"css=grr-form-glob-expression input[uib-typeahead]\"\n\n    # Change \"path\"\n    self.Type(input_selector, \"/foo/%%path\")\n\n    self.WaitUntil(self.IsElementPresent,\n                   \"css=[uib-typeahead-popup]:contains('%%environ_path%%')\")\n\n    self.GetElement(input_selector).send_keys(keys.Keys.ENTER)\n\n    self.WaitUntilEqual(\"/foo/%%environ_path%%\", self.GetValue,\n                        input_selector + \":text\")\n\n\nif __name__ == \"__main__\":\n  app.run(test_lib.main)\n```"
  },
  "feature_stats": {
    "indices": [
      2,
      0,
      1541,
      859,
      7564,
      5662,
      3370,
      6732,
      6493,
      5445,
      3226
    ],
    "f_before": [
      0.0,
      44.7712516784668,
      0.0,
      0.0,
      0.0,
      0.0,
      0.0,
      0.0,
      0.0,
      0.0,
      0.0
    ],
    "f_after": [
      0.0,
      44.7712516784668,
      0.0,
      0.0,
      0.0,
      0.0,
      0.0,
      0.0,
      0.0,
      0.0,
      0.0
    ],
    "g_before": [
      25.80521011352539,
      0.0,
      0.0017774553271010518,
      4.814266681671143,
      5.003913879394531,
      0.036593277007341385,
      0.053638458251953125,
      4.326842308044434,
      0.0,
      0.049582913517951965,
      0.0
    ],
    "g_after": [
      25.80521011352539,
      0.0,
      0.0017774553271010518,
      4.814266681671143,
      5.003913879394531,
      0.036593277007341385,
      0.053638458251953125,
      4.326842308044434,
      0.0,
      0.049582913517951965,
      0.0
    ],
    "num_batches_for_stats": 10
  },
  "loss_summary": {
    "train_mean_loss": 10.01762550815125,
    "train_mean_l2": 7.948200629286468,
    "train_mean_l1": 2.7709025331735613,
    "num_steps": 2000,
    "num_batches": 2000
  },
  "feature_std_summary": {
    "plot_path": "outputs/plots/20251128-142149/feature_std_layer_12.html",
    "mean_std": 1.2138572931289673,
    "max_std": 39.272926330566406
  }
}